window.netflix=window.netflix||{},netflix.mdx=netflix.mdx||{},function(){netflix.mdx.Eventable=function(){this.events={}},netflix.mdx.Eventable.prototype={addEventListener:function(e,t,i){var n={handler:t,scope:i};this.events.hasOwnProperty(e)?this.events[e].push(n):this.events[e]=[n]},removeEventListener:function(e,t,i){if(this.events.hasOwnProperty(e))for(var n=0;n<this.events[e].length;n++){var r=this.events[e][n];if(r.handler==t&&r.scope==i)return void this.events[e].splice(n,1)}},fireEvent:function(e,t){if(this.events.hasOwnProperty(e)){t&&t.length||(t=[]);for(var i=this.events[e].slice(),n=i.length,r=0;n>r;r++)i[r].handler&&i[r].handler.apply(i[r].scope,t)}}}}(),mdx=function(){var e=["ETHERNET","WIFI"],t=9080,i=-1,n=!1,r="",s=new Date,a=["statechanged","advertisingstatechanged","discoverystatechanged","error"],o=function(e,t,i,n){mdx.error("mdx._sendMessagingErrorEvent",e,t,i,n),mdx.util.fireAPIEvent(mdx.session,{type:"messagingerror",errorCode:e,pairingContext:t,sid:i,transactionId:n})},d=function(e){mdx.trace("mdx._onIncomingMessage",e);var t,i,n;if(!e.headers.host){if(!e.headers.Host)return void mdx.warn("Invalid request received - no Host field: ",e);e.headers.host=e.headers.Host}if(n=e.url.split("/"),n=n[1]||n[0],i=mdx.guard.processIncomingMessage(e.body))switch(e.headers.client?t=e.headers.client:i.fromurl?t=i.fromurl:i.controllerurl?t=i.controllerurl:e.headers.host&&(t=e.headers.host),mdx.trace("Received a message in mdxapi. path="+n),n){case"pairingrequest":case"pairingresponse":case"regpairrequest":case"regpairreply":case"regpairerror":mdx.pair._handleIncomingMessage(i,t);break;case"session":mdx.session._handleIncomingMessage({body:i,fromurl:t});break;case"mdxping":mdx.ping._handleIncomingMessage(i,t);break;case"error":mdx.guard.handleIncomingMessage(i,t);break;case"broadcast":mdx.broadcast.handleIncomingMessage(i);break;default:mdx.trace('Dropping message sent to path: "'+n+'" from host: "'+t+'" + event: "'+JSON.stringify(e))}else mdx.trace("Message failed MDXGuard: "+JSON.stringify(e))},c=[],l=void 0,u=function(e){mdx.trace("Remote target advertised it was restarting",e);var t=e.fromuuid,i=mdx._remoteDeviceMap[t];if(i){var n=Number(e.payload.duration);1>n?mdx.error("Invalid duration received for target restart. Will not track it",e.payload.duration):(i.restartTimeout&&mdx.libapi.globals.clearTimeout(i.restartTimeout),i.restartNotificationReceived=!0,i.restartTimeout=mdx.libapi.globals.setTimeout(function(){var e=i.restartTimeoutLostEvent;delete i.restartTimeout,delete i.restartTimeoutLostEvent,delete i.restartNotificationReceived,mdx.discovery.disableAggressiveDiscovery(),!i.inrange&&e?(mdx.warn("Timed out waiting for target to be found on restart",t,n),mdx.util.fireAPIEvent(mdx.discovery,e)):mdx.trace("Timed out waiting for a target reboot, but it was still in range, so skipping device lost")},n),mdx.discovery.enableAggressiveDiscovery())}else mdx.trace("Dropping targetrestarting message from unknown target",t)};return{_logServerStarted:!1,_isReady:!1,_isInitialized:!1,_role:"",_commandMap:void 0,_remoteDeviceMap:{},TARGET:"TARGET",CONTROLLER:"CONTROLLER",INIT_INTENT:{INITIALIZE:1,SHUTDOWN:2},X_MDX_ID:"X-MDX-ID",X_MDX_REGISTERED:"X-MDX-Registered",X_ACCEPTS_REGISTRATION:"X-Accepts-Registration",X_MSL:"X-MSL",X_MDX_CAPS:"X-MDX-Caps",_currentSSID:"",_registrationMode:"0",isDiscovering:!1,isAdvertising:!1,isRevealed:!1,get COMPLETE(){return mdx.libapi.nccp.getCOMPLETE()},get nativeVersion(){return mdx.getNativeVersion()},get mdxPort(){return t},get mdxServiceType(){return"mdx-netflix-com:service:target:2"},get role(){return this._role},get started(){return s},getVersion:function(){return mdx.version},getNativeVersion:function(){return mdx.libapi.mdx.getNativeVersion()},getMdxPort:function(){return t},ERRORS:{MDX_ERR_SSDP:1,MDX_ERR_PORT:2,MDX_ERR_NETWORK:3,MDX_ERR_VERSION:4,MDX_SESSION_INVALID_HMAC:5,MDX_SESSION_DECRYPTION_FAILED:6,MDX_PAIRING_NO_MATCH:10,MDX_SESSION_INVALID_SID:11,MDX_ERR_NOT_PAIRED:12,MDX_ERR_NO_CTICKET:13,MDX_ERR_MDXLIB:14},REGISTRATION_DISABLED:"0",REGISTRATION_ENABLED:"1",REGISTRATION_DEFAULT_PIN:"2",REGISTRATION_DARWIN_XPROFILE_V1:"3",REGISTERED:"1",NOT_REGISTERED:"0",LOG_LEVEL:{NONE:0,ERROR:1,WARN:2,INFO:3,TRACE:4},_logLevel:1,get logLevel(){return mdx._logLevel},set logLevel(e){mdx._logLevel=e},get isReady(){return mdx._isReady},events:{init:"init",initerror:"initerror",mdxstate:"mdxstate",exit:"exit"},getLocalURL:function(e){var t=new mdx.util.MdxUrl(mdx.libapi.mdx.getLocalURL()+":"+this.getMdxPort());return e&&(e=new mdx.util.MdxUrl(e),t.protocol=e.protocol),t.toString()},nextTransactionId:function(){var e=mdx.libapi.time.now();return e<=this._lastXid&&(e=this._lastXid+1),this._lastXid=e},queueMessage:function(e){var t={cmd:e.command,body:e.body,timeStamp:Date.now(),plain:e.plain,responseHandler:e.cb};if(e.sessionContext){if(!e.plaintext)return void mdx.error("Failed trying to queue a message for processing. plaintext value was specified");t.sessionContext=e.sessionContext,t.plaintext=e.plaintext}var i=mdx._remoteDeviceMap[e.target];i?(i.msgQue.push(t),++i.messagesSent,mdx.trace("Queuing message",t,e.target),mdx._processMsgQueue(e.target)):mdx.error("Could not locate device for msg",e,mdx._remoteDeviceMap)},_sendMdxMessage:function(e,t,i,n){mdx.libapi.mdx.sendMessage({url:e,body:t,cb:i,plain:n})},_createCanonicalForm:function(e){var t,i=[];for(t in e)e[t]&&i.push(t+"="+encodeURIComponent(e[t]));return i.sort(),i.join("&")},_processMsgTimeout:function(e,t){var i,n,r=mdx._remoteDeviceMap[e],s=mdx.session.ERRORS.MDX_SESSION_NETWORK_ERROR;if(r){mdx.warn("xid: "+t+" uuid: "+e+" timed out"),r.inFlight=t,mdx._isReady&&o(s,r.pairingContext,r.sessionId,t);for(n in r.msgQue)5e3<Date.now()-r.msgQue[n].timeStamp&&(i=r.msgQue.shift(),r.inFlight=null,mdx._isReady&&o(s,r.pairingContext,r.sessionId,i.body.nonce),mdx.error("Queued message ("+i.body.nonce+") timed out for "+e));r.inFlight=null,0<r.msgQue.length&&mdx._processMsgQueue(e)}},_processMsgQueue:function(e){var t,i,n,r,s,a,o=mdx._remoteDeviceMap[e];o?0<o.msgQue.length&&!o.inFlight&&(t=o.msgQue.shift(),i=o.loc+"/"+t.cmd,n=t.body.nonce||0,r=mdx.guard.processOutgoingMessage(t.body)||{},mdx.trace("Sending queued message "+n+" [Q:"+o.msgQue.length+" U:"+e+"] Outgoing message body: "+r,t),mdx.guard.addMessageToSentList(t.body,o),a=function(e){mdx._responseReceived(o,n)&&(s=400<=e.code||"undefined"!=typeof e.body&&-1!==e.body.indexOf("error"),t.responseHandler&&t.responseHandler(o,{xid:n,body:e.body,code:e.code},s))},o.requestTimeout=mdx.libapi.globals.setTimeout(function(){mdx._processMsgTimeout(e,n)},6100),o.inFlight=n,t.sessionContext&&t.plaintext?mdx.libapi.mdx.sendSessionMessage({url:i,requestType:0,timeout:6,context:t.sessionContext.context,header:"",body:r,message:t.body,plaintext:t.plaintext,cb:a}):mdx._sendMdxMessage(i,r,a,t.plain),0===o.msgQue.length&&mdx.trace("Message queue drained [U: "+e+"]")):mdx.error("remoteDevice not found uuid="+e)},_processInitIntent:function(){var e=mdx._initIntent;if(delete mdx._initIntent,e)switch(e.state){case mdx.INIT_INTENT.INITIALIZE:mdx._isReady||(mdx.init(e.role,e.commandMap),mdx.trace("Init intent was changed during processing - making sure we are initialized"));break;case mdx.INIT_INTENT.SHUTDOWN:mdx._isReady&&(mdx.trace("Init intent was changed during processing - making sure we exit"),mdx.exit())}},_cTicketcb:function(e){mdx.trace("INIT GOT CTICKET",e),""===e.cticket?(mdx.util.fireAPIEvent(mdx,{type:mdx.events.initerror,errorCode:mdx.ERRORS.MDX_ERR_NO_CTICKET,errorDesc:"Failed to get cticket"}),mdx.error("MDX init error: Failed to retrieve cticket","MDX"),mdx._processInitIntent()):(mdx.trace("mdx UUID:",mdx.libapi.device.getUUID()),mdx.configure(),mdx.libapi.mdx.init(d,function(e){mdx.util.fireAPIEvent(mdx,{type:mdx.events.initerror,errorCode:mdx.ERRORS.MDX_ERR_MDXLIB,errorDesc:"MDXLIB Failed to initialize. errorcode = "+e})}))},_responseReceived:function(e,t){return e.inFlight===t?(e.inFlight=null,e.requestTimeout&&(mdx.libapi.globals.clearTimeout(e.requestTimeout),delete e.requestTimeout),mdx._processMsgQueue(e.uuid),!0):(mdx.warn("Received response for "+t+" when "+e.inFlight+" was in flight."),!1)},_path:"mdxapi",addEventListener:function(e,t){mdx.libapi.eventing.addListener(mdx,e,t)},removeEventListener:function(e,t){mdx.libapi.eventing.removeListener(mdx,e,t)},configure:function(e){e&&(n=e.advertisingEnabled,i=e.msgLimit||i,r=decodeURIComponent(e.dialAdditionalDataUrl)),mdx.libapi.mdx.configure(30,1,1900,t,2,i)},_addMdxEventListener:function(e){mdx.libapi.mdx.addEventListener(e,this)},_removeMdxEventListener:function(e){mdx.libapi.mdx.removeEventListener(e,this)},setRegistrationMode:function(e){switch(e){case mdx.REGISTRATION_ENABLED:case mdx.REGISTRATION_DEFAULT_PIN:case mdx.REGISTRATION_DISABLED:case mdx.REGISTRATION_DARWIN_XPROFILE_V1:break;default:return void mdx.error("INVALID REGISTRATION_MODE "+e)}if(mdx._registrationMode=e,mdx.discovery.setDeviceReplyHeader(mdx.X_ACCEPTS_REGISTRATION,e),e!==mdx.REGISTRATION_DISABLED&&"undefined"!=typeof nrdp&&nrdp.device&&nrdp.device.SDKVersion){e="undefined"==typeof nrdp.device.SDKVersion.components?nrdp.device.SDKVersion:nrdp.device.SDKVersion.components.nrdlib;var t=/([0-9]+).([0-9]+)/.exec(e),i=t&&t[1],t=t&&(t[2]||"0");(e&&"cadmium.core"===e.version||i>2013||2013==i&&t>=3)&&mdx.discovery.setDeviceReplyHeader(mdx.X_MSL,"1")}},setUserId:function(e){e&&""!==e?mdx.discovery.setDeviceReplyHeader(mdx.X_MDX_ID,e):mdx.discovery.deleteDeviceReplyHeader(mdx.X_MDX_ID),mdx.device.setUserId(e)},init:function(t,i){if((mdx.libapi.globals.queryParameter("mdxlogserver")||mdx.libapi.globals.queryParameter("mdxdebuglogging"))&&(mdx.logLevel=mdx.LOG_LEVEL.TRACE),mdx.debug.initializeLogServerConnection(),mdx.debug.initializeTestChannelConnection(),mdx.trace("MDX Init"),this._initIntent)switch(this._initIntent.state){case this.INIT_INTENT.SHUTDOWN:this._initIntent={state:this.INIT_INTENT.INITIALIZE,role:t,commandMap:i};break;case this.INIT_INTENT.INITIALIZE:mdx.error("ERROR!: We are already in the process of initializing. You can't call init right now")}else this._isReady?t===mdx.TARGET&&mdx.error("ERROR!: We're already running. You can't call init now"):(this._commandMap=i||{},mdx.removeLogSink(mdx.libapi.log),mdx.addLogSink(mdx.libapi.log),mdx.trace("MDX init() called with role "+t+" and command map:",this._commandMap),t!==mdx.TARGET&&t!==mdx.CONTROLLER?mdx.error("mdx.init invalid role: "+t):(t===mdx.CONTROLLER&&(mdx.debug.enableProtocol("ws",!1),mdx.broadcast.addMessageListener("targetrestarting",u)),mdx._listenersAdded||(a.map(mdx._addMdxEventListener,mdx._mdxDispatcher),mdx._listenersAdded=!0),mdx.libapi.init(t,this._commandMap)&&(mdx.libapi.registration.isRegistered()&&mdx.libapi.registration.ping(),mdx._role=t,mdx.guard.setCommandMap(this._commandMap||{}),e.map(mdx.libapi.mdx.addInterfaceName),mdx.device.retrieveDeviceMap(),mdx.alwaysLog(mdx.LOG_LEVEL.INFO,"mdx.init: version = "+mdx.getVersion()+" nativeVersion = "+mdx.getNativeVersion()+" pairing.version = "+mdx.pair.version+" session.version = "+mdx.session.version+" platform.version = "+mdx.libapi.getPlatformVersion()+" localUrl = "+mdx.getLocalURL()+" role = "+mdx._role+" discovering = "+mdx.isDiscovering+" revealed = "+mdx.isRevealed),t===mdx.TARGET?mdx._cTicketcb("no_cticket_yet"):mdx.libapi.security.getCticket(mdx._cTicketcb))))},clearDeviceMap:function(){delete mdx._remoteDeviceMap,mdx._remoteDeviceMap={},mdx.device.storeDeviceMap()},_processStateChanged:function(e,i){mdx.trace("Processing state change",e,i);var s={};if(i){mdx.trace("MDX_READY"),mdx._isReady=!0,l=new Date,e.ssid&&""!==e.ssid&&(mdx._currentSSID=e.ssid);var o=!mdx._isInitialized;if(e.mdxport&&e.mdxport!==t&&(mdx.info("Platform has overriden the mdx port to "+e.mdxport),t=e.mdxport,o=!0),o=o&&"undefined"!=typeof r&&mdx.libapi.mdx.httpPost instanceof Function&&mdx.role===mdx.TARGET){var d="websocketPort="+t;mdx.libapi.mdx.httpPost(r,"",d,function(e){e.code&&200!=e.code||"undefined"!=typeof e.body&&-1!=e.body.indexOf("error")?mdx.warn("DIAL additional data post failed.",e):mdx.info("DIAL additional data posted successfully",r,d)})}mdx._isInitialized?(s.type=mdx.events.mdxstate,mdx.trace("MDX state ready event")):(mdx._isInitialized=!0,s.type=mdx.events.init,mdx.trace("MDX init success")),e.launchArgs&&(s.launchArgs=e.launchArgs),s.status="READY",mdx.util.fireAPIEvent(mdx,s),mdx._processInitIntent(),mdx._role===mdx.TARGET?(mdx.discovery.setDeviceReplyHeader(mdx.X_MDX_CAPS,mdx.libapi.mdx.getCapabilities().join(",")),mdx.discovery.setDeviceReplyHeader(mdx.X_ACCEPTS_REGISTRATION,mdx._registrationMode),mdx.setUserId(mdx.device.retrieveUserId()),mdx.libapi.registration.isRegistered()?mdx.discovery.setDeviceReplyHeader(mdx.X_MDX_REGISTERED,mdx.REGISTERED):mdx.discovery.setDeviceReplyHeader(mdx.X_MDX_REGISTERED,mdx.NOT_REGISTERED),mdx.discovery.revealPresence(),n&&mdx.libapi.mdx.startAdvertising(),mdx.isRevealed=!0):mdx._role===mdx.CONTROLLER&&mdx.discovery.start()}else mdx.trace("MDX_NOTREADY"),mdx._isReady=!1,mdx.pair._endAllTransactions(),mdx.device.storeDeviceMap(),mdx.discovery.stop(function(){mdx.libapi.mdx.stopAdvertising(),mdx.trace("MDX not ready event");var t;if(mdx._isInitialized?t={type:mdx.events.mdxstate,status:"NOT_READY"}:(t={type:mdx.events.exit},a.map(mdx._removeMdxEventListener,mdx._mdxDispatcher),mdx._listenersAdded=!1,mdx._processInitIntent()),mdx.util.fireAPIEvent(mdx,t),"undefined"!=typeof nrdp&&"undefined"!=typeof nrdp.mdx&&!nrdp.mdx.suspended&&""!==e.ssid&&750>new Date-l){t=!1;for(var i=0;i<nrdp.device.iflist.length;++i){var n=nrdp.device.iflist[i];if(n.ssid===e.ssid){t=1==n.linkConnected;break}}t&&(mdx.error("NATO-7293 Condition detected. Re-initializing MDX"),mdx.libapi.globals.setTimeout(function(){mdx._processStateChanged(e,!0)},500))}})},_mdxDispatcher:function(e){switch(mdx.trace("Got event in mdxdispatcher",e),e.type){case"statechanged":mdx._processStateChanged(e,e.state===mdx.libapi.mdx.getINITIALIZED());break;case"error":switch(e.error){case 1:e={type:mdx.events.initerror,errorCode:mdx.ERRORS.MDX_ERR_SSDP,errorDesc:"UPnP Error"},mdx.util.fireAPIEvent(mdx,e),mdx.error("MDX init error: UPnP Init Failed","MDX"),mdx._processInitIntent();break;case 2:e={type:mdx.events.initerror,errorCode:mdx.ERRORS.MDX_ERR_PORT,errorDesc:"Mongoose Init Fail"},mdx.util.fireAPIEvent(mdx,e),mdx.error("MDX init error: Mongoose Init Failed","MDX"),mdx._processInitIntent();break;case 3:mdx.error("MDX error: StartAdvertisement Failed","MDX"),mdx._processInitIntent();break;case 4:mdx.error("MDX error: StartControlPoint Failed","MDX"),mdx._processInitIntent()}break;case"advertisingstatechanged":mdx.isAdvertising=e.state==mdx.libapi.mdx.getADVERTISING();break;case"discoverystatechanged":e.state===mdx.libapi.mdx.getDISCOVERING()?mdx.isDiscovering=!0:(mdx._initIntent&&mdx._initIntent.state!==mdx.INIT_INTENT.SHUTDOWN&&mdx.discovery.stop(),mdx.isDiscovering=!1)}},interfaceChanged:function(e,t,i,n){mdx.trace("interface changed to: "+e,t,i,n),mdx.libapi.mdx.interfaceChanged.apply(mdx.libapi,arguments)},exit:function(){if(mdx.info("MDX Shutdown called"),this._initIntent)switch(this._initIntent.state){case mdx.INIT_INTENT.SHUTDOWN:mdx.error("ERROR!: We're already shutting down");break;case mdx.INIT_INTENT.INITIALIZE:this._initIntent={state:this.INIT_INTENT.SHUTDOWN}}else mdx._isReady?(this._initIntent={state:this.INIT_INTENT.SHUTDOWN},mdx.session._endAllSessions(),mdx.session._clearAllSessions(),mdx.pair._endAllTransactions(),mdx.device.storeDeviceMap(),mdx.libapi.mdx.stopAdvertising(),this._isInitialized=this._isReady=!1,mdx.broadcast.removeMessageListener("targetrestarting",u),mdx.libapi.mdx.deinit()):mdx.error("ERROR!: Mdx is not inited")},restartingTarget:function(e,t){this._role!==mdx.TARGET?mdx.error("mdx.targetRestarting invalid role: "+this._role):mdx.broadcast.sendMessage("targetrestarting",{duration:e},t)},formatString:function(){for(var e="",t=0;t<arguments.length;++t){var i=arguments[t];e.length&&(e+=", ");try{e+=JSON.stringify(i,null,4)}catch(n){e+=i}}return e},addLogSink:function(e){if("function"==typeof e)e={trace:e,info:e,warn:e,error:e};else if("object"!=typeof e||"function"!=typeof e.trace||"function"!=typeof e.info||"function"!=typeof e.warn||"function"!=typeof e.error)return void mdx.libapi.log.error("INVALID LOG SINK SPECIFIED - Must be a function or an object with trace, info, warn & error functions");c.push(e)},removeLogSink:function(e){for(var t=0;t<c.length;t++)if(c[t]==e){c.splice(t,1);break}},trace:function(){if(!(mdx._logLevel<mdx.LOG_LEVEL.TRACE))for(var e=0;e<c.length;e++)c[e].trace(mdx.formatString.apply(mdx,arguments))},info:function(){if(!(mdx._logLevel<mdx.LOG_LEVEL.INFO))for(var e=0;e<c.length;e++)c[e].info(mdx.formatString.apply(mdx,arguments))},warn:function(){if(!(mdx._logLevel<mdx.LOG_LEVEL.WARN))for(var e=0;e<c.length;e++)c[e].warn(mdx.formatString.apply(mdx,arguments))},error:function(){if(!(mdx._logLevel<mdx.LOG_LEVEL.ERROR))for(var e=0;e<c.length;e++)c[e].error(mdx.formatString.apply(mdx,arguments))},alwaysLog:function(e){var t=mdx._logLevel,i=Array.prototype.slice.call(arguments,1);try{switch(mdx._logLevel=99,e){case mdx.LOG_LEVEL.TRACE:mdx.trace.apply(mdx,i);break;case mdx.LOG_LEVEL.INFO:mdx.info.apply(mdx,i);break;case mdx.LOG_LEVEL.WARN:mdx.warn.apply(mdx,i);break;case mdx.LOG_LEVEL.ERROR:mdx.error.apply(mdx,i)}}catch(n){}mdx._logLevel=t}}}(),mdx.version="3.3.6-r111",mdx.ssdputil={serviceTypes:{mdx:"urn:mdx-netflix-com:service:target",dial:"urn:dial-multiscreen-org:service:dial",cast:"urn:cast-multiscreen-org:service:cast"},splitService:function(e){var t,i={urn:"",service:"",version:""},n=e?e.split(":"):[];for(e=0;e<n.length;e++)switch(t=n[e]){case"urn":i.urn=n[e+1];break;case"service":i.service=n[e+1];break;default:i.version=n[e]}return i},getServiceType:function(e){return e=mdx.ssdputil.splitService(e),"urn:"+e.urn+":service:"+e.service}},mdx.debug=function(){function e(e,t){function i(e,t){if(n){var i=e+t;if(1===n.readyState)try{n.send(i)}catch(r){}else c&&c.push(i)}}var n,r,s=this,a=!1,o=0,d='{"method":"heartbeat","message":"Keep alive heartbeat for client:: '+(t||"")+'"}',c=[],l={trace:function(e){i("TRACE: ",e)},info:function(e){i("INFO: ",e)},warn:function(e){i("WARN: ",e)},error:function(e){i("ERROR: ",e)}};this.open=function(){try{n=mdx.libapi.websocketclient.createWebSocket(e)}catch(t){return}n&&(n.onopen=function(){a=!0,o=0,c.forEach(function(e){n.send(e)}),c=void 0},n.onclose=function(){n=void 0,(a||120>++o)&&mdx.libapi.globals.setTimeout(function(){s.open()},1e3),c=void 0},n.onmessage=function(e){var t,i={type:"evalResponse",result:null};try{t=JSON.parse(e.data)}catch(r){if(!(r instanceof SyntaxError&&e.data.length))return;t={eval:e.data}}if("boolean"==typeof t.logsEnabled)t.logsEnabled?s.enableLogSink():s.disableLogSink();else if(t.eval){var a;try{i.id=t.id;var o=eval.call(s,t.eval);if("undefined"!=typeof o)try{a=JSON.stringify(o,null,4),16384<a.length&&(a=""+o)}catch(d){a=""+o}}catch(c){a=""+c}i.result=a,n.send(JSON.stringify(i))}})},this.enableLogSink=function(){mdx.addLogSink(l)},this.disableLogSink=function(){mdx.removeLogSink(l)},this.enableHeartbeats=function(){r&&mdx.libapi.globals.clearInterval(r),r=mdx.libapi.globals.setInterval(function(){n.send(d)},45e3)},this.disableHeartbeats=function(){r&&mdx.libapi.globals.clearInterval(r),r=void 0}}var t,i,n=!0,r=!1,s=!1;return{_path:"debug",addEventListener:function(e,t){mdx.libapi.eventing.addListener(mdx.debug,e,t)},removeEventListener:function(e,t){mdx.libapi.eventing.removeListener(mdx.debug,e,t)},events:{search:"search"},search:function(){mdx.libapi.discovery.debugSearch()},startPingingTarget:function(e,t,i,n){mdx.libapi.discovery.startPingingTarget&&mdx.libapi.discovery.startPingingTarget(e,t,i,n)},enableProtocol:function(e,t){mdx.protocols.enable(e,t)},getTransport:function(e){return(e=mdx._remoteDeviceMap[e])?e.protocol:null},get chromecastDialEnabled(){return r},set chromecastDialEnabled(e){mdx.warn("mdx.debug.chromecastDialEnabled changed from "+r+" to "+e),r=e},get chromecastCastEnabled(){return n},set chromecastCastEnabled(e){mdx.warn("mdx.debug.chromecastCastEnabled changed from "+n+" to "+e),n=e},get synchronousHTTPRequests(){return s},set synchronousHTTPRequests(e){s=e},initializeLogServerConnection:function(){if(!t){var i=mdx.libapi.globals.queryParameter("mdxlogserver");i&&(t=new e(i),t.open(),t.enableLogSink())}},initializeTestChannelConnection:function(){if(!i){var t=mdx.libapi.globals.queryParameter("wsTestChannel"),n=mdx.libapi.globals.queryParameter("wsTestChannelHeartbeat"),r=mdx.libapi.globals.queryParameter("e"),n="undefined"==typeof n||"false"!==n&&"0"!=n?!0:!1;t&&(i=new e(t,r),n&&i.enableHeartbeats(),i.open())}}}}(),mdx.device=function(){return{addToRemoteDeviceMap:function(e,t,i,n,r,s){return e={loc:e,ip:mdx.util.getIpFromLocation(e),serviceType:t,usn:i,uuid:n,activated:r,friendlyName:s,lastseen:Date.now(),pairingContext:"",inrange:!0,userId:"",sharedsecret:"",localSessionId:0,sessionId:0,msgQue:[],sendQueue:[],recvQueue:[],inFlight:null,xid:0,pairingTimer:void 0,messagesSent:0,messagesRecvd:0,sentList:[],recvdList:[],serviceUuids:{},registrationAcceptance:!1,msl:!1,blacklisted:!1},mdx._remoteDeviceMap[n]=e},getPairedDevice:function(e){var t,i;if(e)for(t in mdx._remoteDeviceMap)if(i=mdx._remoteDeviceMap[t],i.pairingContext==e)return i;return null},getRemoteDevicefromLocalSid:function(e){var t,i;if(e)for(t in mdx._remoteDeviceMap)if(i=mdx._remoteDeviceMap[t],i.localSessionId==e)return i;return null},getRemoteDevicefromSid:function(e){var t,i;if(e)for(t in mdx._remoteDeviceMap)if(i=mdx._remoteDeviceMap[t],i.sessionId==e)return i;return null},getPairingContextFromUuid:function(e){return mdx._remoteDeviceMap[e]?mdx._remoteDeviceMap[e].pairingContext:null},getUuidFromPairingContext:function(e){var t;if(e&&""!=e)for(t in mdx._remoteDeviceMap)if(mdx._remoteDeviceMap[t].pairingContext==e)return t;return null},storeDeviceMap:function(){var e,t,i=[],n={};for(e in mdx._remoteDeviceMap)t=mdx._remoteDeviceMap[e],t["volatile"]||i.push({uniqueId:t.uniqueId,uuid:t.uuid,usn:t.usn,serviceType:t.serviceType,activated:t.activated,friendlyName:t.friendlyName,loc:t.loc,ssid:t.ssid,lastseen:t.lastseen,pairingContext:t.pairingContext&&t.sharedsecret?t.pairingContext:"",sharedsecret:t.pairingContext&&t.sharedsecret?t.sharedsecret:"",controlleruserid:t.controlleruserid,targetuserid:t.targetuserid,ip:t.ip?t.ip:"",serviceUuids:t.serviceUuids,canBeStopped:t.canBeStopped,dialVer:t.dialVer,blacklisted:t.blacklisted});for(16<i.length&&i.sort(function(e,t){return e.lastseen>t.lastseen}),t=0;t<Math.min(i.length,16);t++)n[i[t].uuid]=i[t];mdx.trace("Storing device map",n),mdx.libapi.storage.setItem("REMOTE_DEVICE_MAP",n)},retrieveDeviceMap:function(){if(!this.loaded){this.loaded=!0;var e,t,i=mdx.libapi.storage.getItem("REMOTE_DEVICE_MAP")||{};for(e in i)t=i[e],t.inrange=!1,t.localSessionId=0,t.sessionId=0,t.msgQue=[],t.sendQueue=[],t.recvQueue=[],t.inFlight=null,t.xid=0,t.pairingTimer=void 0,t.messagesSent=0,t.messagesRecvd=0,t.recvPending=void 0,t.sentList=[],t.recvdList=[],t.serviceUuids||(t.serviceUuids={}),t.pairingContext&&""!==t.pairingContext?t.sharedsecret&&""!==t.sharedsecret||(t.pairingContext=void 0,t.sharedsecret=void 0):(t.pairingContext=void 0,t.sharedsecret=void 0);mdx._remoteDeviceMap=i,mdx.trace("Loaded Devices",mdx.discovery.getRemoteDeviceList())}},setUserId:function(e){mdx.libapi.storage.setItem("MDX_USERID",e||"")},retrieveUserId:function(){var e=mdx.libapi.storage.getItem("MDX_USERID");return e&&""!=e?e:void 0},getCastSessionForRemoteDevice:function(e){return mdx.libapi.castclient&&mdx.libapi.castclient.getCastSessionForRemoteDevice instanceof Function?mdx.libapi.castclient.getCastSessionForRemoteDevice(e):void 0}}}(),mdx.discovery=function(){var e={},t="",i=void 0,n={services:[{type:"mdx",interval:15e3},{type:"dial",interval:15e3}]},r={services:[{type:"mdx",interval:1e3}]},s=[],a=function(e,t,i){if(e=mdx.util.getUUID(t),(t=mdx._remoteDeviceMap[e])&&t.inrange){mdx.trace(e+"  was in range, now lost"),t.inrange=!1,t.launchStatus=0;var n;switch(t.serviceType){case mdx.ssdputil.serviceTypes.dial:case mdx.ssdputil.serviceTypes.cast:n=t.usn;break;case mdx.ssdputil.serviceTypes.mdx:n=t.dialUsn}i={type:mdx.discovery.events.devicelost,devicelist:[e],reason:i,dialUsn:n,uniqueId:t.uniqueId},t.restartNotificationReceived?(mdx.trace("Postponing the devicelost event for "+e+" as we are tracking a restart"),t.restartTimeoutLostEvent=i):(mdx.info("Target device was reported as lost",i),mdx.util.fireAPIEvent(mdx.discovery,i))}},o=function(e){var t=mdx.util.getUUID(e),i=mdx._remoteDeviceMap[t];i&&(i.launchStatus=1),mdx.util.fireAPIEvent(mdx.discovery,{type:mdx.discovery.events.remoteDeviceReady,uniqueId:i.uniqueId,dialUsn:e,UUID:t,ip:i.ip,launchStatus:1}),mdx.info("MDX Device launch complete")},d=function(){t="",mdx.libapi.globals.clearTimeout(i),i=void 0,mdx.discovery.disableAggressiveDiscovery()},c={onDeviceReply:function(e,t,i,n,r,s){var a=mdx.util.getUUID(t);e=mdx.ssdputil.getServiceType(e),mdx.discovery.onDeviceFound(a,t,i,e,n,r,s)},onDeviceLost:a},l=function(e,t){var i,n;if(e&&t)for(i in mdx._remoteDeviceMap)if(mdx._remoteDeviceMap.hasOwnProperty(i)&&(n=mdx._remoteDeviceMap[i],e==n.ip&&n.serviceType===t&&n.inrange))return n},u=function(e,t,i){var n,r;return e&&(r=mdx._remoteDeviceMap[e])?((n=r.serviceUuids[i])?n!==t&&mdx.warn(i+" on "+e+" was associated with UUID "+n+" now associated with "+t):mdx.info("Associating "+i+" on "+e+" with "+t),r.serviceUuids[i]=t,!0):!1},m=function(){var t,i=[];for(t in e)e.hasOwnProperty(t)&&i.push(t+": "+e[t]);mdx.libapi.mdx.setDeviceReplyHeaders(i),mdx.ping.setDeviceReplyHeaders(e)},g=function(){mdx.trace("Enabling aggressive discovery mode"),mdx.libapi.discovery.setConfiguration(r)},p=function(){mdx.trace("Disabling aggressive discovery mode and reverting to default configuration"),mdx.libapi.discovery.setConfiguration(n)};return{LAUNCHED:1,NOTLAUNCHED:0,serviceTypes:{dial:mdx.ssdputil.serviceTypes.dial,mdx:mdx.ssdputil.serviceTypes.mdx},ERRORS:{MDX_DISCOVERY_NO_PROTOCOL:1,MDX_DISCOVERY_DEVICE_BYEBYE:2,MDX_DISCOVERY_DEVICE_NOT_RESPONDED_DIAL:3,MDX_DISCOVERY_DEVICE_NOT_RESPONDED_MDX:4,MDX_DISCOVERY_DEVICE_NOT_RESPONDED_CAST:5,MDX_DISCOVERY_DEVICE_COMMUNICATION_CHANNEL_CLOSED:6,MDX_DISCOVERY_MDX_SHUTDOWN:7,MDX_DISCOVERY_DEVICE_BLACKLISTED:8,MDX_DISCOVERY_DEVICELOST_UNKNOWN:99},events:{remoteDeviceReady:"remoteDeviceReady",devicelost:"devicelost",devicefound:"devicefound",castDevicesAvailable:"castdevicesavailable",castDevicesUnavailable:"castdevicesunavailable",castReceiverLaunching:"castreceiverlaunching",castReceiverStopping:"castreceiverstopping"},_path:"mdx.discovery",start:function(){mdx.libapi.discovery.setListener(mdx.ssdputil.serviceTypes,c),mdx.libapi.discovery.setConfiguration(n),mdx.libapi.discovery.enable()},stop:function(e){mdx.libapi.discovery.unsetListener(mdx.ssdputil.serviceTypes,c),mdx.libapi.discovery.disable(e);for(var t in mdx._remoteDeviceMap)mdx._remoteDeviceMap.hasOwnProperty(t)&&(e=mdx._remoteDeviceMap[t],e.inrange=!1)},onDeviceFound:function(e,i,n,r,s,c,m){var g,v,x,f,E,h=/[^ -~\u00a0-\uffff]|[\ud800-\udfff]/,_=[],S=[],I=!1,T=mdx.ssdputil.serviceTypes.dial,R=mdx.ssdputil.serviceTypes.cast,D=mdx.ssdputil.serviceTypes.mdx,A=mdx.REGISTERED;if(e||S.push("uuid"),i||S.push("USN"),n||S.push("location"),r||S.push("serviceType"),c||S.push("friendlyName"),r===mdx.ssdputil.serviceTypes.dial&&(m||S.push("dialInfo")),S.length)r="Discovered device is missing "+S.join(",")+", ignoring. ",mdx.util.fireAPIEvent(mdx.debug,{type:mdx.debug.events.search,msg:r},!0),mdx.warn(r);else if(r!=R&&h.test(c))mdx.error("Friendlyname of device "+e+" has illegal characters in it, ignoring");else{switch(mdx._remoteDeviceMap[e]||(mdx.device.addToRemoteDeviceMap(n,r,i,e,1,c),I=!0),h=mdx._remoteDeviceMap[e],S=m&&m.caps?m.caps:[],s&&(g=mdx.REGISTRATION_DISABLED,s[mdx.X_ACCEPTS_REGISTRATION]&&(g=s[mdx.X_ACCEPTS_REGISTRATION]),v=s[mdx.X_MSL],x=s[mdx.X_MDX_CAPS],f=s[mdx.X_MDX_ID],s[mdx.X_MDX_REGISTERED]===mdx.NOT_REGISTERED&&(A=mdx.NOTREGISTERED)),g&&g!=mdx.REGISTRATION_DISABLED&&_.push("regpair"),x&&(_=mdx.util.union(_,x.split(","))),h.userId=f,h.serviceType){case D:h.ip=m&&m.ip?m.ip:mdx.util.getIpFromLocation(n),h.msl=v,_.push("mdx"),(s=l(h.ip,T))?(E=s.usn,u(e,s.uuid,T)&&u(s.uuid,e,D),h.dialVer=s.dialVer):h.dialVer="N/A",h.launchStatus=mdx.discovery.LAUNCHED;break;case T:h.ip=mdx.util.getIpFromLocation(n),S.push("dial"),s=l(h.ip,D),E=h.usn,s&&u(e,s.uuid,D)&&u(s.uuid,e,T),h.canBeStopped=m&&m.canBeStopped,h.dialVer=m&&m.dialVer||"1.6",h.launchStatus=h.launchStatus||mdx.discovery.NOTLAUNCHED;break;case R:E=h.usn,m&&(h.ip=m.ip,h.msl=-1!==m.caps.indexOf("msl"),h.launchStatus=m.launchStatus||mdx.discovery.NOTLAUNCHED,A=m.registered?mdx.REGISTERED:mdx.NOTREGISTERED,g=m.registrationAcceptance),h.canBeStopped=m&&m.canBeStopped,h.dialVer="N/A"}if(h.registered=A,h.capabilities=mdx.util.union(S,_),n=new mdx.util.MdxUrl(n),r===mdx.ssdputil.serviceTypes.mdx&&(n.protocol=mdx.protocols.decideProtocol(h.capabilities,n)),h.loc=n.toString(),h.protocol=n.protocol,h.lastseen=Date.now(),h.ssid=mdx._currentSSID,m&&(h.dialAppUrl=m.url?m.url:h.dialAppUrl),h.friendlyName=c||h.friendlyName,h.serviceType=r,h.registrationAcceptance=g||h.registrationAcceptance,h.registrationAcceptance||(h.registrationAcceptance=mdx.REGISTRATION_DISABLED),h.protocol&&""!=h.protocol){if(n=!1,!h.inrange||I){if(mdx.trace(e+" was not in range, now in range"),n=h.inrange=!0,h.serviceType==R)h.uniqueId=h.usn;else if(!h.uniqueId){m=h.ip;var y,I=[];if(m)for(y in mdx._remoteDeviceMap)mdx._remoteDeviceMap.hasOwnProperty(y)&&(_=mdx._remoteDeviceMap[y],m==_.ip&&_.inrange&&I.push(_));for(y=0;y<I.length;++y)if(m=I[y],m.uniqueId&&m.serviceType!=R){h.uniqueId=m.uniqueId;break}h.uniqueId=h.uniqueId||h.usn}h.restartNotificationReceived?(mdx.trace("Target was rediscovered after it restarted so clearing out the timeout and invoking the restart callback if required: "+h.uuid),h.restartTimeout&&mdx.libapi.globals.clearTimeout(h.restartTimeout),delete h.restartTimeout,delete h.restartTimeoutLostEvent,delete h.restartNotificationReceived,n=!1,p(),h.onTargetRestartedCb instanceof Function&&(h.onTargetRestartedCb(),delete h.onTargetRestartedCb)):(e={type:mdx.discovery.events.devicefound,dialUsn:E,uniqueId:h.uniqueId,USN:i,UUID:e,activated:1,registered:h.registered,location:h.location,ip:h.ip,serviceType:r,friendlyName:c,registrationAcceptance:h.registrationAcceptance===mdx.REGISTRATION_DARWIN_XPROFILE_V1?mdx.REGISTRATION_DEFAULT_PIN:h.registrationAcceptance,capabilities:h.capabilities,launchStatus:h.launchStatus},mdx.info("New device found: "+c,h.uniqueId,r,h.ip,h.launchStatus,h.registrationAcceptance),mdx.util.fireAPIEvent(mdx.discovery,e)),h.registrationAcceptance===mdx.REGISTRATION_DARWIN_XPROFILE_V1&&mdx.ping.sendPing(h.loc,h.serviceType)}else mdx.util.fireAPIEvent(mdx.debug,{type:mdx.debug.events.search,msg:"Device "+e+" replied, is already in range"},!0);h.serviceType===D&&(E&&E==t?(d(),o(E)):n&&o(h.uuid))}else h.inrange&&a(r,i,mdx.libapi.discovery.ERRORS.MDX_DISCOVERY_NO_PROTOCOL)}},addEventListener:function(e,t){mdx.libapi.eventing.addListener(mdx.discovery,e,t)},removeEventListener:function(e,t){mdx.libapi.eventing.removeListener(mdx.discovery,e,t)},revealPresence:function(){if(mdx._role===mdx.TARGET){var e=!1,t=function(){e||(e=!0,m())};mdx.libapi.mdx.reveal(t),mdx.libapi.globals.setTimeout(t,350)}else mdx.error("Cannot call mdx.discovery.revealPresence on CONTROLLER")},setDeviceReplyHeader:function(t,i){e[t]=i,mdx.isRevealed&&m()},deleteDeviceReplyHeader:function(t){e[t]&&(delete e[t],mdx.isRevealed&&m())},hidePresence:function(){mdx._role===mdx.TARGET?mdx.libapi.mdx.hide():mdx.error("Cannot call mdx.discovery.hidePresence on CONTROLLER")},getRemoteDeviceList:function(){var e,t,i,n=mdx.ssdputil.serviceTypes.mdx,r=mdx.ssdputil.serviceTypes.dial,s=mdx.ssdputil.serviceTypes.cast,a={},o=[];for(t in mdx._remoteDeviceMap)if(i=mdx._remoteDeviceMap[t],
(i.inrange||i.restartNotificationReceived)&&!i.blacklisted)switch(i.serviceType){case n:(e=i.serviceUuids[r])&&a[e]?(e=a[e],e.serviceType=n,e.usn=i.usn,e.uuid=i.uuid,e.uniqueId=i.uniqueId,e.location=i.loc,e.ip=i.ip||"",e.friendlyName=i.friendlyName,e.launchStatus=1,e.pairingContext=i.pairingContext,e.registrationAcceptance=i.registrationAcceptance===mdx.REGISTRATION_DARWIN_XPROFILE_V1?mdx.REGISTRATION_DEFAULT_PIN:i.registrationAcceptance,e.capabilities=e.capabilities.concat(i.capabilities),e.registered=i.registered):a[t]={serviceType:n,usn:i.usn,uuid:i.uuid,uniqueId:i.uniqueId,dialUsn:"",dialUuid:"",location:i.loc,ip:i.ip||"",friendlyName:i.friendlyName,launchStatus:1,pairingContext:i.pairingContext,registrationAcceptance:i.registrationAcceptance===mdx.REGISTRATION_DARWIN_XPROFILE_V1?mdx.REGISTRATION_DEFAULT_PIN:i.registrationAcceptance,capabilities:i.capabilities,registered:i.registered,dialVer:i.dialVer};break;case s:if(n in i.serviceUuids&&i.uuid in a)break;a[t]={serviceType:s,usn:i.usn,uuid:i.uuid,uniqueId:i.uniqueId,dialUsn:i.usn,dialUuid:"",location:i.loc,ip:i.ip||"",friendlyName:i.friendlyName,launchStatus:i.launchStatus,pairingContext:i.pairingContext,registrationAcceptance:i.registrationAcceptance,capabilities:i.capabilities,registered:i.registered,canBeStopped:i.canBeStopped,dialVer:i.dialVer};break;case r:(e=i.serviceUuids[n])&&a[e]?(e=a[e],e.dialUsn=i.usn,e.uniqueId=i.uniqueId,e.dialUuid=i.uuid,e.ip=i.ip||e.ip,e.launchStatus=e.launchStatus?e.launchStatus:0,e.friendlyName=i.friendlyName,e.capabilities=e.capabilities.concat(i.capabilities),e.canBeStopped=i.canBeStopped,e.dialVer=i.dialVer):a[t]={serviceType:r,usn:"",uuid:"",dialUsn:i.usn,uniqueId:i.uniqueId,dialUuid:i.uuid,location:"",ssid:i.ssid,ip:i.ip,friendlyName:i.friendlyName,launchStatus:0,pairingContext:"",registrationAcceptance:mdx.REGISTRATION_DISABLED,capabilities:i.capabilities,registered:i.registered,canBeStopped:i.canBeStopped,dialVer:i.dialVer}}for(t in a)o.push(a[t]);return o},isRemoteDeviceReady:function(){},launchNetflix:function(e,n){var r,s;n=n||"";for(r in mdx._remoteDeviceMap)if(mdx._remoteDeviceMap.hasOwnProperty(r)&&mdx._remoteDeviceMap[r].usn==e)return s=mdx._remoteDeviceMap[r],mdx.info("Launching on device "+e+" with launch timeout of 120000"),void mdx.libapi.discovery.launch(s.usn,s.dialAppUrl,s.friendlyName,n,function(n,r){n?(t=e,i&&(mdx.libapi.globals.clearTimeout(i),i=void 0),s.serviceType!==mdx.ssdputil.serviceTypes.cast&&(i=mdx.libapi.globals.setTimeout(function(){var t=mdx.util.getUUID(e),i=mdx._remoteDeviceMap[t];i&&(i.launchStatus=0),d(),mdx.util.fireAPIEvent(mdx.discovery,{type:mdx.discovery.events.remoteDeviceReady,uniqueId:i.uniqueId,dialUsn:e,UUID:t,ip:i.ip,launchStatus:0}),mdx.error("MDX Device launch timed out")},12e4),g())):(mdx.error("Launch failed: "+r),mdx.util.fireAPIEvent(mdx.discovery,{type:mdx.discovery.events.remoteDeviceReady,uniqueId:s.uniqueId,dialUsn:e,UUID:"",ip:s.ip,launchStatus:0}))});mdx.error("Device with USN "+e+" not found"),mdx.util.fireAPIEvent(mdx.discovery,{type:mdx.discovery.events.remoteDeviceReady,uniqueId:s.uniqueId,dialUsn:e,UUID:"",ip:"",launchStatus:0})},launchCastDevice:function(e,t){mdx.trace("MDX Launch cast device"),mdx.libapi.castclient.launch(void 0,e,t)},stopNetflix:function(e,t){var i,n;for(i in mdx._remoteDeviceMap)if(mdx._remoteDeviceMap.hasOwnProperty(i)&&mdx._remoteDeviceMap[i].usn==e){if(n=mdx._remoteDeviceMap[i],!n.canBeStopped)return mdx.error("Cannot stop the netflix app on the target as it does not support it. device.canBeStopped: "+n.canBeStopped),void(t&&t(!1));mdx.info("Attempting to stop Netflix on device "+e),mdx.libapi.discovery.stopNetflix(n,function(e){t&&t(e)})}t&&t(!1)},enableAggressiveDiscovery:function(){g()},disableAggressiveDiscovery:function(){p()},get discoveryBlacklist(){return s},set discoveryBlacklist(e){if(mdx.trace("Updating discovery blacklist",e,e.length),Array.isArray(e)){e&&e.length&&e.forEach(function(e){e.manufacturer||e.model||mdx.error("Invalid configuration for discovery blacklist. A tuple was specified with an empty manufacturer or model name regex")}),s=e;for(var t in mdx._remoteDeviceMap)mdx._remoteDeviceMap.hasOwnProperty(t)&&(e=mdx._remoteDeviceMap[t],e.manufacturer||e.model)&&(e.blacklisted=mdx.discovery.isDeviceBlacklisted(e.manufacturer,e.model),e.blacklisted&&e.inrange)&&(e.serviceType===mdx.ssdputil.serviceTypes.mdx?a(e.serviceType,e.usn,mdx.discovery.ERRORS.MDX_DISCOVERY_DEVICE_BLACKLISTED):e.serviceType===mdx.ssdputil.serviceTypes.dial&&(a(e.serviceType,e.usn,mdx.discovery.ERRORS.MDX_DISCOVERY_DEVICE_BLACKLISTED),e=e.serviceUuids[mdx.ssdputil.serviceTypes.mdx])&&(e.launchStatus=mdx.discovery.NOTLAUNCHED,e.blacklisted=!0,e.inrange&&a(e.serviceType,e.usn,mdx.discovery.ERRORS.MDX_DISCOVERY_DEVICE_BLACKLISTED)));mdx.device.storeDeviceMap()}else mdx.error("MDX discovery blacklist must be an array of tuples. Invalid value: ",e)},isDeviceBlacklisted:function(e,t){if(mdx.trace("Checking discovery blacklist",e,t),"Google Inc."===e&&"Eureka Dongle"===t)return mdx.trace("Device was blacklisted due to hard coded Chromecast check:",e,t),!0;for(var i=0;i<mdx.discovery.discoveryBlacklist.length;i++){var n=mdx.discovery.discoveryBlacklist[i];if(n.manufacturer===e&&n.model===t)return mdx.trace("Device was blacklisted due to discoveryBlacklist configuration:",e,t),!0}return mdx.trace("Device was not blacklisted"),!1}}}(),mdx.guard=function(){var e={errorCode:4,errorString:"Duplicate NONCE"},t={errorCode:7,errorString:"Malformed message"},i=function(e,t,n,r,a){var o,d,c,l=0;if("number"!==s(a)&&(a=1),o=s(e),"array"===o){if(a>r){for(c in e)e.hasOwnProperty(c)&&(o=t?[t,"[",c,"]"].join(""):c,o=i(e[c],o,n,r+1,a),d=[d,o].join(""),l++);0==l&&(d=t?[t,"[]=",n].join(""):null)}return d}if("object"===o){if(a>r){for(c in e)e.hasOwnProperty(c)&&(o=t?[t,c].join("."):c,o=i(e[c],o,n,r+1,a),d=[d,o].join(""),l++);0==l&&(d=t?[t,".=",n].join(""):null)}return d}return[t,"=",e,n].join("")},n=function(e,t,i){var r,a,o;return"string"==s(t)?(o=t.indexOf("."),a=t.indexOf("[")):a=o=-1,o>=0&&(0>a||a>o)?(o>0?(r=t.substring(0,o),e.hasOwnProperty(r)||(e[r]={}),e[r]=n(e[r],t.slice(o+1),i)):(e||(e={}),e=n(e,t.slice(o+1),i)),e):a>0?(o=t.indexOf("]"),o>0?(r=t.substring(0,a),a=parseInt(t.substr(a+1,o-1),10),e.hasOwnProperty(r)||(e[r]=[]),t=t.slice(o+1),""!==t?e[r][a]=n(e[r][a],t,i):e[r]=n(e[r],a,i),e):void 0):(e[t]=i,e)},r=function(e,t){var i,r,s,a;i=e;var o,d,c;for(o=[],s=i.indexOf(t);s>0;)a=i.substr(0,s),d=[],c=a.indexOf("="),d.push(a.slice(0,c)),d.push(a.slice(c+1)),o.push(d),i=i.slice(s+t.length),s=i.indexOf(t);i={};for(r in o)o.hasOwnProperty(r)&&(s=o[r][0],a=o[r][1],n(i,s,a));return i},s=function(e){if(e instanceof Array)return"array";var t=typeof e;return"object"!==t||e?t:"null"},a=function(e){"undefined"!=typeof e.body&&-1!=e.body.indexOf("error")&&mdx.error("Failed to send error message. body: "+e.body+" code: "+e.code)},o={pairingrequest:{version:"VERSION",nonce:"NUMBER",controllerurl:"FROMURL",controlleruuid:"ASCII",pairdatahmac:"BASE64",cticket:"CTICKET"},pairingresponse:{version:"VERSION",nonce:"NUMBER",controllersharedsecret:"ASCII",targetuuid:"ASCII",targetuserid:"ASCII",controlleruuid:"ASCII",controlleruserid:"ASCII",grantdatahmac:"BASE64"},regpairrequest:{nonce:"NUMBER",pin:"BASE64",cticket:"CTICKET",hmac:"BASE64",version:"VERSION",controlleruuid:"ASCII",controllerurl:"FROMURL",pairdatahmac:{optional:!0,type:"BASE64"}},regpairreply:{nonce:"NUMBER",userid:"ASCII",controllersharedsecret:"ASCII",grantdatahmac:"BASE64",version:"VERSION",targetuuid:"ASCII"},regpairerror:{nonce:"NUMBER",version:"VERSION",targetuuid:"ASCII",errorcode:"ASCII",errorstring:"ASCII"},pairingresponse_error:{version:"VERSION",nonce:"NUMBER",targetuuid:"ASCII",targetuserid:"ASCII",errorcode:"ASCII",errorstring:"ASCII"},session:{version:"VERSION",nonce:"NUMBER",fromurl:"FROMURL",fromuuid:"ASCII",fromuserid:"ASCII",touuid:"ASCII",touserid:"ASCII",hmac:"BASE64",plaintext:{optional:!0,type:"ASCII"},ciphertext:{optional:!0,type:"BASE64"},validate:function(e){return e.plaintext?l.ASCII(e.plaintext)?!0:(mdx.trace("Invalid plaintext characters for command 'session'",e),!1):e.ciphertext?l.BASE64(e.ciphertext)?!0:(mdx.warn("Invalid ciphertext characters for command 'session'",e),!1):(mdx.warn("Command 'session' has neither ciphertext nor plaintext"),!1)}},pingsearch:{fromuuid:"ASCII",fromurl:"FROMURL",servicetype:"ASCII",id:"ASCII"},pingresponse:{friendlyname:"BASE64",fromurl:"FROMURL",fromuuid:"ASCII",responseheaders:"ASCII",servicetype:"ASCII",touuid:"ASCII",id:"ASCII"},error:{nonce:"NUMBER",fromuuid:"ASCII",touuid:"ASCII",errorcode:"ASCII",errorstring:"ASCII"},broadcast:{nonce:"NUMBER",fromuuid:"ASCII",fromurl:"FROMURL",messageType:"ASCII",payload:{optional:!0,type:"ASCII"}}},d=function(e,t,i,n,r){if(r&&""==n)return mdx.warn("param '"+i+"' of '"+t+"' is empty"),!1;if(e.hasOwnProperty(t))if(e[t].hasOwnProperty(i)){if(e=e[t][i],e instanceof Object&&(e=e.type),l.hasOwnProperty(e))return l[e](n);mdx.warn("Unknown filter type '"+e+"' for '"+t+"' parameter '"+i+"', using ASCII")}else{if(r)return mdx.warn("param '"+i+"' is unexpected."),null;mdx.warn("param '"+i+"' not in filter map of '"+t+"', using ASCII")}return l.ASCII(n)},c=function(e,t){return e-t},l=function(){var e=/[^0-9.]/,t=/\d{1,}\.\d{1,}/,i=/[^\ -~]/,n=/[^!-~\u00c0-\u0192]/,r=/^(https?|wss?|cast?):\/\/(.*\@.*)?([a-z0-9]+[a-z0-9\.]*|\[[a-f0-9]{0,4}\:[a-f0-9]{0,4}\:[a-f0-9]{0,4}\:[a-f0-9]{0,4}\:[a-f0-9]{0,4}\:[a-f0-9]{0,4}\:[a-f0-9]{0,4}\:[a-f0-9]{0,4}\])(\:([^$\/]+))?(\/[a-z0-9\/\.\_\-\~\%]*)?(\#.*)?(\?.*)?/i,s=/\.\.+/,a=/[^A-Za-z0-9\+\/\=]/,o=/[^A-Za-z0-9\+\/\=,]/,d=/[^0-9\-]/,c=/-?\d{1,}/;return{VERSION:function(i){return e.test(i)?!1:i.match(t)==i},ASCII:function(e){return!i.test(e)},UTF8:function(e){return!n.test(e)},URL:function(e){var t=r.exec(e)||[];e=t[1];var i=t[2],n=t[3],a=t[5],o=t[6],d=t[7],c=t[8],t=!t[4]||isFinite(a);return e&&!i&&n&&t&&!d&&!c&&!s.test(o)},FROMURL:function(e){return this.URL(e)},BASE64:function(e){return!a.test(e)},CTICKET:function(e){return!o.test(e)},NUMBER:function(e){return d.test(e)?!1:e.match(c)==e}}}(),u=function(e){return"pairingrequest"==e.action||"pairingpoll"==e.action||"regpairrequest"==e.action?e.controlleruuid:"pairingresponse"==e.action?e.targetuuid:e.fromuuid?e.fromuuid:e.controlleruuid?e.controlleruuid:(mdx.warn("Can't guess how to get the from uuid from message type "+e.action),null)},m=function(e,t,i,n){t={action:"error",nonce:t||mdx.nextTransactionId(),fromuuid:mdx.libapi.device.getUUIDForRemoteDevice(i,e),touuid:i,errorcode:n.errorCode,errorstring:n.errorString},i=mdx.guard.processOutgoingMessage(t),mdx.nextTransactionId(),mdx._sendMdxMessage(e+"/"+t.action,i,a),mdx.error("Sending error message from inside Mdx Guard",t)},g=function(e,t){var i,n,r=parseInt(e.nonce,10);i=e.controllerurl?e.controllerurl:e.fromurl?e.fromurl:null,(n=u(e))?(i=mdx._remoteDeviceMap[n])?m(i.loc,r,n,t):mdx.warn("Device "+n+" not known, cannot send error message"):i&&l.URL(i)?m(i,r,n,t):mdx.warn("Unknown sender of message, cannot send error message. Message dropped")};return{applicationCommandMap:{},setCommandMap:function(e){this.applicationCommandMap=e},processOutgoingMessage:function(e){return i(e,null,"\r\n",0,5)},processOutgoingMessageBody:function(e){return e=i(e,null,"\r\n",0,5),mdx.trace("processOutgoingMessageBody :\n"+e),e},processIncomingMessage:function(e){var i,n,s;if(i=r(e,"\r\n"),n=i.action,"pairingresponse"==n&&(i.hasOwnProperty("errorstring")||i.hasOwnProperty("errorcode"))&&(n="pairingresponse_error"),!o.hasOwnProperty(n))return mdx.warn('Unknown command: "'+n+'" return malformed message error. msg = '+e),g(i,t),mdx.messagesDropped++,null;if(!o.hasOwnProperty(n))return mdx.error("Internal error, unknown command: '"+n+"'. msg = "+e),mdx.messagesDropped++,null;var a=o[n];for(s in a){var c=a[s];if(c instanceof Function){if(!c(i))return null}else{if(!i.hasOwnProperty(s)&&!c.optional)return mdx.warn("Command '"+n+"' is missing required field '"+s+"'. msg = "+e,i),g(i,t),mdx.messagesDropped++,null;if(!d(o,n,s,i[s],!0))return mdx.warn("Command '"+n+"' failed validation of '"+s+"'. msg = "+e),g(i,t),mdx.messagesDropped++,null}}for(s in i)if("action"!=s&&!o[n].hasOwnProperty(s))return mdx.warn("Command '"+n+"' has extra field: '"+s+"'. msg = "+e),g(i,t),mdx.messagesDropped++,null;return i},processIncomingMessageBody:function(e,i){var n,s,a,o;if(mdx.trace("processIncomingMessageBody ("+e.nonce+") "+i),n=r(i,"\r\n"),"appMessage"===n.sessionAction)for(s in a=n.appAction,o=n.appBody)if(o.hasOwnProperty(s)&&!d(this.applicationCommandMap,a,s,o[s],!1))return mdx.error("Command '"+a+"' failed validation of '"+s+"'"),g(e,t),mdx.messagesDropped++,null;return n},handleIncomingMessage:function(e){"error"==e.action&&mdx.error("Error message received: "+e.errorstring)},checkForReplay:function(e,t){var i=t.action;if(e)if("error"===i||"pairingresponse"===i||"regpairreply"===i||"pairingresponse_error"===i||"regpairerror"===i){if(!this.checkMessageAgainstSent(t,e))return mdx.messagesDropped++,!0}else if(this.messageNeedsReplayCheck(i)&&!this.checkMessageAgainstRecvd(t,e))return mdx.messagesDropped++,!0;return!1},addMessageToSentList:function(e,t){if("error"!=e.action)for(t.sentList.push(parseInt(e.nonce,10)),t.sentList.sort(c);32<t.sentList.length;)t.sentList.shift()},addMessageToRecvdList:function(e,t){for(e.recvdList.push(parseInt(t,10)),e.recvdList.sort(c);32<e.recvdList.length;)e.recvdList.shift()},checkMessageAgainstSent:function(e,t){var i,n=parseInt(e.nonce,10);for(i in t.sentList)if(t.sentList[i]==n)return t.sentList.splice(i,1),!0;return mdx.error("Got response to unknown message, or already processed message "+n+". Sent: "+t.sentList),!1},messageNeedsReplayCheck:function(e){return"error"!=e},checkMessageAgainstRecvd:function(t,i){var n,r=parseInt(t.nonce,10),s=mdx.libapi.time.now();if(i.recvdList&&0<i.recvdList.length){if(s=Math.min(i.recvdList[0],s-3e5),s>r)return mdx.error("Replay detected: "+r+" older than "+i.recvdList[0],t),g(t,e),!1;for(n in i.recvdList)if(i.recvdList[n]==r)return mdx.error("Replay detected: "+r),g(t,e),!1}else{n=s-r;var a=Math.abs(a);if(a>3e5)return mdx.error("Replay detected: "+r+" is too old or to far in the future. Local time = "+s+" delta = "+n/1e3+"s"),g(t,e),!1}return!0}}}(),mdx.pair=function(){var e={1:"UNSUPPORTED VERSION",10:"INVALID CONTROLLER REQUEST",11:"SERVER ERROR",12:"TARGET INTERNAL ERROR",13:"SERVER UNAVAILABLE OR TIMEOUT",20:"CONTROLLER REQUEST HMAC_FAILURE",21:"CONTROLLER CTICKET EXPIRED",22:"CONTROLLER CTICKET CORRUPTED",30:"TARGET NOT IN PAIRING MODE",31:"TARGET ALREADY PAIRED",40:"TARGET NOT IN REGISTERING MODE",41:"TARGET ALREADY REGISTERED",42:"REG PAIRING IN PROGRESS",43:"PIN MISMATCH",99:"NETWORK ERROR"},t={MDX_PAIRING_UNKNOWN_VERSION:1,MDX_PAIRING_INVALID_CONTROLLER_REQUEST:10,MDX_PAIRING_SERVER_ERROR:11,MDX_PAIRING_TARGET_ERROR:12,MDX_PAIRING_SERVER_NOT_REACHABLE:13,MDX_PAIRING_CONTROLLER_HMAC_FAILURE:20,MDX_PAIRING_CONTROLLER_CTICKET_EXPIRED:21,MDX_PAIRING_CONTROLLER_CTICKET_CORRUPTED:22,MDX_PAIRING_NO_CTICKET:23,MDX_PAIRING_NOT_PAIRING:30,MDX_PAIRING_ALREADY_PAIRED:31,MDX_REGISTRATION_NOT_REGISTERING:40,MDX_REGISTRATION_ALREADY_REGISTERED:41,MDX_REGISTRATION_PAIRING_IN_PROGRESS:42,MDX_REGISTRATION_PIN_MISMATCH:43,MDX_PAIRING_NETWORK_ERROR:99},i={},n=function(e){mdx.trace("mdx.pair._cticketCb("+e.cticket.cticket+")"),""==e.cticket.cticket?(mdx.error("Invalid CTICKET retrieved. CTICKET was empty"),mdx.util.fireAPIEvent(mdx.pair,{type:mdx.pair.events.pairingresponse,result:mdx.COMPLETE,pairingContext:e.target.pairingContext,errorCode:t.MDX_PAIRING_NO_CTICKET,errorDesc:"empty cticket",match:"",remoteDevice:e.target.uuid,uniqueId:e.target.uniqueId})):e.target.pairingTransaction?e.target.pairingTransaction.end(function(t){delete e.target.pairingTransaction,mdx.libapi.security.beginTransaction(function(t){e.cb(t,e)})}):mdx.libapi.security.beginTransaction(function(t){e.cb(t,e)})},r=function(e,t){if(e){t.target.pairingTransaction=e,t.target.xid=mdx.nextTransactionId();var i="controlleruuid="+encodeURIComponent(mdx.libapi.device.getUUID())+"&nonce="+encodeURIComponent(t.target.xid);t.target.pairingTransaction.hmac(i,function(e){o(e,t)})}else mdx.error("Failed to begin a transaction for a pairing request"),delete t.target.targetPairingInProgress},s=function(e,t){e?(t.target.pairingTransaction=e,t.target.xid=mdx.nextTransactionId(),t.target.pairingTransaction.encrypt(t.data,function(e){a(e,t)})):(mdx.error("Failed to begin a transaction for a reg pair request"),delete t.target.targetPairingInProgress)},a=function(e,t){if(e){var i="action="+encodeURIComponent("regpairrequest")+"&nonce="+encodeURIComponent(t.target.xid)+"&pin="+encodeURIComponent(e);t.target.pairingTransaction.hmac(i,function(i){d(i,e,t)})}else mdx.error("RegPair request encryption failed: Received no data in the callback"),t.target.pairingTransaction.end(),delete t.target.pairingTransaction,delete t.target.targetPairingInProgress},o=function(e,t){var i={action:"pairingrequest",version:"1.0",controllerurl:mdx.getLocalURL(t.target.loc),nonce:t.target.xid,controlleruuid:mdx.libapi.device.getUUID(),pairdatahmac:e,cticket:t.cticket.cticket};t.target.targetPairingTime=Date.now(),t.target.targetPairingNonce=i.nonce,mdx.info("Pairing request sent to "+t.target.uuid),mdx.queueMessage({command:"pairingrequest",body:i,target:t.target.uuid,cb:function(e,i,n){n&&(t.target.pairingTransaction&&(t.target.pairingTransaction.end(),delete t.target.pairingTransaction),delete t.target.targetPairingInProgress,g(mdx.pair.events.pairingresponse,t.target.uuid))}})},d=function(e,t,i){function n(){i.target.targetPairingTime=Date.now(),i.target.targetPairingNonce=r.nonce,mdx.info("RegPair request sent to "+i.target,r),mdx.queueMessage({command:"regpairrequest",body:r,target:i.target.uuid,cb:function(e,t,n){n&&(i.target.pairingTransaction&&(i.target.pairingTransaction.end(),delete i.target.pairingTransaction),delete i.target.targetPairingInProgress,g(mdx.pair.events.regpairresponse,i.target.uuid))}})}var r={action:"regpairrequest",nonce:i.target.xid,pin:t,cticket:i.cticket.cticket,hmac:e,version:"2.0",controlleruuid:mdx.libapi.device.getUUID(),controllerurl:mdx.getLocalURL(i.target.loc)};i.target.msl?(e="controlleruuid="+encodeURIComponent(mdx.libapi.device.getUUID())+"&nonce="+encodeURIComponent(i.target.xid),mdx.trace("Producing Pair Data for MSL target",e,i.target.xid,mdx.libapi.device.getUUID()),i.target.pairingTransaction.hmac(e,function(e){mdx.trace("Got pair data HMAC",e),e?(r.pairdatahmac=e,n()):(mdx.error("HMAC signing failed for the MSL target pair data during reg pair request preperation"),i.target.pairingTransaction.end(),delete i.target.pairingTransaction,delete i.target.targetPairingInProgress)})):n()},c=function(e,t,i,n){t.grantdatahmac!=e?(mdx.error("Invalid hmac string in pairing response calculated: "+e+" received: "+t.grantdatahmac),i.pairingTransaction.end(),delete i.pairingTransaction,delete i.targetPairingInProgress):(mdx.trace("Received a pairing response",t),i.pairingTransaction.decrypt(t.controllersharedsecret,function(e){function r(){i.sharedsecret=e,i.pairingContext=t.grantdatahmac,i.registered=!0;var r={type:n,result:mdx.libapi.nccp.getCOMPLETE(),pairingContext:t.grantdatahmac,errorCode:0,errorDesc:"",match:t.controlleruserid==t.targetuserid?1:0,remoteDevice:i.uuid,uniqueId:i.uniqueId};mdx.device.storeDeviceMap(),mdx.util.fireAPIEvent(mdx.pair,r),mdx.info("MDX successfully paired with target",i.uuid)}i.pairingTransaction.end(),delete i.pairingTransaction,delete i.targetPairingInProgress,n==mdx.pair.events.regpairresponse&&i.registrationAcceptance==mdx.REGISTRATION_DARWIN_XPROFILE_V1?(i.restartNotificationReceived||(mdx.trace("The RegPair response will be held as pending until the target device has restarted: 5000ms"),i.restartTimeout=mdx.libapi.globals.setTimeout(function(){delete i.onTargetRestartedCb;var e={type:mdx.pair.events.regpairresponse,result:mdx.libapi.nccp.getCOMPLETE(),pairingContext:"",errorCode:"RESTART_NOTIFICATION_TIMEOUT",errorDesc:"The target device did not notify the controller that is was restarting within the timeout period so the pair request is aborted",match:0,remoteDevice:i.uuid,uniqueId:i.uniqueId};mdx.util.fireAPIEvent(mdx.pair,e)},5e3)),i.onTargetRestartedCb=r):r()}))},l=function(e){e.appPairingResponseTimeout&&(mdx.libapi.globals.clearTimeout(e.appPairingResponseTimeout),delete e.appPairingResponseTimeout)},u=function(e,t,i){void 0!==t.pairingTimer&&(mdx.libapi.globals.clearTimeout(t.pairingTimer),delete t.pairingTimer,mdx.libapi.nccp.abort(e),mdx.libapi.nccp.finish(e),i&&m([{errorcode:13,controlleruuid:e}],t,{eventType:mdx.pair.events.pairinggrant}))},m=function(i,n,r){var s,a=void 0,o=void 0;s=mdx.pair.events.pairinggrant;var d,c=mdx.libapi.nccp.finish;for(d=n.regPairWhitelistData||{controllercticket:""},n.regPairWhitelistData&&delete n.regPairWhitelistData,r&&(s=r.eventType||s,c=r.finishFn||c);0<i.length;){if(o=i.pop(),o.data&&o.data.controlleruuid){a=o.data;break}(void 0===a||a.result!==mdx.libapi.nccp.getNETWORK_ERROR())&&o.actionID||o.errorcode?a=o:o.result===mdx.libapi.nccp.getNETWORK_ERROR()&&(a=o)}a&&a.aborted||(c(n.uuid),void 0!==n.pairingTimer&&(mdx.libapi.globals.clearTimeout(n.pairingTimer),delete n.pairingTimer),n.pairingInProgress&&n.pairingRequestMessage?n.pairingInvalidated?(mdx.error("Target pairing has been invalidated",n),d=t.MDX_REGISTRATION_PAIRING_IN_PROGRESS,s={type:s,result:mdx.COMPLETE,pairingContext:"",actionID:0,message:"",bcp47:0,reasonCode:0,controlleruuid:n.uuid,controllerErrCode:d,controllerErrMesg:e[d]},mdx.util.fireAPIEvent(mdx.pair,s)):void 0===a||a.result===mdx.libapi.nccp.getNETWORK_ERROR()?(d=t.MDX_PAIRING_SERVER_NOT_REACHABLE,s={type:s,result:mdx.libapi.nccp.getNETWORK_ERROR(),pairingContext:"",actionID:a&&a.actionID?a.actionID:0,message:a&&a.message?a.message:"",bcp47:a&&a.bcp47?a.bcp47:0,reasonCode:a&&a.reasonCode?a.reasonCode:0,controlleruuid:n.uuid,controllerErrCode:d,controllerErrMesg:e[d]},mdx.util.fireAPIEvent(mdx.pair,s),mdx.error("NCCP pairing network error. Server not reachable")):(s={type:s,result:a.actionID?mdx.libapi.nccp.getACTION_ID():mdx.libapi.nccp.getCOMPLETE(),pairingContext:a.grantdatahmac?a.grantdatahmac:"",actionID:a.actionID?a.actionID:0,message:a.message?a.message:"",bcp47:a.bcp47?a.bcp47:0,reasonCode:a.reasonCode?a.reasonCode:0,controlleruuid:a.controlleruuid||n.uuid,controllerErrCode:a.errorcode?a.errorcode:0,controllerErrMesg:a.errorcode?e[a.errorcode]:"",cookies:a.cookies},mdx.trace("NCCP grant: ",a,s,a.targetsharedsecret,a.controllersharedsecret),a.actionID||a.errorcode?s.match=0:(s.match=a.controlleruserid==a.targetuserid?1:0,s.controllercticket=d.controllercticket,n.grantdatahmac=a.grantdatahmac,n.pairingContext=a.grantdatahmac,n.controlleruserid=a.controlleruserid,n.controllersharedsecret=a.controllersharedsecret,n.sharedsecret=a.targetsharedsecret,n.targetuserid=a.targetuserid),mdx.util.fireAPIEvent(mdx.pair,s),delete n.pairingRequestMessage,delete n.regPairingInProgress):mdx.error("Target not in pairing state- ignoring the pairing grant"))},g=function(e,i){var n,r=mdx.libapi.nccp.getNETWORK_ERROR(),s=t.MDX_PAIRING_NETWORK_ERROR;n=(n=mdx._remoteDeviceMap[i])?n.uniqueId:"",r={type:e,result:r,pairingContext:"",errorCode:s,errorDesc:"send failed, networking error",match:"",remoteDevice:i,uniqueId:n},mdx.error("MDX Send Network Error Event event=",r),mdx.util.fireAPIEvent(mdx.pair,r)},p=function(e,t,n,r){var s,a,o="pairingresponse",d=!0;a="1.0",r&&(o=r.responseType||o,a=r.version||a,d=!1),mdx._role!==mdx.TARGET?mdx.error("Invalid operation, cannot call sendPairingReject from CONTROLLER"):(s=mdx._remoteDeviceMap[e])?(l(s),y(s),r=mdx.libapi.device.getUUIDForRemoteDevice(e,s.loc),mdx.trace("Got uuid for controller",s,r),r||mdx.error("Empty uuid for device",e,s.loc),e={action:o,version:a,nonce:t,targetuuid:r,errorcode:n.errorcode?n.errorcode:1e3,errorstring:n.errormesg?n.errormesg:"Error Message was not passed by caller of sendPairingReject"},"1.0"===a&&(e.targetuserid=s.targetuserid?s.targetuserid:r),s.xid=e.nonce,mdx.queueMessage({command:o,body:e,target:s.uuid,cb:function(e,t,i){i?mdx.error("Failed to send "+o+" to "+s.uuid,t):mdx.trace("Sent "+o+" to "+s.uuid)}}),delete s.pairingInProgress,delete s.regPairingInProgress,delete s.pairingInvalidated,delete s.pairingResponseNonce,i[s.uuid]||(i[s.uuid]=0),a="Rejected pairing from "+s.uuid+" errorcode: "+e.errorcode+" errorstring: "+e.errorstring,2<++i[s.uuid]?(mdx.error(a),delete i[s.uuid]):mdx.trace(a),mdx._registrationMode===mdx.REGISTRATION_DARWIN_XPROFILE_V1&&(d?(mdx.trace("REGISTRATION_DARWIN_XPROFILE_V1 - Whitelisting controller for regpair attempt for 10000 ms"),s.regPairWhitelistData={canRegPair:!0,location:s.loc,controllercticket:s.pairingRequestMessage.cticket},s.regPairWindowTimeout=mdx.libapi.globals.setTimeout(function(){mdx.trace("Darwin XProfile V1 regpair whitelist time window exceeded before the controller issued a regpair - clearing whitelist data",s.uuid),delete s.regPairWhitelistData,delete s.regPairWindowTimeout},1e4)):(mdx.trace("REGISTRATION_DARWIN_XPROFILE_V1 - Clearing regPair whitelisting data on regPair rejection"),mdx.libapi.globals.clearTimeout(s.regPairWindowTimeout),delete s.regPairWindowTimeout,delete s.regPairWhitelistData))):mdx.error("Cannot send "+o+", remoteDevice "+e+" not found")},v=function(i,n){var r=mdx._remoteDeviceMap[i.controlleruuid],s="1.0",a=mdx.pair.events.pairingrequestreceived,o=null,d=n.fromurl;if(n&&(s=n.version||s,a=n.eventType||a,o=n.rejectFn||o),r?r.loc=d:r=mdx.device.addToRemoteDeviceMap(d,"",i.controlleruuid,i.controlleruuid,1,"",""),r.messagesRecvd++,mdx.guard.checkForReplay(r,i))mdx.error("Pairing request failed due to the replay check");else if(i.version!=s)mdx.error("Incorrect pairing protocol version. Expected "+s+" but got "+i.version),l(r),s=t.MDX_PAIRING_UNKNOWN_VERSION,s={action:"error",nonce:i.nonce,fromuuid:mdx.libapi.device.getUUIDForRemoteDevice(i.controlleruuid,r.loc),touuid:i.controlleruuid,errorcode:s,errorstring:e[s]},r.xid=s.nonce,mdx.queueMessage({command:"error",body:s,target:i.controlleruuid,cb:function(e,t,i){i&&mdx.error("Failed to send error to "+t.uuid,t)}}),delete r.pairingInProgress,delete r.pairingResponseNonce;else if(o&&o(r))mdx.trace("Pairing request was rejected by RejectFn");else{r.pairingInProgress=!0,r.regPairingInProgress=a===mdx.pair.events.regpairrequestreceived,r.pairingRequestMessage=i,r.pairingResponseNonce=i.nonce,l(r),r.appPairingResponseTimeout=mdx.libapi.globals.setTimeout(function(){var e=i.controlleruuid,n=mdx._remoteDeviceMap[e];n&&(mdx.warn("Timed out waiting for the app to allowPairing for "+e),p(e,n.pairingResponseNonce,{errorcode:t.MDX_PAIRING_SERVER_NOT_REACHABLE,errormesg:"APPLICATION DID NOT RESPOND"}))},1e4),mdx.trace("Sending (reg)pairrequestreceived event to the UI to accept / reject",a,i);var c={type:a,uuid:i.controlleruuid};a===mdx.pair.events.regpairrequestreceived&&mdx._registrationMode===mdx.REGISTRATION_DARWIN_XPROFILE_V1?(mdx.trace("REGISTRATION_DARWIN_XPROFILE_V1 - Clearing regPair whitelisting data on regPair request received"),mdx.libapi.globals.clearTimeout(r.regPairWindowTimeout),delete r.regPairWindowTimeout,r.regPairWhitelistData.canRegPair=!1,mdx.libapi.security.getCticket(function(e){c.controllercticket=i.cticket,c.targetcticket=e.cticket,mdx.util.fireAPIEvent(mdx.pair,c)})):mdx.util.fireAPIEvent(mdx.pair,c)}},x=function(i,n){var r;v(i,{version:"1.0",eventType:mdx.pair.events.pairingrequestreceived,fromurl:n,rejectResponseType:"pairingresponse",rejectFn:function(n){if(!mdx.libapi.registration.isRegistered())return r=t.MDX_PAIRING_NOT_PAIRING,p(i.controlleruuid,i.nonce,{errorcode:r,errormesg:e[r]},{responseType:"pairingresponse",version:"1.0"}),!0;for(var s in mdx._remoteDeviceMap)if(n=mdx._remoteDeviceMap[s],n.regPairingInProgress)return mdx.error("RegPair already in progress for another device",n),r=t.MDX_REGISTRATION_PAIRING_IN_PROGRESS,p(i.controlleruuid,i.nonce,{errorcode:r,errormesg:e[r]},{responseType:"pairingresponse",version:"1.0"}),!0;return!1}})},f=function(e,t){var i="1.0",n=e.controlleruserid,r=e.targetuserid,s=mdx.pair.events.pairingresponse,a="";t&&(i=t.version||i,n=t.controlleruserid||n,r=t.targetuserid||r,s=t.eventType||s,a=t.msgCanon||a),mdx.trace("Processing Pairing Response",e,"version",i,"controlleruserid",n,"targetuserid",r,"eventType",s,"msgCanon",a,"handlePairingResponseOptions",t),e.version!=i&&mdx.error("Incorrect pairing protocol version. Expected "+i+" but got "+e.version);var o=mdx._remoteDeviceMap[e.targetuuid];o?(o.messagesRecvd++,o.targetPairingInProgress?(i=Date.now()-o.pairingStartTime,mdx.trace({type:"Pairing Response",rtt:i}),e.nonce!=o.targetPairingNonce?mdx.error("Received pairingresponse with incorrect nonce from device "+e.targetuuid+" Expected "+o.targetPairingNonce+" got "+e.nonce,o):6e4<Date.now()-o.targetPairingTime?mdx.error("Received pairingresponse from device "+e.targetuuid+" too late "+e.nonce,o):(delete o.targetPairingTime,delete o.targetPairingNonce,o.controlleruserid=n,o.targetuserid=r,e.errorcode?(o.pairingTransaction&&(o.pairingTransaction.end(),delete o.pairingTransaction),delete o.targetPairingInProgress,mdx.util.fireAPIEvent(mdx.pair,{type:s,result:mdx.libapi.nccp.getERROR(),errorCode:e.errorcode,errorDesc:e.errorstring,remoteDevice:o.uuid,uniqueId:o.uniqueId,pairingContext:"",match:0})):(n=decodeURIComponent(a),mdx.trace("Trying to HMAC the pairing response",a,n),o.pairingTransaction.hmac(a,function(t){c(t,e,o,s)})))):mdx.error("Received pairingresponse when pairing not in progress from device "+e.targetuuid,o)):mdx.error("Received pairingresponse from unknown device "+e.targetuuid)},E=function(e,t){var i={version:"1.0",controlleruserid:e.controlleruserid,targetuserid:e.targetuserid,eventType:mdx.pair.events.pairingresponse,msgCanon:"controllersharedsecret="+encodeURIComponent(e.controllersharedsecret)+"&controlleruserid="+encodeURIComponent(e.controlleruserid)+"&controlleruuid="+encodeURIComponent(e.controlleruuid)+"&nonce="+encodeURIComponent(e.nonce)+"&targetuserid="+encodeURIComponent(e.targetuserid)+"&targetuuid="+encodeURIComponent(e.targetuuid)};mdx.trace("Received a Pair reply",e,i,t),f(e,i)},h=function(e,i){v(e,{version:"2.0",eventType:mdx.pair.events.regpairrequestreceived,fromurl:i,rejectResponseType:"regpairerror",rejectFn:function(n){return mdx._registrationMode!=mdx.REGISTRATION_ENABLED&&mdx._registrationMode!=mdx.REGISTRATION_DEFAULT_PIN&&mdx._registrationMode!=mdx.REGISTRATION_DARWIN_XPROFILE_V1?(p(e.controlleruuid,e.nonce,{errorcode:t.MDX_REGISTRATION_NOT_REGISTERING,errormesg:"NOT REGISTERING"},{responseType:"regpairerror",version:"2.0"}),!0):n.pairingInProgress?(p(e.controlleruuid,e.nonce,{errorcode:t.MDX_REGISTRATION_PAIRING_IN_PROGRESS,errormesg:"REGISTRATION ALREADY IN PROGRESS"},{responseType:"regpairerror",version:"2.0"}),!0):mdx._registrationMode!==mdx.REGISTRATION_DARWIN_XPROFILE_V1||"undefined"!=typeof n.regPairWhitelistData&&n.regPairWhitelistData.canRegPair&&n.regPairWhitelistData.location===i?!1:(p(e.controlleruuid,e.nonce,{errorcode:t.MDX_REGISTRATION_NOT_REGISTERING,errormesg:"DARWIN X-PROFILE V1 - REGISTRATION DENIED - NOT WHITELISTED"},{responseType:"regpairerror",version:"2.0"}),!0)}})},_=function(e,t){var i={version:"2.0",controlleruserid:e.userid,targetuserid:e.userid,eventType:mdx.pair.events.regpairresponse};i.msgCanon=mdx._remoteDeviceMap[e.targetuuid].msl?"controllersharedsecret="+encodeURIComponent(e.controllersharedsecret)+"&controlleruserid="+encodeURIComponent(e.userid)+"&controlleruuid="+encodeURIComponent(mdx.libapi.device.getUUID())+"&nonce="+encodeURIComponent(e.nonce)+"&targetuserid="+encodeURIComponent(e.userid)+"&targetuuid="+encodeURIComponent(e.targetuuid):"action=regpairreply&controllersharedsecret="+encodeURIComponent(e.controllersharedsecret)+"&nonce="+encodeURIComponent(e.nonce)+"&userid="+encodeURIComponent(e.userid),f(e,i)},S=function(e,t){f(e,{version:"2.0",eventType:mdx.pair.events.regpairresponse
})},I=function(e){if(mdx._role===mdx.TARGET)mdx.error("Pairing request made on the target - invalid operation",e);else if(e.target=mdx._remoteDeviceMap[e.remoteDeviceUUID],e.target)if(e.target.targetPairingInProgress)mdx.error("We are already in the process of pairing with the remote target",e);else if(mdx.libapi.registration.ping(),e.target.pairingContext&&""!=e.target.pairingContext){mdx.warn("Pairing already exists for the remote target. Please dePair and pair again",e.remoteDeviceUUID);var i={type:mdx.pair.events.pairingresponse,result:mdx.libapi.nccp.getCOMPLETE(),pairingContext:e.target.pairingContext,errorCode:t.MDX_PAIRING_ALREADY_PAIRED,errorDesc:"pairing already exists",match:"",remoteDevice:e.target.uuid,uniqueId:e.target.uniqueId};mdx.util.fireAPIEvent(mdx.pair,i)}else e.target.targetPairingInProgress=!0,e.target.pairingStartTime=Date.now(),mdx.libapi.security.getCticket(function(t){e.cticket=t,n(e)});else mdx.error("Remote device not found for pairing request",e)},T=function(e,t){if(mdx._role===mdx.CONTROLLER)mdx.error("mdx.pair._allowPairingInternal("+e+") : Invalid operation, cannot call allowPairing from CONTROLLER");else{var i=mdx._remoteDeviceMap[e];i?i.pairingInProgress&&i.pairingRequestMessage?(mdx.info("(Reg)Pairing has been allowed for remote device",e),l(i),t.pairingFn(i)):mdx.error("mdx.pair._allowPairingInternal("+e+") : remote device not pairing",i):mdx.error("mdx.pair._allowPairingInternal("+e+") : remote device not found")}},R=function(e){mdx.trace("NccpPair called",e);var t=e.pairingRequestMessage,i=t.controlleruuid;e.pairingTimer&&(mdx.warn("There is already a pairing request in progress for this uuid. Aborting the existing one and starting a new one",e),u(i,e,!1)),e.pairingInProgress=!0,e.pairingTimer=mdx.libapi.globals.setTimeout(function(){mdx.error("Did not receive a pairing response from NCCP in time. Aborting the pairing request",e),u(i,e,!0)},15e3),mdx.trace("Calling nccp.pair with a response timeout of 15000"),mdx.libapi.nccp.pair(t.cticket,i,t.pairdatahmac,t.nonce,mdx.libapi.device.getUUIDForRemoteDevice(i,e.loc),function(t){mdx.trace("Received a list of pairing grants from NCCP",t),m(t,e)})},D=function(i,n){var r,s=i.pairingRequestMessage,a=s.controlleruuid,o={eventType:mdx.pair.events.regpairgrant,finishFn:mdx.libapi.registration.mdxActivateFinish};if(mdx.libapi.registration.getCurrentDeviceAccount()){for(var d in mdx._remoteDeviceMap)mdx._remoteDeviceMap.hasOwnProperty(d)&&(r=mdx._remoteDeviceMap[d],r.pairingContext&&(mdx.info("DePairing from remote device as part of the current regpair process",r.friendlyName,r.pairingContext),mdx.pair.dePair(r.pairingContext)),r.pairingInProgress&&!r.regPairingInProgress&&(mdx.info("Invalidating the current in progress (reg)pair for the target",r.pairingInProgress,r.regPairingInProgress),r.pairingInvalidated=!0));s={targetUuid:mdx.libapi.device.getUUIDForRemoteDevice(a,i.loc),cticket:s.cticket,nonce:s.nonce,controllerPin:s.pin,pin:n,controllerUuid:a,registerDataHmac:s.hmac,pairDataHmac:s.pairdatahmac},i.pairingInProgress=!0,i.pairingTimer=mdx.libapi.globals.setTimeout(function(){void 0!==i.pairingTimer&&(mdx.libapi.globals.clearTimeout(i.pairingTimer),delete i.pairingTimer,delete i.regPairingInProgress,delete i.pairingInvalidated,mdx.libapi.registration.mdxActivateFinish(a),m([{errorcode:13,controlleruuid:a}],i,{eventType:mdx.pair.events.regpairgrant}))},15e3),mdx.trace("Calling registration.mdxActivate with a response timeout of 15000"),mdx.libapi.registration.mdxActivate(s,function(e){mdx.trace("Received a list of reg pairing grants",e),m(e,i,o)})}else mdx.error("No device account selected during target registration"),s=t.MDX_PAIRING_TARGET_ERROR,p(i.uuid,i.pairingResponseNonce,{errorcode:s,errormesg:e[s]},{responseType:"regpairerror",version:"2.0"})},A=function(e,t,i){var n=t.body;i?mdx.error("Failed to send (reg)pairing response to "+e.uuid+" Response: "+n,t):(mdx.device.storeDeviceMap(),mdx.info("Paired with "+e.uuid))},y=function(e){mdx.trace("dePairInternal",e.uuid),e.sessionContext&&(e.sessionContext.end(),delete e.sessionContext),e.sessionId=0,delete e.grantdatahmac,delete e.pairingContext,delete e.controlleruserid,delete e.sharedsecret,delete e.targetuserid,delete e.targetPairingInProgress,delete e.sendQueue,delete e.recvQueue};return{version:"1.0",ERRORS:t,events:{pairingrequestreceived:"pairingrequestreceived",pairinggrant:"pairinggrant",pairingresponse:"pairingresponse",regpairrequestreceived:"regpairrequestreceived",regpairgrant:"regpairgrant",regpairresponse:"regpairresponse"},_path:"mdx.pair",addEventListener:function(e,t){mdx.libapi.eventing.addListener(mdx.pair,e,t)},removeEventListener:function(e,t){mdx.libapi.eventing.removeListener(mdx.pair,e,t)},pairingRequest:function(e){mdx.info("MDX Pairing request: uuid=",e),I({remoteDeviceUUID:e,cb:r})},regPairRequest:function(e,t){mdx.info("MDX Reg Pairing request: uuid=",e,t),t?I({remoteDeviceUUID:e,data:t,cb:s}):mdx.error("No pin data to be encrypted for regPair")},allowPairing:function(e){T(e,{pairingFn:R})},allowRegPairing:function(e,t){T(e,{pairingFn:function(e){D(e,t)}})},sendPairingGrant:function(e){if(mdx._role!==mdx.TARGET)mdx.error("Invalid operation, cannot call sendPairingGrant on CONTROLLER");else{var t=mdx.device.getPairedDevice(e);t?(e=mdx.libapi.device.getUUIDForRemoteDevice(t.uuid,t.loc),e={action:"pairingresponse",version:"1.0",controllersharedsecret:t.controllersharedsecret,nonce:t.pairingResponseNonce,controlleruuid:t.uuid,targetuuid:e,controlleruserid:t.controlleruserid,targetuserid:t.targetuserid?t.targetuserid:e,grantdatahmac:t.grantdatahmac},t.xid=e.nonce,mdx.guard.addMessageToRecvdList(t,t.pairingResponseNonce),mdx.setUserId(t.targetuserid),delete t.pairingResponseNonce,delete t.controllersharedsecret,mdx.trace("MDX Send PairGrant response: data=",e),mdx.queueMessage({command:"pairingresponse",body:e,target:t.uuid,cb:A}),delete t.pairingInProgress,t.sessionContext&&(t.sessionContext.end(),t.sessionContext=null)):mdx.error('"'+e+'" is not a valid pairing context. Remote device not found',t)}},sendRegPairGrant:function(e){if(mdx._role!==mdx.TARGET)mdx.error("Invalid operation, cannot call sendPairingGrant on CONTROLLER");else{var t=mdx.device.getPairedDevice(e),i=mdx.libapi.registration.isRegistered();t?(e={action:"regpairreply",version:"2.0",controllersharedsecret:t.controllersharedsecret,nonce:t.pairingResponseNonce,targetuuid:mdx.libapi.device.getUUIDForRemoteDevice(t.uuid,t.loc),userid:t.controlleruserid,grantdatahmac:t.grantdatahmac},t.xid=e.nonce,mdx.guard.addMessageToRecvdList(t,t.pairingResponseNonce),mdx.setUserId(t.controlleruserid),mdx.discovery.setDeviceReplyHeader(mdx.X_MDX_REGISTERED,i?mdx.REGISTERED:mdx.NOT_REGISTERED),delete t.pairingResponseNonce,mdx.trace("MDX Send RegPairGrant response: data=",e),mdx.queueMessage({command:"regpairreply",body:e,target:t.uuid,cb:A}),delete t.pairingInProgress,t.sessionContext&&(t.sessionContext.end(),t.sessionContext=null)):mdx.error('"'+e+'" is not a valid pairing context. Remote device not found',t)}},sendPairingReject:function(e,t){var i=mdx._remoteDeviceMap[e];i?(mdx.trace("MDX Send PairReject response: errorObject=",t," uuid=",e),p(e,i.pairingResponseNonce,t)):mdx.error("mdx.pair.sendPairingReject Can't find device for uuid",e)},sendRegPairReject:function(e,t){var i=mdx._remoteDeviceMap[e],n=mdx.libapi.registration.isRegistered();i?(mdx.trace("MDX Send RegPairReject response: errorObject=",t," uuid=",e),p(e,i.pairingResponseNonce,t,{responseType:"regpairerror",version:"2.0"})):mdx.error("mdx.pair.sendRegPairReject Can't find device for uuid",e),mdx.discovery.setDeviceReplyHeader(mdx.X_MDX_REGISTERED,n?mdx.REGISTERED:mdx.NOT_REGISTERED)},dePair:function(e){if(mdx.info("MDX dePair called for pairing context: "+e),mdx.role===mdx.CONTROLLER)mdx.trace("Forcing dePairAll on the controller instead"),mdx.pair.dePairAll();else{var t=mdx.device.getPairedDevice(e);t?(y(t),mdx.device.storeDeviceMap(),mdx.info("Depaired from "+t.uuid)):mdx.error("dePair: "+e+" is not a valid pairing context")}},dePairAll:function(){for(var e in mdx._remoteDeviceMap){var t=mdx._remoteDeviceMap[e];t&&t.pairingContext&&y(t)}mdx.device.storeDeviceMap(),mdx.info("Depaired from all devices")},_handleIncomingMessage:function(e,t){var i={pairingrequest:x,pairingresponse:E,regpairrequest:h,regpairreply:_,regpairerror:S};i[e.action]&&i[e.action](e,t)},_endAllTransactions:function(){mdx.trace("MDX endAllTransactions was called. Clearing all inflight (reg)pairing requests");var e,t;for(e in mdx._remoteDeviceMap)t=mdx._remoteDeviceMap[e],t.pairingTransaction&&(mdx.trace("ending pairing transaction for "+t.uuid+" in mdx.pair._endAllTransactions"),t.pairingTransaction.end(),delete t.pairingTransaction,delete t.targetPairingInProgress,delete t.regPairingInProgress,delete t.pairingInProgress)}}}(),mdx.ping=function(){var e={},t={},i=function(e,i,n,r,s){n={action:"pingresponse",touuid:e,fromuuid:mdx.libapi.device.getUUIDForRemoteDevice(e,i),fromurl:mdx.getLocalURL(i),responseheaders:t,friendlyname:r,servicetype:mdx.ssdputil.serviceTypes.mdx+":2",id:s},n=mdx.guard.processOutgoingMessage(n),mdx.nextTransactionId(),mdx._sendMdxMessage(i+"/mdxping",n,function(t){"undefined"!=typeof t.body&&-1!=t.body.indexOf("error")&&mdx.warn("Failed to send mdx ping response to "+e+": "+t.body)})};return{_handleIncomingMessage:function(t,n){var r=mdx.ssdputil.getServiceType(t.servicetype),s=mdx.libapi.base64,a=mdx.libapi.utf8;"pingsearch"===t.action?r===mdx.ssdputil.serviceTypes.mdx&&(i(t.fromuuid,n,t.servicetype,s.encode(a.encode(mdx.libapi.device.getFriendlyName())),t.id),mdx._remoteDeviceMap.hasOwnProperty(t.fromuuid)&&(r=mdx._remoteDeviceMap[t.fromuuid],r.lastseen=new Date,r.inrange=!0,r.loc=t.fromurl)):"pingresponse"==t.action&&e[t.id]&&(e[t.id].cb(t.fromuuid,n,t.servicetype,t.friendlyname,t.responseheaders),delete e[t.id])},sendPing:function(t,i,n,r){var s=mdx.nextTransactionId();i={action:"pingsearch",fromuuid:mdx.libapi.device.getUUID(),fromurl:mdx.getLocalURL(t),servicetype:i,id:s},i=mdx.guard.processOutgoingMessage(i),n&&(e[s]={url:t,cb:n}),mdx._sendMdxMessage(t+"/mdxping",i,function(i){"undefined"!=typeof i.body&&-1!=i.body.indexOf("error")&&(delete e[s],mdx.warn("Failed to send mdx ping message to "+t+": "+i.body),r&&r())})},setDeviceReplyHeaders:function(e){var i,n;for(i in e)e.hasOwnProperty(i)&&(n=e[i],t[i]=n)}}}(),mdx.protocols=function(){function e(e){var t,n;for(t in i)if(i.hasOwnProperty(t)&&(n=i[t],n.proto===e))return n;return null}function t(){if(!r){r=!0;var e=mdx.libapi.mdx.getCapabilities();i=[{proto:"cast",capable:-1!=e.indexOf("cast"),enabled:!n.cast,requires:["cast"]},{proto:"ws",capable:-1!=e.indexOf("websocket")||-1!=e.indexOf("websocketclient"),enabled:!n.ws,requires:["websocket","websocketclient"]},{proto:"http",capable:-1!=e.indexOf("http"),enabled:!n.http,requires:["http"]}],mdx.trace("Initializing protocols "+JSON.stringify(i))}}var i=[],n={},r=!1;return{enable:function(i,r){t(),mdx.info("MDX "+(r?"Enabling":"Disabling")+" protocol "+i),r?delete n[i]:n[i]=!0;var s=e(i);s&&(s.enabled=r)},isEnabled:function(i){return t(),(i=e(i))?i.enabled:!1},decideProtocol:function(e,n){t();var r,s,a=null;for(s in i)if(i.hasOwnProperty(s)){r=i[s],r.proto===n.protocol&&(a=r);var o;if((o=r.enabled)&&(o=r.capable))e:{o=e;var d=r.requires,c=void 0,l=void 0;for(c in d)if(d.hasOwnProperty(c)&&(l=d[c],-1!=o.indexOf(l))){o=!0;break e}o=!1}if(o)return mdx.trace("Communication protocol decided: ",r.proto),r.proto}return a&&a.enabled&&a.capable?a.proto:(mdx.warn("Could not decide on a protocol both devices are capable of!"),n.protocol)},get protocols(){t();var e,n=[];for(e in i)n.push(i[e].proto);return n}}}(),mdx.session=function(){var e,t=0,i=0,n={MDX_SESSION_UNKNOWN_VERSION:1,MDX_SESSION_UNKNOWN_SENDER:2,MDX_SESSION_UNKNOWN_RECEIVER:3,MDX_SESSION_INVALID_NONCE:4,MDX_SESSION_INVALID_HMAC:5,MDX_SESSION_DECRYPTION_FAILED:6,MDX_SESSION_UNKNOWN_SENDER_USERID:8,MDX_SESSION_UNKNOWN_RECEIVER_USERID:9,MDX_SESSION_NETWORK_ERROR:10,MDX_SESSION_INVALID_SID:11,MDX_SESSION_NOT_READY:12,MDX_SESSION_START_SESSION_TIMEOUT:13},r=function(e,t,i,n){var r={action:"error",nonce:t,touuid:e,fromuuid:mdx.libapi.device.getUUIDForRemoteDevice(e,mdx._remoteDeviceMap[e].loc),errorcode:i,errorstring:n};mdx.error("Session error with "+e+" errorcode: "+i+" errorstring: "+n+" nonce: "+t),mdx.queueMessage({command:"session",body:r,target:e,cb:function(t,i,n){n&&mdx.error("Failed to send error message to "+e+" Response: "+i.body,i)}})},s=function(e,t,i,n){t={action:"error",nonce:t,touuid:i,fromuuid:mdx.libapi.device.getUUIDForRemoteDevice(i,e),errorcode:n.errorcode,errorstring:n.errorstring},t=mdx.guard.processOutgoingMessage(t),mdx.nextTransactionId(),mdx.warn("Session error with "+e+" errorcode: "+n.errorcode+" errorstring: "+n.errorstring),mdx._sendMdxMessage(e+"/session",t,function(t){(-1!=t.body.indexOf("error")||t.code&&400<=t.code)&&mdx.error("Failed to send error message to "+e,t)})},a=function(e,t){mdx.libapi.security.beginContext(e,t)},o=function(t,i,n){var r;r=mdx.guard.processOutgoingMessageBody(n),mdx.trace("Processing outgoing message",n),mdx.libapi.mdx.useSendSessionMessage(t)?(n=mdx.libapi.device.coerceUuidOfRemoteDevice(t.uuid),i={action:"session",version:"1.0",fromurl:mdx.getLocalURL(t.loc),fromuuid:mdx.libapi.device.getUUIDForRemoteDevice(t.uuid,t.loc),fromuserid:t.controlleruserid,touuid:n,touserid:t.targetuserid,nonce:i,ciphertext:"ciphertext"},t.sessionContext&&mdx.queueMessage({command:"session",body:i,target:i.touuid,sessionContext:t.sessionContext,plaintext:r,cb:S})):(n=mdx.libapi.device.coerceUuidOfRemoteDevice(t.uuid),i={fromuserid:t.controlleruserid,touuid:n,touserid:t.targetuserid,sessionContext:t.sessionContext,xid:i,sessionId:t.sessionId,remoteDeviceuuid:t.uuid,tourl:t.loc,remoteDevice:t},t.serviceType===mdx.ssdputil.serviceTypes.cast&&("undefined"==typeof e&&(e="1"==mdx.libapi.globals.queryParameter("plainsessionmessages")),e&&(i.plain=!0)),t.sendPending?(t.sendQueue||(t.sendQueue=[]),t.sendQueue.push([i,r])):m(i,r))},d=function(e){var i,n,r={sessionAction:"startSessionResponse",sessionId:++t};i=mdx.nextTransactionId(),o(e,i,r),n={type:mdx.session.events.sessionstart,pairingContext:e.pairingContext,sid:t},e.localSessionId=t,e.sessionId=t,mdx.libapi.globals.setTimeout(function(){mdx.util.fireAPIEvent(mdx.session,n)},0),mdx.info("Session started",n,e.friendlyName)},c=function(e,t){var n;e.sessionId=t,e.localSessionId=++i,e.startSessionResponseTimeout&&(mdx.libapi.globals.clearTimeout(e.startSessionResponseTimeout),delete e.startSessionResponseTimeout),delete e.startSessionAttempts,n={type:mdx.session.events.startSessionResponse,sid:i,pairingContext:e.pairingContext},mdx.libapi.globals.setTimeout(function(){mdx.util.fireAPIEvent(mdx.session,n)},0),mdx.info("Session started ",n,e.friendlyName)},l=function(e,t){var i;e.sessionContext&&(e.sessionContext.end(),e.sessionContext=null),i={type:mdx.session.events.sessionended,sid:mdx._role==mdx.CONTROLLER?e.localSessionId:e.sessionId},e.sessionId=0,e.localSessionId=0,mdx.libapi.globals.setTimeout(function(){mdx.util.fireAPIEvent(mdx.session,i)},0),mdx.info("Session ended by remote device ",i,e.uuid)},u=function(e){e.sendQueue&&0<e.sendQueue.length&&(e=e.sendQueue.shift(),m.apply(mdx.session,e))},m=function(e,t){e.sessionContext?(e.remoteDevice.sendPending=!0,e.plain?(e.plaintext=encodeURIComponent(t),g(e)):e.sessionContext.encrypt(t,function(i){if(t)e.ciphertext=i,g(e);else{var r={type:mdx.session.events.messagingerror,errorCode:n.MDX_SESSION_INVALID_SID,pairingContext:e.remoteDevice.pairingContext,sid:e.sessionId,transactionId:e.xid};mdx.libapi.globals.setTimeout(function(){mdx.util.fireAPIEvent(mdx.session,r)},0),delete e.remoteDevice.sendPending,u(e.remoteDevice)}})):(delete e.remoteDevice.sendPending,u(e.remoteDevice))},g=function(e){if(e.sessionContext){var t,i={action:"session",version:"1.0",fromurl:mdx.getLocalURL(e.tourl),fromuuid:mdx.libapi.device.getUUIDForRemoteDevice(e.touuid,e.tourl),fromuserid:e.fromuserid,touuid:e.touuid,touserid:e.touserid,nonce:e.xid};e.ciphertext?i.ciphertext=e.ciphertext:i.plaintext=e.plaintext,t=mdx._createCanonicalForm(i),e.sessionContext?e.sessionContext.hmac(t,function(n){i.hmac=n,mdx.trace("Got HMAC for session message",t,i),mdx.queueMessage({command:"session",body:i,target:i.touuid,cb:S,plain:e.plain}),delete e.remoteDevice.sendPending,u(e.remoteDevice)}):(delete e.remoteDevice.sendPending,u(e.remoteDevice))}else delete e.remoteDevice.sendPending,u(e.remoteDevice)},p=function(e){var t;e.recvQueue&&0<e.recvQueue.length&&(t=e.recvQueue.shift(),mdx.trace("Handling Queued Incoming Message [Q:"+e.recvQueue.length+" U:"+e.uuid+"]"),v(e,t))},v=function(e,t){var i,s,o,d=t.body,c=t.fromurl;e.recvPending=!0,"error"==d.action?(i={type:mdx.session.events.messagingerror,errorCode:d.errorcode,pairingContext:e.pairingContext,sid:mdx._role==mdx.CONTROLLER?e.localSessionId:e.sessionId,transactionId:d.nonce},mdx.libapi.globals.setTimeout(function(){mdx.util.fireAPIEvent(mdx.session,i)},0),delete e.recvPending,p(e)):(c&&(e.loc=c),e.sessionContext?(s=d.hmac,delete d.hmac,o=mdx._createCanonicalForm(d),mdx.libapi.mdx.useProcessSessionMessage(e)?mdx.libapi.mdx.processSessionMessage({context:e.sessionContext.context,xid:d.nonce,message:o,messageHmac:s,ciphertext:d.ciphertext,plaintext:d.plaintext?decodeURIComponent(d.plaintext):void 0,cb:function(t){var i=!1;t.hmac!==s?(f(t.hmac,s,e,d),i=!0):i=x(e,d),i?(delete e.recvPending,p(e)):h(t.plaintext,e,d,c)}}):e.sessionContext.hmac(o,function(t){E(t,s,e,d,c)})):e.sharedsecret?a(e.sharedsecret,function(i){e.sessionContext=i,e.sessionContext?v(e,t):(mdx.error("beginCustomContext failed",e),delete e.recvPending,p(e))}):(mdx.role===mdx.TARGET?r(e.uuid,d.nonce,n.MDX_SESSION_INVALID_HMAC,"MDX SESSION INVALID HMAC - no shared secret"):mdx.trace("Could not process session message from "+e.uuid+" because we don't have a sharedsecret"),delete e.recvPending,p(e)))},x=function(e,t){if(mdx.guard.checkForReplay(e,t))return!0;var i,s,a=t.touuid,o=t.nonce,d=!1;return mdx.guard.addMessageToRecvdList(e,t.nonce),a!=mdx.libapi.device.getUUIDForRemoteDevice(e.uuid,e.loc)?(i=n.MDX_SESSION_UNKNOWN_RECEIVER,s="MDX SESSION UNKNOWN RECEIVER UUID: "+a,d=!0):t.touserid!=e.targetuserid?(i=n.MDX_SESSION_UNKNOWN_RECEIVER_USERID,s="MDX SESSION UNKNOWN RECEIVER USERID: "+t.touserid,d=!0):t.fromuserid!=e.controlleruserid?(i=n.MDX_SESSION_UNKNOWN_SENDER_USERID,s="MDX SESSION UNKNOWN SENDER USERID: "+t.fromuserid,d=!0):"1.0"!=t.version&&(i=n.MDX_SESSION_UNKNOWN_VERSION,s="MDX SESSION UNKNOWN VERSION: "+t.version,d=!0),d&&r(e.uuid,o,i,s),d},f=function(e,t,i,n){var s=mdx._createCanonicalForm(n);mdx.error("hmac failure: msg="+s+" msg.hmac="+t+" calculated hmac="+e),r(i.uuid,n.nonce,mdx.session.ERRORS.MDX_SESSION_INVALID_HMAC,"MDX SESSION INVALID HMAC")},E=function(e,t,i,n,r){var s=!1;t!=e?(f(e,t,i,n),s=!0):s=x(i,n),s||!i.sessionContext?(delete i.recvPending,p(i)):n.ciphertext?i.sessionContext.decrypt(n.ciphertext,function(e){h(e,i,n,r)}):n.plaintext?h(decodeURIComponent(n.plaintext),i,n,r):mdx.error("Failed trying to HMAC the session message. No ciphertext or plaintext was specified")},h=function(e,t,i,s){if(""==e)mdx.error("decryption failed"),r(t.uuid,i.nonce,n.MDX_SESSION_DECRYPTION_FAILED,"MDX SESSION DECRYPTION FAILED");else if(e=mdx.guard.processIncomingMessageBody(i,e),t.loc=s,mdx._role===mdx.CONTROLLER&&(t.lastseen=Date.now()),e)if(t.messagesRecvd++,i=i.nonce,mdx.trace("Session Message: "+JSON.stringify(e)),"createSession"===e.sessionAction)d(t);else if("endSession"===e.sessionAction)l(t,e.sessionId);else if("startSessionResponse"===e.sessionAction)c(t,e.sessionId);else if("appMessage"===e.sessionAction){s=e.sessionId;var a=e.appAction;t.sessionId==s?mdx.messages.callMessageListeners("mdx.session",a,{sid:mdx._role===mdx.CONTROLLER?t.localSessionId:s,type:a,transactioId:i,transactionId:i,pairingContext:t.pairingContext,msgObject:e.appBody}):r(t.uuid,i,n.MDX_SESSION_INVALID_SID,"MDX SESSION INVALID SID")}else mdx.error("Unknown Session Message Action: sessionMessage=",e);delete t.recvPending,p(t)},_=function(e){var t,i;if(t=mdx._role===mdx.CONTROLLER?mdx.device.getRemoteDevicefromLocalSid(e):mdx.device.getRemoteDevicefromSid(e))if(0!=e){var n=function(e){mdx.trace("ending custom context"),e&&e.end()},r=function(e){e.sessionId=0,e.localSessionId=0,e.sessionContext=null};if(t.pairingContext)return e={sessionAction:"endSession",sessionId:t.sessionId},i=mdx.nextTransactionId(),t.responseCbs||(t.responseCbs={}),t.responseCbs[i]={args:t.sessionContext,cb:n},o(t,i,e),r(t),mdx.info("Session ended with "+t.uuid),i;n(t.sessionContext),r(t)}else mdx.warn("Cannot endSession: invalid session ID");else mdx.warn("Cannot endSession: sessionId '"+e+"' does not exist")},S=function(e,t,i){var r,s=e.responseCbs;if(s&&s[t.xid]){var a=s[t.xid].cb;a(s[t.xid].args),delete e.responseCbs[t.xid]}i?(r={type:mdx.session.events.messagingerror,errorCode:n.MDX_SESSION_NETWORK_ERROR,pairingContext:e.pairingContext?e.pairingContext:"",sid:e.sessionId?e.sessionId:0,transactionId:t.xid},mdx.error("Failed to process session message in the bridge: appEvent=",r,"Error Event=",t)):(r={type:mdx.session.events.messagedelivered,pairingContext:e.pairingContext,transactionId:t.xid},mdx._role===mdx.CONTROLLER&&(e.lastseen=Date.now())),mdx.libapi.globals.setTimeout(function(){mdx.util.fireAPIEvent(mdx.session,r)},0)};return{version:"1.0",ERRORS:n,events:{sessionstart:"sessionstart",startSessionResponse:"startSessionResponse",sessionended:"sessionended",messagingerror:"messagingerror",messagedelivered:"messagedelivered"},_path:"mdx.session",addEventListener:function(e,t){mdx.libapi.eventing.addListener(mdx.session,e,t)},removeEventListener:function(e,t){mdx.libapi.eventing.removeListener(mdx.session,e,t)},addMessageListener:function(e,t){mdx.messages.addMessageListener("mdx.session",e,t)},removeMesageListener:function(e,t){mdx.messages.removeMessageListener("mdx.session",e,t)},removeMessageListener:function(e,t){mdx.messages.removeMessageListener("mdx.session",e,t)},startSession:function(e){if(mdx.info("Starting session with pairing context: ",e),mdx._role!==mdx.CONTROLLER)mdx.error("Invalid operation, cannot call startSession from TARGET");else{var t=mdx.device.getPairedDevice(e);t?t.launchStatus!==mdx.discovery.LAUNCHED?mdx.error("Cannot start a session with a remote device that is not launched"):(0!=t.sessionId&&(t.sessionId=0,t.localSessionId=0),a(t.sharedsecret,function(e){var i=mdx.nextTransactionId();t.startSessionAttempts=t.startSessionAttempts||1,t.startSessionResponseTimeout=mdx.libapi.globals.setTimeout(function(){3<=t.startSessionAttempts?(mdx.error("Did not receive a start session response after 3 attempts"),delete t.startSessionResponseTimeout,delete t.startSessionAttempts,mdx.util.fireAPIEvent(mdx.session,{type:mdx.session.events.messagingerror,errorCode:n.MDX_SESSION_START_SESSION_TIMEOUT,pairingContext:t.pairingContext,transactionId:i})):(mdx.warn("Timed out waiting for start session reponse. MDX will retry"),t.startSessionAttempts++,mdx.session.startSession(t.pairingContext))},5e3),t.sessionContext=e,o(t,i,{sessionAction:"createSession"})})):mdx.error("pairing context "+e+" does not exist")}},sendMessage:function(e,t,i){function r(t,i){mdx.error("sendMessage error: "+t),i=i||n.MDX_SESSION_INVALID_SID;var r={type:mdx.session.events.messagingerror,errorCode:i,sid:e,transactionId:a,errorText:t};s&&(r.pairingContext=s.pairingContext,r.uuid=s.uuid),mdx.libapi.globals.setTimeout(function(){mdx.util.fireAPIEvent(mdx.session,r)},0)}var s,a=mdx.nextTransactionId();return mdx.isReady?0!=e&&t&&i?(s=mdx._role===mdx.CONTROLLER?mdx.device.getRemoteDevicefromLocalSid(e):mdx.device.getRemoteDevicefromSid(e))?0==s.sessionId?(r("No sessionId for remote device"),a):(o(s,a,{sessionAction:"appMessage",sessionId:s.sessionId,appAction:t,appBody:i}),a):(r("No remote device for sessionId"),a):(r("Invalid argument"),a):void r("MDX is not ready",n.MDX_SESSION_NOT_READY)},endSession:_,_handleIncomingMessage:function(e,t){mdx.trace("Received a message in mdxsession handler",e);var i=e.body,r=e.fromurl,a=mdx._remoteDeviceMap[i.fromuuid];if(a)if(a.recvPending){if(a.recvQueue){if(100<=a.recvQueue.length)return void mdx.error("Dropping message "+i.nonce+" because receive queue limit 100 reached or exceeded")}else a.recvQueue=[];a.recvQueue.push(e),r=(i=a.recvQueue?a.recvQueue[0]:null)?Date.now()-i.recvTime:0,i&&r>2e3&&(mdx.error("Dropping message "+i.body.nonce+" that's been processing for "+r+"ms [Q:"+a.recvQueue.length+" U:"+a.uuid+"]"),delete a.recvPending,p(a))}else v(a,e);else r?(mdx.warn("Session message from unknown remoteDevice: "+i.fromuuid+" will send error to "+r),s(r,i.nonce,i.fromuuid,{errorcode:n.MDX_SESSION_UNKNOWN_SENDER,errorstring:"Unknown UUID. Please try to pair before starting session"})):mdx.error("Failed to locate the message sender in the remote device map",i.fromuuid,mdx._remoteDeviceMap)},_endAllSessions:function(){var e,t;for(e in mdx._remoteDeviceMap)t=mdx._remoteDeviceMap[e],0<t.localSessionId&&_(t.localSessionId)},_clearAllSessions:function(){var e,t;for(e in mdx._remoteDeviceMap)t=mdx._remoteDeviceMap[e],t.sessionId=0,t.localSessionId=0,t.msgQue=[],t.sessionContext&&(mdx.trace("ending custom context for "+t.uuid+" in mdx.session._clearAllSessions"),t.sessionContext.end(),t.sessionContext=null)}}}(),mdx.util=function(){function e(e){(e=t.exec(e))?(this.protocol=e[1]||"",this.host=e[2]||"",this.port=e[3]||"",this.path=e[4]||"",this.query=e[5]||""):this.query=this.path=this.port=this.host=this.protocol=""}var t=/(http|ws|cast):\/\/([^/:]+)(:[0-9]+)?\/?([^?#&]*)([?].*)?/,i=/v=(.*)\r\npath=(.*)\r\nxid=(.*)\r\n/;return e.prototype.toString=function(){var e=this.protocol+"://"+this.host+this.port;return this.path&&(e+="/"+this.path),this.query&&(e+="?"+this.query),e},{MdxWebSocketMessage:function(e){var t;"string"==typeof e?(t=i.exec(e))?(this.version=t[1],this.path=t[2],this.xid=t[3],this.body=e.substr(e.indexOf("body=")+5)):(this.version=0,this.body=this.xid=this.path=""):"object"==typeof e&&(this.version=1,this.path=e.path,this.xid=e.xid,this.body=e.body),this.build=function(){return this.version=1,"v="+this.version+"\r\npath="+this.path+"\r\nxid="+this.xid+"\r\nbody="+this.body}},MdxUrl:e,getIpAndPortFromLocation:function(e){return e=new mdx.util.MdxUrl(e),e.host+e.port},getIpFromLocation:function(e){return new mdx.util.MdxUrl(e).host},getUUID:function(e){var t=e.indexOf("uuid:");return t>-1&&(e=e.substr(t+5),t=e.indexOf(":"),e=t>-1?e.substr(0,t):e),e},fireAPIEvent:function(e,t,i){mdx.trace("MDXJS API Event: "+t.type+" : "+JSON.stringify(t)),mdx.libapi.eventing.callListeners(e,t,i)},union:function(){var e,t,i,n,r={},s=[];for(e=0;e<arguments.length;e++)if(arguments.hasOwnProperty(e)&&(t=arguments[e],"object"==typeof t||"array"==typeof t))for(i in t)t.hasOwnProperty(i)&&(n=t[i],r[n]=n);for(e in r)r.hasOwnProperty(e)&&s.push(r[e]);return s},parseCookies:function(e){var t,i,n,r={};for(e="string"==typeof e?e.split(";"):"object"==typeof document&&document.cookie?document.cookie.split(";"):[],i=0;i<e.length;i++)(t=e[i].split("="))&&t[0]&&t[1]&&(n=decodeURIComponent(t[0].trim()),t=decodeURIComponent(t[1].trim()),r[n]=t);return r},htmlDecode:function(e){if(!document||!e)return e;var t=document.createElement("textarea");return t.innerHTML=e,t.innerText}}}(),mdx.broadcast=function(){return{addMessageListener:function(e,t){mdx.messages.addMessageListener("mdx.broadcast",e,t)},removeMessageListener:function(e,t){mdx.messages.removeMessageListener("mdx.broadcast",e,t)},sendMessage:function(e,t,i){function n(){if(s.length){var r=s.shift(),a={action:"broadcast",nonce:mdx.nextTransactionId(),fromuuid:mdx.libapi.device.getUUID(),fromurl:mdx.getLocalURL(r.loc),messageType:e,payload:t},a=mdx.guard.processOutgoingMessage(a);mdx._sendMdxMessage(r.loc+"/broadcast",a,function(t){-1!=t.body.indexOf("error")?mdx.warn("Failed to broadcast "+e+" message to "+r.uuid+": "+t.body):mdx.trace("Broadcast message successfully sent to "+r.uuid),n()})}else mdx.trace("All broadcast messages sent"),i&&mdx.libapi.globals.setTimeout(i,0)}mdx.trace("Broadcasting message to all remote devices that are in range",e,t);var r,s=[];for(r in mdx._remoteDeviceMap)if(mdx._remoteDeviceMap.hasOwnProperty(r)){var a=mdx._remoteDeviceMap[r];a.inrange&&s.push(a)}n(s)},handleIncomingMessage:function(e){mdx.trace("Processing incoming broadcast message",e),mdx._remoteDeviceMap[e.fromuuid]?mdx.messages.callMessageListeners("mdx.broadcast",e.messageType,e):mdx.trace("Dropping broadbast message as fromuuid is not a currently know device")}}}(),mdx.messages=function(){var e={};return{addMessageListener:function(t,i,n){t=t+"."+i,n&&(e[t]||(e[t]=[]),0<=e[t].indexOf(n)?mdx.warn("duplicate listener registered for "+t):(mdx.trace("added listener for "+t),e[t].push(n)))},removeMessageListener:function(t,i,n){return msgType=t+"."+i,n&&e[msgType]&&(t=e[msgType].indexOf(n),t>=0)?(mdx.trace("removed listener for "+msgType),void e[msgType].splice(t,1)):void mdx.warn("Could not remove listener for "+msgType)},callMessageListeners:function(t,i){var n=t+"."+i,r=0,s=Array.prototype.slice.call(arguments,2);if(logMsg="MDXJS Message Event: "+n+" : "+JSON.stringify(arguments),e[n])for(var n=e[n].slice(0),a=0;a<n.length;a++){var o=n[a];o&&(o.apply(this,s),r++)}logMsg+=" : "+r+" listeners called",r?mdx.trace(logMsg):mdx.warn(logMsg)}}}(),mdx.libapi={getPlatformVersion:function(){return"silverlight"},init:function(){return!0}},mdx.libapi.globals=function(){return{setInterval:function(){return window.setInterval.apply(window,arguments)},clearInterval:function(){return window.clearInterval.apply(window,arguments)},setTimeout:function(){return window.setTimeout.apply(window,arguments)},clearTimeout:function(){return window.clearTimeout.apply(window,arguments)},get url(){return window.location.href},get search(){return window.location.search.substr(1)},queryParameter:function(e){var t=this.search;if(0<t.length)for(var t=t.split("&"),i=e+"=",n=0;n<t.length;++n){if(t[n]===e)return"";if(0===t[n].lastIndexOf(i))return t[n].substr(i.length)}}}}(),mdx.libapi.mdx=function(){var e="0.0.0.0",t=0;return{_path:"mdxlib",getINITIALIZED:function(){return 1},getNOT_INITIALIZED:function(){return 0},getADVERTISING:function(){return 1},getNOT_ADVERTISING:function(){return 0},getDISCOVERING:function(){return 1},getNOT_DISCOVERING:function(){return 0},getInterfaceName:function(){},getLocalIPAddress:function(){return e},getNativeVersion:function(){return"1.0"},getState:function(){},init:function(e){mdx.libapi.websocketclient.onMessage=e,mdx.libapi.websocketclient.init(),mdx.libapi.castclient.onMessage=e;var t=this;mdx.libapi.castclient.init(function(e){this._mdxState=t.getINITIALIZED(),mdx.libapi.eventing.callListeners(t,{type:"statechanged",state:this._mdxState})})},deinit:function(){mdx.libapi.websocketclient.onMessage=void 0,mdx.libapi.websocketclient.deinit(),mdx.libapi.castclient.onMessage=void 0,mdx.libapi.castclient.deinit(),this._mdxState=this.getNOT_INITIALIZED(),mdx.libapi.eventing.callListeners(this,{type:"statechanged",state:this._mdxState})},configure:function(){},addEventListener:function(e,t){return mdx.libapi.eventing.addListener(this,e,t)},removeEventListener:function(e,t){return mdx.libapi.eventing.removeListener(this,e,t)},getLocalURL:function(){return"ws://"+this.getLocalIPAddress()},sendMessage:function(e){0===e.url.lastIndexOf("cast://",0)?mdx.libapi.castclient.sendMessage(e):(e.reqId=++t,mdx.libapi.websocketclient.sendMessage(e))},httpRequest:function(){},useSendSessionMessage:function(){return!1},useProcessSessionMessage:function(){return!1},addInterfaceName:function(){},interfaceChanged:function(t,i,n,r){i&&(e=n)},reveal:function(){},hide:function(){},getCapabilities:function(){var e=["mdx"];return"object"==typeof window&&"function"==typeof window.WebSocket&&e.push("websocketclient"),e},setDeviceReplyHeaders:function(){},startAdvertising:function(){},stopAdvertising:function(){}
}}(),mdx.libapi.discovery={setListener:function(e,t){this._listener=t},unsetListener:function(e,t){this._listener=void 0},setConfiguration:function(e){},enable:function(){mdx.libapi.castclient.addEventListener("devicefound",this._onDeviceFound),mdx.libapi.castclient.addEventListener("devicebyebye",this._onDeviceLost)},disable:function(e){mdx.libapi.castclient.removeEventListener("devicefound",this._onDeviceFound),mdx.libapi.castclient.removeEventListener("devicebyebye",this._onDeviceLost),e&&e()},launch:function(e,t,i,n,r){-1!=t.lastIndexOf("cast://",0)&&mdx.libapi.castclient.launch(t.substr(7),n,r)},stopNetflix:function(e,t){mdx.libapi.castclient.stopNetflix(e,t)},_onDeviceFound:function(e){var t=mdx.libapi.discovery;t._listener&&t._listener.onDeviceReply&&t._listener.onDeviceReply(e.serviceType,e.USN,e.location,void 0,e.friendlyName,e.castInfo)},_onDeviceLost:function(e){var t=mdx.libapi.discovery;mdx.trace("Lost device ",e),t._listener&&t._listener.onDeviceLost&&t._listener.onDeviceLost(e.serviceType,e.USN,e.reason)},_listener:void 0},mdx.libapi.device=function(){return{getUUID:function(){return netflix.player.mdx.getEsn()},getUUIDForRemoteDevice:function(e,t){return this.getUUID()},coerceUuidOfRemoteDevice:function(e){var t=mdx._remoteDeviceMap[e];return t&&mdx.ssdputil.serviceTypes.mdx in t.serviceUuids?t.serviceUuids[mdx.ssdputil.serviceTypes.mdx]:e}}}(),mdx.libapi.castclient={init:function(e){function t(t){mdx.trace("Cast client initialization succeeded",t),e({success:!0})}function i(t){mdx.error("Cast client initializatino failed",t),e({success:!1,error:t})}function n(){chrome.cast.timeout.requestSession=mdx.libapi.globals.queryParameter("mdxcasttimeout")||2e4,mdx.info("chrome.cast.timeout.requestSession set to "+chrome.cast.timeout.requestSession),this._sessionRequest=new chrome.cast.SessionRequest(s._applicationId),this._sessionRequest.dialRequest=new chrome.cast.DialRequest("Netflix","intent=sync");var e=new chrome.cast.ApiConfig(this._sessionRequest,s._extensionSessionListener,s._receiverListener,chrome.cast.AutoJoinPolicy.PAGE_SCOPED,chrome.cast.DefaultActionPolicy.CREATE_SESSION);mdx.trace("Initializing CAST API",e),chrome.cast.addReceiverActionListener(s._receiverActionListener),chrome.cast.initialize(e,t,i)}if(mdx.info("Initializing CBP cast client"),this._initialized)mdx.warn("CBP cast client already initialized");else{this._initialized=!0,window.addEventListener("message",this._windowMessageListener);var r=mdx.libapi.globals.queryParameter("castapplicationid");r&&(this._applicationId=r),mdx.trace("Using cast application id: "+this._applicationId),mdx.debug.enableProtocol("ws",!0);var s=this;chrome.cast&&chrome.cast.isAvailable?n():mdx.libapi.globals.setTimeout(n,1e3),this._initCastApiV1()}},get initialized(){return this._initialized},deinit:function(){mdx.info("Uninitializing CBP cast client"),this._initialized&&(this._initialized=!1)},addEventListener:function(e,t){mdx.trace("Adding CBP event listener",e),mdx.libapi.eventing.addListener(this,e,t)},removeEventListener:function(e,t){mdx.trace("Adding CBP event listener",e),mdx.libapi.eventing.removeListener(this,e,t)},_connectToMDxDeviceViaWebSockets:function(e,t){function i(e){mdx.trace("Attempting to create a websocket connection to the MDX endpoint on the target",e.loc);var t=mdx.libapi.castclient;"undefined"!=typeof t._mdxWsConnection&&(t._mdxWsConnection.close(),delete t._mdxWsConnection),t._mdxWsConnection=mdx.libapi.websocketclient.createWebSocket(e.loc,"mdx"),t._mdxWsConnection.onopen=function(i){mdx.info("WebSocket connection succeeded. MDX endpoint discovered"),mdx.libapi.globals.clearTimeout(e.launchTimeout),delete e.launchTimeout,mdx.libapi.globals.clearInterval(e.mdxConnectionInterval),delete e.mdxConnectionInterval,t._mdxWsConnection.close(),mdx.trace("Sending MDX Ping to discover the MDX UUID"),mdx.ping.sendPing(e.loc,mdx.ssdputil.serviceTypes.mdx,function(i){mdx.info("DIAL launch and websocket connection was successful to: "+i),e.serviceUuids[mdx.ssdputil.serviceTypes.mdx]=i,mdx._remoteDeviceMap[i]=e,t._sendRemoteDeviceReady(e.uuid),e.launchCallback&&e.launchCallback()},function(e){mdx.error("Encountered an error trying to ping the MDX target to retrieve the UUID",e)})},t._mdxWsConnection.onerror=function(e){delete t._mdxWsConnection}}var n=mdx.libapi.castclient,r=mdx._remoteDeviceMap[e];if(r.loc="ws://"+r.ip+":9080",r.protocol="ws",r.registrationAcceptance=mdx.REGISTRATION_DISABLED,r["volatile"]=!0,r.serviceUuids&&r.serviceUuids.length)for(var s in r.serviceUuids)r.serviceUuids.hasOwnProperty(s)&&delete mdx._remoteDeviceMap[r.serviceUuids[s]];mdx.trace("Updating remote device map",r),mdx.device.storeDeviceMap(),r.launchCallback=t,r.launchTimeout=mdx.libapi.globals.setTimeout(function(){delete r.launchTimeout,mdx.libapi.globals.clearInterval(r.mdxConnectionInterval),delete r.mdxConnectionInterval,r.launchCallback&&(r.launchCallback(!1,"Timed out waiting for the MDX endpoint with a DIAL launch.",mdx.util.htmlDecode(r.friendlyName),r.loc),delete r.launchCallback),n._sendRemoteDeviceReady(r.uuid,mdx.discovery.NOTLAUNCHED)},n._webSocketConnectTimeout),r.mdxConnectionInterval=mdx.libapi.globals.setInterval(function(){i(r)},n._webSocketConnectInterval),n._connectedDevices[e]={serviceType:mdx.ssdputil.serviceTypes.mdx}},launch:function(e,t,i){function n(){var r=mdx.libapi.castclient;chrome.cast.requestSession(function(n){mdx.info("Cast session request successful",n);var s=r._connectedDevices[e];"cast"===n.receiver.receiverType?(mdx.trace("Receiver type was cast - using cast message bus for communication"),s?(mdx.trace("Existing device found",s),r._toUSN(e),r._sendRemoteDeviceReady(e),i(!0,"Target is already launched")):(mdx.info("New device found - sending handshake"),r._sendCastHandShake(n,t,i))):"dial"===n.receiver.receiverType?(mdx.trace("Receiver type was dial - attempting to create the websocket connection to detect launch"),"undefined"!=typeof s&&delete r._connectedDevices[e],r._connectToMDxDeviceViaWebSockets(e,i)):(mdx.error("Received an unexpected receiverType in the session request response",n),i(!1,"Launch was successful, but the receiverType is unexpected so we cannot continue. Receiver Type = "+n.receiver.receiverType))},function(e){mdx.error("Got error for launch retry:",s,e),3>s?(++s,mdx.libapi.globals.setTimeout(n,1e3)):i(!1,e)},r._sessionRequest,decodeURIComponent(e))}var r=mdx._remoteDeviceMap[e];if("undefined"==typeof r||r.notLaunchable)mdx.trace("We cannot launch the specified device it doesn't exist or it is an NRDP target without an IP address",r),i(!1,"Target doesn't exist or is NRDP without an ip address and not launchable");else{var s=0;n()}},requestV2Session:function(){function e(i){var n=mdx.libapi.castclient;chrome.cast.requestSession(function(e){mdx.info("Cast v2 launch successful"),n._extensionSessionListener(e)},function(n){switch(n.code){case chrome.cast.ErrorCode.CANCEL:mdx.trace("User cancelled extension popup menu - no action to take");break;case chrome.cast.ErrorCode.API_NOT_INITIALIZED:case chrome.cast.ErrorCode.EXTENSION_MISSING:mdx.error("Cast V2 session request was made with the API was not initialized or the extension was not available",n);break;case chrome.cast.ErrorCode.RECEIVER_UNAVAILABLE:mdx.error("Cast V2 session request was made but no receivers were avaialable",n);break;case chrome.cast.ErrorCode.TIMEOUT:t>i?(mdx.info("Cast V2 session request timed out and we will attempt to retry and recover",n),mdx.libapi.globals.setTimeout(e(++i),1e3)):mdx.error("Cast V2 session request timed out after retries. Cannot continue.",n);break;case chrome.cast.ErrorCode.CHANNEL_ERROR:case chrome.cast.ErrorCode.SESSION_ERROR:case chrome.cast.ErrorCode.INVALID_PARAMETER:mdx.error("There was a problem with out Cast V2 session request",n)}})}var t=1;e(0)},stopNetflix:function(e,t){mdx.info("Attempting to stop netflix app",e);var i=mdx.libapi.castclient,n=i._connectedDevices[e.uuid];(n="undefined"==typeof n?!1:n.session)?n.stop(function(){mdx.info("Session stop request was successful"),t&&t(!0)},function(e){mdx.error("Failed to stop netflix on target device",e),t&&t(!1)}):(mdx.error("Unknown session in cast client stop",e,i._connectedDevices),t&&t(!1))},onMessage:null,sendMessage:function(e){var t=e.url,i=e.body,n=e.cb;mdx.trace("Trying to send a message in castclient",t,i);var r=/^cast:\/\/(.*)\/([^/]+)/.exec(t);if(!r)throw"Invalid url: "+t;e=r[1],r=r[2],this._connectedDevices[e]?this._connectedDevices[e].session.sendMessage(this._namespace,{body:i,path:r},function(e){mdx.trace("Send message successful",e),n({body:"ok",code:200})},function(e){mdx.error("GOT ERROR SENDING MESSAGE",e),n({body:"error: "+t+" "+e,code:400})}):n({body:"error: Unknown device "+t,code:400})},getCastSessionForRemoteDevice:function(e){return e=this._connectedDevices[e],e.serviceType===mdx.ssdputil.serviceTypes.cast?e.session:void 0},_extensionSessionListener:function(e){mdx.info("Detected a new session that was started from the cast extension",e);var t=mdx.libapi.castclient;if(t._extensionLaunchErrorTimeout&&(mdx.trace("Clearing launch error timeout"),mdx.libapi.globals.clearTimeout(t._extensionLaunchErrorTimeout)),"cast"===e.receiver.receiverType)mdx.trace("Receiver type was cast - using cast message bus for communication"),e.castV2Discovered=!0,t._sendCastHandShake(e);else if("dial"===e.receiver.receiverType){var i=encodeURIComponent(e.receiver.label);if("undefined"!=typeof mdx._remoteDeviceMap[i]&&mdx._remoteDeviceMap[i].inrange)mdx.trace("Receiver type was dial - attempting to create the websocket connection to detect launch"),t._connectToMDxDeviceViaWebSockets(i);else{var n={uuid:i,serviceType:mdx.ssdputil.serviceTypes.cast,friendlyName:mdx.util.htmlDecode(e.receiver.friendlyName)};e.receiver.ipAddress?(mdx.trace("Receiver type was DIAL and we were given the ip address in the launch response - attempting to create the websocket connection to detect launch"),n.ipAddress=e.receiver.ipAddress,t._sendDeviceFound(n),t._connectToMDxDeviceViaWebSockets(i)):(mdx.warn("The received type was DIAL, but we never had a DIAL discovery so we have no way to communicate so we have to bail"),t._sendDeviceFound(n),mdx._remoteDeviceMap[i].notLaunchable=!0,t._sendRemoteDeviceReady(i,mdx.discovery.NOTLAUNCHED))}}else mdx.error("Received an unexpected receiverType in the extension listener callback",e)},_toUSN:function(e){return"uuid:"+e+"::"+mdx.ssdputil.serviceTypes.cast},_receiverListener:function(e){e===chrome.cast.ReceiverAvailability.AVAILABLE?mdx.util.fireAPIEvent(mdx.discovery,{type:mdx.discovery.events.castDevicesAvailable}):mdx.util.fireAPIEvent(mdx.discovery,{type:mdx.discovery.events.castDevicesUnavailable})},_receiverActionListener:function(e,t){var i=mdx.libapi.castclient;switch(t){case chrome.cast.ReceiverAction.CAST:var n=parseInt(chrome.cast.timeout.requestSession)+500;mdx.trace("Setting launch error timeout for "+n+"ms"),i._extensionLaunchErrorTimeout=mdx.libapi.globals.setTimeout(function(){mdx.error("Cast launch timed out. Did not recieve a session or a cancellation within "+n+"ms")},n),mdx.util.fireAPIEvent(mdx.discovery,{type:mdx.discovery.events.castReceiverLaunching,UUID:encodeURIComponent(e.label),friendlyName:mdx.util.htmlDecode(e.friendlyName)});break;case chrome.cast.ReceiverAction.STOP:mdx.util.fireAPIEvent(mdx.discovery,{type:mdx.discovery.events.castReceiverStopping,UUID:encodeURIComponent(e.label),friendlyName:mdx.util.htmlDecode(e.friendlyName)}),i._extensionLaunchErrorTimeout&&(mdx.trace("Clearing launch error timeout"),mdx.libapi.globals.clearTimeout(i._extensionLaunchErrorTimeout))}},_sessionUpdateListener:function(e,t){mdx.trace("Cast session update info",e,t);var i=mdx.libapi.castclient;if(!t&&i._connectedDevices[e]){var n=i._toUSN(e);delete i._connectedDevices[e],mdx.libapi.eventing.callListeners(i,{type:"devicebyebye",serviceType:mdx.ssdputil.serviceTypes.cast,reason:mdx.discovery.MDX_DISCOVERY_DEVICE_COMMUNICATION_CHANNEL_CLOSED,USN:n}),n=i._discoveredDevices.indexOf(e),-1!=n&&i._discoveredDevices.splice(n,1),i._reinitCastApiV1()}},_sessionMessageListener:function(e,t,i){t=mdx.libapi.castclient;var n=t._connectedDevices[e];if(n){var r;try{r=JSON.parse(i)}catch(s){r={}}i="cast://"+e,"castHandShakeAck"===r.type?(t._toUSN(e),n.session.launchCallback&&(n.session.launchCallback({uuid:e}),delete n.session.launchCallback),t._sendDeviceFound({uuid:e,friendlyName:mdx.util.htmlDecode(n.session.receiver.friendlyName),registrationAcceptance:r.registrationAcceptance,serviceType:mdx.ssdputil.serviceTypes.cast,state:"running"}),t._sendRemoteDeviceReady(e)):"castHandShakeRequest"===r.type?(r={type:"castHandShake",uuid:e,controlleruuid:mdx.libapi.device.getUUID(),friendlyName:mdx.util.htmlDecode(n.session.receiver.friendlyName),acceptsPlainText:"1"==mdx.libapi.globals.queryParameter("plainsessionmessages")},n.session.sendMessage(t._namespace,r,function(e){mdx.info("Sent castHandShake from castHandShakeRequest successfully",e)},function(e){mdx.error("Error sending message handshake for castHandShakeRequest",e)})):t.onMessage&&(e=r.url.substr(r.url.lastIndexOf("/")+1),t.onMessage({type:"incomingmessage",received:new Date,headers:{host:i,client:i},url:"/"+e,body:r.body}))}},_sendRemoteDeviceReady:function(e,t){t="undefined"!=typeof t?t:mdx.discovery.LAUNCHED;var i=mdx._remoteDeviceMap[e];i.launchStatus=t,i={type:mdx.discovery.events.remoteDeviceReady,dialUsn:i.usn,uniqueId:i.usn,UUID:e,ip:i.ip,launchStatus:t},mdx.info("Sending remoteDeviceReady",i),mdx.util.fireAPIEvent(mdx.discovery,i)},_sendCastHandShake:function(e,t,i){mdx.trace("_sendCastHandshake",e);var n=encodeURIComponent(e.receiver.label);if(!this._connectedDevices[n]){e.launchCallback=i,this._connectedDevices[n]={serviceType:mdx.ssdputil.serviceTypes.cast,session:e};var r=this;e.addUpdateListener(function(e){r._sessionUpdateListener(n,e)}),e.addMessageListener(this._namespace,function(e,t){r._sessionMessageListener(n,e,t)}),t={type:"castHandShake",uuid:n,controlleruuid:mdx.libapi.device.getUUID(),friendlyName:mdx.util.htmlDecode(e.receiver.friendlyName),acceptsPlainText:"1"==mdx.libapi.globals.queryParameter("plainsessionmessages"),payload:t},mdx.trace("Sending cast handshake to remote device",this._namespace,t),e.sendMessage(this._namespace,t,function(e){mdx.trace("Cast: Sent message successfully",e)},function(e){mdx.trace("Cast: Got error sending message",e)})}},_sendDeviceFound:function(e){var t=mdx.libapi.castclient,i=mdx._remoteDeviceMap[e.uuid],n=e.usn||t._toUSN(e.uuid),r=e.location||"cast://"+e.uuid;e={type:"devicefound",uuid:e.uuid,USN:n,friendlyName:e.friendlyName,modelName:void 0,serviceType:e.serviceType,location:r,castInfo:{url:r,caps:e.caps||t._castCaps,launchStatus:t._connectedDevices[e.uuid]&&t._connectedDevices[e.uuid].session.castV2Discovered?mdx.discovery.LAUNCHED:mdx.discovery.NOTLAUNCHED,msl:!0,registrationAcceptance:e.registrationAcceptance||mdx.REGISTRATION_DEFAULT_PIN,state:e.state||"stopped",ip:e.ipAddress||i&&i.ip||e.uuid,canBeStopped:!0}},mdx.trace("devicefound",e),mdx.libapi.eventing.callListeners(t,e)},_v1ReceiverListener:function(e){mdx.trace("New v1 receiver notification",e);var t,i=mdx.libapi.castclient,n=i._discoveredDevices.slice(0);for(t=0;t<e.length;++t){var r=e[t],s=encodeURIComponent(r.id);-1==i._discoveredDevices.indexOf(s)?(i._discoveredDevices.push(s),i._sendDeviceFound({uuid:s,ipAddress:r.ipAddress,friendlyName:mdx.util.htmlDecode(r.name),serviceType:mdx.ssdputil.serviceTypes.cast,state:"stopped"})):(r=n.indexOf(s),-1!==r&&n.splice(r,1))}for(t=0;t<n.length;++t)i._discoveredDevices.splice(i._discoveredDevices.indexOf(n),1),e={type:"devicebyebye",serviceType:mdx.ssdputil.serviceTypes.cast,reason:mdx.discovery.MDX_DISCOVERY_DEVICE_NOT_RESPONDED_DIAL,USN:i._toUSN(n[t])},mdx.libapi.eventing.callListeners(i,e)},_reinitCastApiV1:function(){var e=mdx.libapi.castclient;e._castInstanceV1&&(e._castInstanceV1.removeReceiverListener(e._castActivityName,e._v1ReceiverListener),delete e._castInstanceV1),e._initCastApiV1()},_initCastApiV1:function(){var e=mdx.libapi.castclient;mdx.trace("Initializing cast v1 api",e._castActivityName),!e._castInstanceV1&&window.cast instanceof Object&&window.cast.Api instanceof Function&&"CastApi"===window.cast.NAME&&(e._castInstanceV1=new cast.Api,e._castInstanceV1.addReceiverListener(e._castActivityName,e._v1ReceiverListener))},_windowMessageListener:function(e){var t=mdx.libapi.castclient;e.data&&"Hello"===e.data.event&&"CastApi"===e.data.source&&t._initCastApiV1()},_initialized:!1,_castActivityName:"Netflix",_castInstanceV1:void 0,_sessionRequest:void 0,_extensionLaunchErrorTimeout:void 0,_path:"castclient",_applicationId:"CA5E8412",_namespace:"urn:x-cast:"+mdx.mdxServiceType,_connectedDevices:{},_discoveredDevices:[],_castCaps:["cast","msl"],_castCaps:["msl"],_webSocketConnectTimeout:3e4,_webSocketConnectInterval:3e3},mdx.libapi.eventing={addListener:function(e,t,i){if(!(i instanceof Function))throw"Invalid listener passed to mdx.libapi.eventing.addListener: "+t+" "+i;if(e.__events||(e.__events={}),e.__events[t]){if(-1!=e.__events[t].indexOf(i))return void mdx.warn("add: Duplicate listener for "+e._path+"."+t)}else e.__events[t]=[];e.__events[t].push(i)},removeListener:function(e,t,i){if(e.__events){var n=e.__events[t];if(n&&(i=n.indexOf(i),-1!=i))return void n.splice(i,1)}mdx.warn("remove: Listener not found for "+e._path+"."+t)},callListeners:function(e,t,i){if(e.__events){var n=e.__events[t.type];if(n){for(i=0;i<n.length;++i){if(!(n[i]instanceof Function))throw"THIS IS NOT A FUNCTION "+e._path+"."+t.type+" "+JSON.stringify(t)+" "+typeof n[i];n[i](t)}return}}i||mdx.info("No event listeners for "+e._path+"."+t.type)}},mdx.libapi.log=function(){var e=/mdxdebuglogging=true/.test(window.location);return e&&(mdx.logLevel=mdx.LOG_LEVEL.TRACE),{trace:function(t){return e&&console.log(t),netflix.player.log.trace(t)},info:function(t){return e&&console.log(t),netflix.player.log.info(t)},warn:function(t){return e&&console.log(t),netflix.player.log.warn(t)},error:function(t){return e&&console.log(t),netflix.player.log.error(t)}}}(),mdx.libapi.nccp=function(){return{getCOMPLETE:function(){return"COMPLETE"},getNETWORK_ERROR:function(){return"NETWORK_ERROR"},getACTION_ID:function(){return"ACTION_ID"},getERROR:function(){return"ERROR"}}}(),mdx.libapi.registration=function(){return{isRegistered:function(){return!0},ping:function(){},getCurrentDeviceAccount:function(){return 1},mdxActivate:function(){},mdxActivateFinish:function(){}}}(),mdx.libapi.response=function(){var e={};return{addResponseHandler:function(t,i){"function"==typeof i&&(e[t]={handler:i,issueTime:Date.now()})},dispatchResponse:function(t){var i,n=e[t.xid];"object"==typeof n?(i=Date.now()-n.issueTime,"function"==typeof n.handler&&(mdx.trace({type:t.type,xid:t.xid,body:t.body,rtt:i}),n.handler(t)),delete e[t.xid]):mdx.warn("unhandled "+t.type+" for: xid: "+t.xid+" body: "+t.body)}}}(),mdx.libapi.storage=function(){var e="undefined"!=typeof localStorage?localStorage:void 0,t="",i=function(){return""===t&&(t=mdx.util.parseCookies().NetflixId||""),t};return{setItem:function(t,n){if(t){var r={id:i(),data:n},r=r?JSON.stringify(r):"";e.setItem(t,r)}},getItem:function(t){if(t){var n=i(),r=e.getItem(t);t=JSON.parse(r)||{},r={},r=t.id===n?t.data:{}}return r}}}(),mdx.libapi.time=function(){return{now:function(){return 1e3*netflix.player.mdx.getServerEpoch()}}}(),mdx.libapi.security=function(){function e(e){this.context=e}return e.prototype.encrypt=function(e,t){t&&this.context.encrypt(e,function(e){t(e.encryptedDataAsn1Base64||e.mslEncryptionEnvelopeBase64)})},e.prototype.decrypt=function(e,t){t&&this.context.decrypt(e,function(e){t(e.text)})},e.prototype.hmac=function(e,t){t&&this.context.hmac(e,function(e){t(e.hmacBase64)})},e.prototype.end=function(e){e&&e()},{getCticket:function(e){netflix.player.mdx.createCryptoContext(function(t){e(t.success&&t.cryptoContext?{cticket:t.cryptoContext.cTicket}:"")})},beginTransaction:function(t){netflix.player.mdx.createCryptoContext(function(i){t(i.success&&i.cryptoContext?new e(i.cryptoContext):void 0)})},beginContext:function(t,i){netflix.player.mdx.createCryptoContextFromSharedSecret(t,function(t){i(t.success&&t.cryptoContext?new e(t.cryptoContext):void 0)})}}}(),mdx.libapi.websocketclient=function(){var e={},t=function(e){var t,i,n=e.queue;e.queue=[];for(t in n)n.hasOwnProperty(t)&&(i=new mdx.util.MdxWebSocketMessage(n[t]),e.ws.send(i.build()))},i=function(e){var t,i=e.queue;e.queue=[];for(t in i)i.hasOwnProperty(t)&&(e=i[t],mdx.libapi.response.dispatchResponse({type:"WebSocketResponse",xid:e.xid,body:"error - websocket not ready"}))},n={init:function(){},deinit:function(){var t,i,n=e;e=[];for(t in n)n.hasOwnProperty(t)&&(i=n[t],i.ws&&i.ws.close())},createWebSocket:function(e,t){return"object"==typeof nrdp&&"function"==typeof nrdp.WebSocket?new nrdp.WebSocket(e,t):"object"==typeof window&&"function"==typeof window.WebSocket?new window.WebSocket(e,t):void 0},onMessage:null,sendMessage:function(r){var s,a,o=r.body,d=r.cb,c=r.reqId,l=new mdx.util.MdxUrl(r.url);mdx.libapi.response.addResponseHandler(c,d),(s=e[l.host])?(a=s.ws)&&(s.queue.push({path:l.path,xid:c,body:o}),a.readyState===a.OPEN?t(s):a.readyState!=a.CLOSING&&a.readyState!=a.CLOSED||i(s)):(a=this.createWebSocket("ws://"+l.host+l.port,"mdx"),e[l.host]={ws:a,queue:[]},s=e[l.host],s.openTimeout=mdx.libapi.globals.setTimeout(function(){mdx.libapi.log.trace("Connection to "+l.host+" failed to open."),i(s),delete e[l.host]},6e3),s.queue.push({path:l.path,xid:c,body:o}),a.onopen=function(e){mdx.libapi.globals.clearTimeout(s.openTimeout),delete s.openTimeout,t(s),mdx.libapi.log.trace("Connection to "+l.host+" open.")},a.onerror=function(e){mdx.libapi.log.trace("WebSocket error: "+JSON.stringify(e))},a.onmessage=function(e){e=new mdx.util.MdxWebSocketMessage(e.data);var t="/"+e.path;"response"===e.path?mdx.libapi.response.dispatchResponse({type:"WebSocketResponse",xid:e.xid,body:e.body}):(mdx.libapi.websocketclient.sendMessage({url:a.url+"response",body:"body=status=ok",reqId:e.xid,cb:function(){}}),"function"==typeof n.onMessage&&n.onMessage({type:"incomingmessage",received:new Date,headers:{host:a.url},url:t,body:e.body}))},a.onclose=function(t){t=e[l.host],mdx.libapi.log.trace("Connection to "+l.host+" closed."),t&&t.ws===a&&(i(t),t.openTimeout&&mdx.libapi.globals.clearTimeout(t.openTimeout),delete e[l.host])})}};return n}(),mdx.libapi.base64=function(){var e="undefined"!=typeof nrdp&&"undefined"!=typeof nrdp.btoa&&"undefined"!=typeof nrdp.atob,t=!e&&"undefined"!=typeof window&&"undefined"!=typeof window.atob&&"undefined"!=typeof window.btoa;if(!e)for(var i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n={},r={},s={"=":0},a={"=":0},o=/\s*/g,d=RegExp("^["+i+"]*={0,2}$"),c=i.length;c--;)n[i[c]]=262144*c,r[i[c]]=4096*c,s[i[c]]=64*c,a[i[c]]=c;if(e)return{encode:function(e){return nrdp.btoa(e)},decode:function(e){return nrdp.atob(e)},encodeFromBytes:function(e){return nrdp.btoa(e)},decodeToBytes:function(e){return nrdp.atob(e,!0)},encodeToBytes:function(e){return nrdp.btoa(e,!1,!0)}};var e=function(e){e=e.replace(o,"");var t,i=e.length;if(0!=i%4||!d.test(e))throw Error("bad base64");for(var c=i/4*3-("="==e[i-1]?1:0)-("="==e[i-2]?1:0),l=new Uint8Array(c),u=0,m=0;i>u;)t=n[e[u++]]+r[e[u++]]+s[e[u++]]+a[e[u++]],l[m++]=t>>>16,c>m&&(l[m++]=t>>>8&255,c>m&&(l[m++]=255&t));return l},c=function(e){for(var t,n="",r=0,s=e.length,a=s-2;a>r;)t=65536*e[r++]+256*e[r++]+e[r++],n+=i[t>>>18]+i[t>>>12&63]+i[t>>>6&63]+i[63&t];return r==a?(t=65536*e[r++]+256*e[r++],n+=i[t>>>18]+i[t>>>12&63]+i[t>>>6&63]+"="):r==s-1&&(t=65536*e[r++],n+=i[t>>>18]+i[t>>>12&63]+"=="),n},l=function(e){var t,i,n,r,s=0,a=0,o="",o=[];if(!e)return e;do t=e.charCodeAt(s++),i=e.charCodeAt(s++),n=e.charCodeAt(s++),r=t<<16|i<<8|n,t=r>>18&63,i=r>>12&63,n=r>>6&63,r&=63,o[a++]="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(t)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(i)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(n)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(r);while(s<e.length);return o=o.join(""),e=e.length%3,(e?o.slice(0,e-3):o)+"===".slice(e||3)},u=function(e){for(var t=new ArrayBuffer(e.length),t=new Uint8Array(t),i=e.length-1;i>=0;--i)t[i]=e.charCodeAt(i);return t};return t?{encode:function(e){return window.btoa(e)},decode:function(e){return window.atob(e)},encodeFromBytes:c,decodeToBytes:e,encodeToBytes:function(e){return u(window.btoa(e))}}:{decode:function(e){var t,i,n,r,s,a=0,o=0;r="";var d=[];if(!e)return e;e+="";do t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(e.charAt(a++)),i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(e.charAt(a++)),r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(e.charAt(a++)),s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(e.charAt(a++)),n=t<<18|i<<12|r<<6|s,t=n>>16&255,i=n>>8&255,n&=255,64==r?d[o++]=String.fromCharCode(t):64==s?d[o++]=String.fromCharCode(t,i):d[o++]=String.fromCharCode(t,i,n);while(a<e.length);return r=d.join("")},encode:l,decodeToBytes:e,encodeFromBytes:c,encodeToBytes:function(e){return u(l(e))}}}(),mdx.libapi.utf8=function(){return{encode:function(e){if(null===e||"undefined"==typeof e)return"";e+="";var t,i,n="",r=0;t=i=0;for(var r=e.length,s=0;r>s;s++){var a=e.charCodeAt(s),o=null;if(128>a)i++;else if(a>127&&2048>a)o=String.fromCharCode(a>>6|192,63&a|128);else if(1&a)o=String.fromCharCode(a>>12|224,a>>6&63|128,63&a|128);else{if(1&a)throw new RangeError("Unmatched trail surrogate at "+s);if(o=e.charCodeAt(++s),1&o)throw new RangeError("Unmatched lead surrogate at "+(s-1));a=((1023&a)<<10)+(1023&o)+65536,o=String.fromCharCode(a>>18|240,a>>12&63|128,a>>6&63|128,63&a|128)}null!==o&&(i>t&&(n+=e.slice(t,i)),n+=o,t=i=s+1)}return i>t&&(n+=e.slice(t,r)),n},decode:function(e){var t=[],i=0,n=0,r=0,s=0,a=0;for(e+="";i<e.length;)r=e.charCodeAt(i),128>r?(t[n++]=String.fromCharCode(r),i++):r>191&&224>r?(s=e.charCodeAt(i+1),t[n++]=String.fromCharCode((31&r)<<6|63&s),i+=2):(s=e.charCodeAt(i+1),a=e.charCodeAt(i+2),t[n++]=String.fromCharCode((15&r)<<12|(63&s)<<6|63&a),i+=3);return t.join("")},encodeToUtf8Uint8Array:function(e){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return e;for(var t=new ArrayBuffer(3*e.length),t=new Uint8Array(t),i=0,n=e.length,r=0;n>r;r++){var s=e.charCodeAt(r);s>=1&&127>=s?t[i++]=s:(s>2047?(t[i++]=224|s>>12&15,t[i++]=128|s>>6&63):t[i++]=192|s>>6&31,t[i++]=128|s>>0&63)}return t.subarray(0,i)},decodeFromUtf8Uint8ArrayToString:function(e){var t="";e=e instanceof ArrayBuffer?new Uint8Array(e):e;for(var i=e.length,n=0;i>n;){var r=e[n++],s=r>>4;if(8>s)t+=String.fromCharCode(r);else if(s>=12&&13>=s)s=e[n++],t+=String.fromCharCode((31&r)<<6|63&s);else if(14==s)var s=e[n++],a=e[n++],t=t+String.fromCharCode((15&r)<<12|(63&s)<<6|(63&a)<<0)}return t},getBytes:function(e){var t,i=e.length;t=0;var n,r,s=0;for(n=i;n--;)r=e.charCodeAt(n),128>r?t++:t=2048>r?t+2:t+3;for(t=new Uint8Array(t),n=0;i>n;n++)r=e.charCodeAt(n),128>r?t[s++]=r:(2048>r?t[s++]=192|r>>>6:(t[s++]=224|r>>>12,t[s++]=128|r>>>6&63),t[s++]=128|63&r);return t},getString:function(e){for(var t,i=0,n=e.length,r="";n>i;){if(t=e[i++],128&t)if(192===(224&t))t=((31&t)<<6)+(63&e[i++]);else{if(224!==(240&t))throw Error("unsupported character");t=((15&t)<<12)+((63&e[i++])<<6)+(63&e[i++])}r+=String.fromCharCode(t)}return r}}}(),function(e,t){function i(e,t){return function(){return t.apply(e,arguments)}}var n=netflix.cadmium,r=n.UiEvents;netflix.mdx.Manager=function(){e.call(this),this.initialized=!1,this.initializing=!1,this.knownTargets={},this.activeTarget=null,this.mdxEnabled=!1,this.hasCastTargets=!1,this.EVENTS=Object.freeze({mdx_init:"init",mdx_initerror:"initerror",mdx_state:"mdxstate",READY:"READY",NOT_READY:"NOT_READY",sessionstartresponse:"startSessionResponse",sessionended:"sessionended",messagedelivered:"messagedelivered",messagingerror:"messagingerror",pairingdeleted:"pairingdeleted",pairingresponse:"pairingresponse",regpairresponse:"regpairresponse",devicefound:"devicefound",devicelost:"devicelost",remoteDeviceReady:"remoteDeviceReady",pairingtimeout:"pairingtimeout",sessiontimeout:"sessiontimeout",heartbeat:"heartbeat",castDevicesAvailable:"castdevicesavailable",castDevicesUnavailable:"castdevicesunavailable"}),this.MESSAGES=Object.freeze({HANDSHAKE:"HANDSHAKE",HANDSHAKE_ACCEPTED:"HANDSHAKE_ACCEPTED",PLAYER_CURRENT_STATE:"PLAYER_CURRENT_STATE",PLAYER_STATE_CHANGED:"PLAYER_STATE_CHANGED",PLAYER_CAPABILITIES:"PLAYER_CAPABILITIES",MESSAGE_IGNORED:"MESSAGE_IGNORED",PLAYER_PLAY:"PLAYER_PLAY",PLAYER_PAUSE:"PLAYER_PAUSE",PLAYER_RESUME:"PLAYER_RESUME",PLAYER_STOP:"PLAYER_STOP",PLAYER_SKIP:"PLAYER_SKIP",PLAYER_SET_CURRENT_TIME:"PLAYER_SET_CURRENT_TIME",PLAYER_SET_AUTO_ADVANCE:"PLAYER_SET_AUTO_ADVANCE",PLAYER_GET_CURRENT_STATE:"PLAYER_GET_CURRENT_STATE",PLAYER_GET_CAPABILITIES:"PLAYER_GET_CAPABILITIES",PLAYER_SET_VOLUME:"PLAYER_SET_VOLUME",DIALOG_SHOW:"DIALOG_SHOW",DIALOG_CANCEL:"DIALOG_CANCEL",DIALOG_RESPONSE:"DIALOG_RESPONSE",AUDIO_SUBTITLES_SETTINGS:"AUDIO_SUBTITLES_SETTINGS",AUDIO_SUBTITLES_CHANGED:"AUDIO_SUBTITLES_CHANGED",GET_AUDIO_SUBTITLES_SETTINGS:"GET_AUDIO_SUBTITLES",SET_AUDIO_SUBTITLES_SETTINGS:"SET_AUDIO_SUBTITLES"}),this.PLAYER_STATE=Object.freeze({PLAY:"PLAY",PROGRESS:"PROGRESS",PLAYING:"PLAYING",PAUSE:"PAUSE",STOP:"STOP",STALLED:"STALLED",AUTO_ADVANCE:"AUTO_ADVANCE",END_PLAYBACK:"END_PLAYBACK",FATAL_ERROR:"FATAL_ERROR"}),this.CALLBACKEVENT=Object.freeze({MDX_INITIALIZED:"MdxInitialized",SESSION_STATE_UNKNOWN:"SessionStateUnknown",SESSION_STATE_RECOVERED:"SessionStateRecovered",AUDIO_SUBTITLES_SETTINGS:"AudioSubtitlesSettingsReceived"}),this.MDX_LIST_CACHE_ID="mdx",this._heartbeat=Object.freeze({timeout:null,active:!1,interval:25e3})};var s=netflix.mdx.Manager.prototype=new e;s.mdxInitSuccessHandler=function(e){return this.initializing=!1,this.initialized=!0,t.log("MDXUI: mdxInitSuccessHandler",e),e&&e.status===this.EVENTS.READY?(t.log("MDXUI: mdxInitSuccessHandler","MDX.INIT SUCCEEDED"),this.mdxEnabled=!0,this.fireEvent(this.CALLBACKEVENT.MDX_INITIALIZED),this.fireEvent(this.EVENTS.READY),this.startHeartbeat(),void t.log("MDXUI: Manager.mdxInitSuccessHandler","mdx and manager now ready")):(t.log("MDXUI: Manager.mdxInitSuccessHandler","INIT EVENT NOT READY"),void this.mdxInitErrorHandler(e))},s.mdxInitStateHandler=function(e){t.log("MDXUI: Manager.mdxInitStateHandler","event.status="+e.status),e.status===this.EVENTS.READY?this.mdxEnabled&&(this.fireEvent(this.EVENTS.READY),this.startHeartbeat()):e.status===this.EVENTS.NOT_READY?this.mdxInitErrorHandler(e):t.log("MDXUI: Manager.mdxInitStateHandler","unknown event status:"+e.status)},s.mdxInitErrorHandler=function(e){t.log("MDXUI: Manager.mdxInitErrorHandler","type="+e.type+", code="+e.errorCode+", desc="+e.errorDesc),this.initializing=!1,this.mdxEnabled=!1,this.stopHeartbeat(),this.fireEvent(this.EVENTS.NOT_READY)},s.mdxDeviceFoundHandler=function(e){t.log("MDXUI: Manager.mdxDeviceFoundHandler",Object.keys(this.knownTargets),e);var i=e.ip;if(this.mdxEnabled||this.mdxInitSuccessHandler({status:this.EVENTS.READY}),this.knownTargets[i])this.knownTargets[i].foundAgainHandler();else{t.log("MDXUI: Manager.mdxDeviceFoundHandler","adding target",e.UUID);var n=mdx.discovery.getRemoteDeviceList(),r=this,s=!1;n.some(function(t){return t.ip===i?(t.activated=e.activated,t.ip=i,t.isDial=e.serviceType===mdx.discovery.serviceTypes.dial,r.knownTargets[i]=new netflix.mdx.Target(t),s=!0,!0):void 0}),s&&(this.knownTargets[i].init(),this.fireEvent(this.EVENTS.devicefound,[this.knownTargets[i]]))}},s.mdxDeviceLeftHandler=function(e){t.log("MDXUI: Manager.mdxDeviceLeftHandler",this.knownTargets,e);var i,n=mdx.discovery.getRemoteDeviceList(),r=!1,s=e.devicelist,a=this;s.forEach(function(t){for(i in a.knownTargets)a.knownTargets.hasOwnProperty(i)&&(i=a.knownTargets[i],i._config&&i._config.uuid&&i._config.uuid===t&&(r=n.some(function(t){
return t.ip===i._config.ip?(a.fireEvent(a.EVENTS.devicelost,[e.devicelist,t]),!0):void 0}),r||(delete a.knownTargets[i._config.ip],a.fireEvent(a.EVENTS.devicelost,[e.devicelist]))))})},s.heartbeatHandler=function(){t.log("MDXUI: Manager.heartbeatHandler called, firing event for targets"),this.fireEvent(this.EVENTS.heartbeat),this._heartbeat.timeout=window.setTimeout(this.heartbeatHandlerDelegate,this._heartbeat.interval)},s.startHeartbeat=function(){t.log("MDXUI: Manager.startHeartbeat","active already?: "+this._heartbeat.active),this._heartbeat.active||(this.heartbeatHandlerDelegate=i(this,this.heartbeatHandler),this._heartbeat.timeout=window.setTimeout(this.heartbeatHandlerDelegate,this._heartbeat.interval),this._heartbeat.active=!0)},s.stopHeartbeat=function(){t.log("MDXUI: Manager.stopHeartbeat","active already?: "+this._heartbeat.active),this._heartbeat.active&&(window.clearTimeout(this._heartbeat.timeout),this._heartbeat.active=!1)},s.remoteDeviceReadyHandler=function(e){t.log("MDXUI: Manager.remoteDeviceReady");var i=this.getTargetWithUuid(e.UUID);this.setActiveTarget(e.UUID),i.updateLaunchStatus(e.launchStatus),n.ui.master.toggleMdxMode(!0,i)},s.castDevicesAvailableHandler=function(){t.log("MDXUI: Manager.castDevicesAvailable"),this.fireEvent(this.EVENTS.castDevicesAvailable)},s.castDevicesUnavailableHandler=function(){t.log("MDXUI: Manager.castDevicesUnavailable"),this.fireEvent(this.EVENTS.castDevicesUnavailable)},s.showCastDialog=function(){mdx.libapi.castclient.requestV2Session()},s.start=function(){this.initialized||this.initializing||("object"==typeof mdx?(t.log("MDXUI: Manager.start","mdx present"),this.initializing=!0,this.knownTargets={},this.activeTarget=null,this.mdxInitSuccessHandlerDelegate=i(this,this.mdxInitSuccessHandler),this.mdxInitErrorHandlerDelegate=i(this,this.mdxInitErrorHandler),this.mdxInitStateHandlerDelegate=i(this,this.mdxInitStateHandler),this.mdxDeviceFoundHandlerDelegate=i(this,this.mdxDeviceFoundHandler),this.mdxDeviceLeftHandlerDelegate=i(this,this.mdxDeviceLeftHandler),this.castDevicesAvailableDelegate=i(this,this.castDevicesAvailableHandler),this.castDevicesUnavailableDelegate=i(this,this.castDevicesUnavailableHandler),this.remoteDeviceReadyHandlerDelegate=i(this,this.remoteDeviceReadyHandler),mdx.addEventListener(this.EVENTS.mdx_init,this.mdxInitSuccessHandlerDelegate),mdx.addEventListener(this.EVENTS.mdx_initerror,this.mdxInitErrorHandlerDelegate),mdx.addEventListener(this.EVENTS.mdx_state,this.mdxInitStateHandlerDelegate),mdx.discovery.addEventListener(this.EVENTS.devicefound,this.mdxDeviceFoundHandlerDelegate),mdx.discovery.addEventListener(this.EVENTS.devicelost,this.mdxDeviceLeftHandlerDelegate),mdx.discovery.addEventListener(this.EVENTS.castDevicesAvailable,this.castDevicesAvailableDelegate),mdx.discovery.addEventListener(this.EVENTS.castDevicesUnavailable,this.castDevicesUnavailableDelegate),mdx.discovery.addEventListener(this.EVENTS.remoteDeviceReady,this.remoteDeviceReadyHandlerDelegate),t.log("MDXUI: Manager.start","call mdx.init: "+mdx.CONTROLLER),n.objects.setMdxManager(this),n.objects.videoSession().init(function(e){var t={};mdx.init(mdx.CONTROLLER,t),r.fireEvent(r.knownEvents.MDX_LOADED)})):t.log("MDXUI: Manager.start","mdx not available, ignored"))},s.stop=function(){return"object"!=typeof mdx?void t.log("MDXUI: Manager.stop","mdx not available, ignored"):(t.log("MDXUI: Manager.stop"),this.initializing=!1,this.stopHeartbeat(),mdx.removeEventListener(this.EVENTS.mdx_init,this.mdxInitSuccessHandlerDelegate),mdx.removeEventListener(this.EVENTS.mdx_initerror,this.mdxInitErrorHandlerDelegate),mdx.removeEventListener(this.EVENTS.mdx_state,this.mdxInitStateHandlerDelegate),mdx.discovery.removeEventListener(this.EVENTS.devicefound,this.mdxDeviceFoundHandlerDelegate),mdx.discovery.removeEventListener(this.EVENTS.devicelost,this.mdxDeviceLeftHandlerDelegate),mdx.discovery.removeEventListener(this.EVENTS.remoteDeviceReady,this.remoteDeviceReadyHandlerDelegate),this.fireEvent(this.EVENTS.NOT_READY),this.knownTargets={},void(this.initialized&&(mdx.exit(),this.initialized=!1)))},s.getTarget=function(e){return this.knownTargets[e]||null},s.getTargetWithUuid=function(e){var t;for(t in this.knownTargets)if(this.knownTargets.hasOwnProperty(t)&&this.knownTargets[t]._config.uuid===e)return this.knownTargets[t]},s.getTargetList=function(){var e,t=[],i={};for(e in this.knownTargets)this.knownTargets.hasOwnProperty(e)&&t.push(this.knownTargets[e]);return t.sort(function(e,t){var i=e._config.friendlyName,n=t._config.friendlyName;return i>i?-1:i>n?1:0}),t.forEach(function(e){i[e._config.ip]=e}),i},s.getActiveTarget=function(){return this.activeTarget},s.setActiveTarget=function(e){this.activeTarget=this.knownTargets[e]},netflix.mdx.Manager.INSTANCE=new netflix.mdx.Manager}(netflix.mdx.Eventable,netflix.cadmium.logging),function(e,t,i,n){function r(e,t){return function(){return t.apply(e,arguments)}}var s=mdx.discovery,a=netflix.I18n,o=netflix.mdx.playerutils;netflix.mdx.Target=function(t){e.call(this),this.MdxManager=netflix.mdx.Manager.INSTANCE,this.EVENTS={DIAL_READY:"dialready",ACTIVATED:"activated",MDX_READY:"ready",NOT_READY:"notready",UPDATED_PLAYER_STATE:"updateplayerstate",UPDATED_PLAYER_CAPABILITIES:"updatedcapabilites",MESSAGE_TO_TARGET:"messagetotarget",MESSAGE_FROM_TARGET:"messagefromtarget",DIALOG_SHOW:"showdialog",DIALOG_CANCEL:"canceldialog",AUDIO_SUBTITLES_SETTINGS:"audiosubtitlesettingschange"},this._config={uuid:t.uuid,dialUuid:t.dialUuid,dialUsn:t.dialUsn,activated:1===t.activated,registrationAcceptance:t.registrationAcceptance,ip:t.ip,friendlyName:t.friendlyName||a.get("mdx-device-name"),controllerEsn:t.controllerEsn||!1},this._pairing={paired:!1,context:null,listenerAdded:!1,retry:{current:0,max:2,timeout:null},types:{regpair:"regpair",pair:"pair"},messageQueue:[]},this._session={id:null,listenerAdded:!1,handshakeAccepted:!1,retry:{current:0,max:2,timeout:null},stateUncertain:!1},this._dial={messageQueue:[],launchStatus:t.launchStatus,retry:{current:0,max:1,timeout:null}},this._capabilities={transactionId:null},this._currentState={state:null,transactionId:null},this._messages={}};var d=netflix.mdx.Target.prototype=new e;d.init=function(){(this._config.uuid||this._config.dialUuid)&&(this._pairing.context=mdx.device.getPairingContextFromUuid(this._config.uuid))},d.foundAgainHandler=function(){t.uilog("MDXUI: Target-"+this._config.friendlyName+".foundAgainHandler");var e=mdx.discovery.getRemoteDeviceList(),i=this;e.some(function(e){return e.ip===i._config.ip?(i._config.uuid=e.uuid,i._dial.launchStatus=e.launchStatus,i._pairing.context=e.pairingContext,i._config.registrationAcceptance=e.registrationAcceptance,!0):void 0}),this._dial.launchStatus===mdx.discovery.LAUNCHED&&this._dial.messageQueue.length>0&&this.startPair(this._pairing.types.pair)},d.deinit=function(){this._config=null,this._pairing=null,this._session=null,this._capabilities=null,this._currentState=null},d.devicelostHandler=function(e,t){var i=this;e&&e.some(function(e){return e===i._config.uuid?(t&&(i._config={uuid:t.uuid,dialUuid:t.dialUuid,dialUsn:t.dialUsn,activated:!0,registrationAcceptance:t.registrationAcceptance,ip:t.ip,friendlyName:t.friendlyName||a.get("mdx-device-name"),controllerEsn:t.controllerEsn||!1},i._dial={messageQueue:[],launchStatus:t.launchStatus,retry:{current:0,max:1,timeout:null}}),i._session&&i._session.id?i.sessionEndedHandler({sid:i._session.id}):i.fireEvent(i.EVENTS.NOT_READY,[i]),!0):void 0})},d.pairingSuccessHandler=function(){t.uilog("MDXUI: Target-"+this._config.friendlyName+".pairingSuccessHandler"),window.clearTimeout(this._pairing.retry.timeout),this.addSessionListeners(),this._pairing.context?(t.uilog("MDXUI: Target-"+this._config.friendlyName+".pairingSuccessHandler, starting session"),this._pairing.paired=!0,n.startSession(this._pairing.context)):t.uilog("MDXUI: Target-"+this._config.friendlyName+".pairingSuccessHandler","Attempted to start session without a pairing",this._pairing)},d.pairingResponseHandler=function(e){t.uilog("MDXUI: Target-"+this._config.friendlyName+".pairingResponseHandler","event",e),window.clearTimeout(this._pairing.retry.timeout);var n,r=e.remoteDevice,s=e.errorCode,a=+s,d=this,c=this.MdxManager.EVENTS;if(e.type!==c.pairingresponse&&e.type!==c.regpairresponse||r!==this._config.uuid)t.uilog("MDXUI: Target-"+this._config.friendlyName+".pairingResponseHandler","error pairing",e);else if(t.uilog("MDXUI: Target-"+this._config.friendlyName+".pairingResponseHandler","Valid Event Type"),e.result===mdx.COMPLETE||"ERROR"===e.result)if(t.uilog("MDXUI: Target-"+this._config.friendlyName+".pairingResponseHandler","Valid Event Result"),s&&a!==i.ERRORS.MDX_PAIRING_ALREADY_PAIRED)if("USER_MISMATCH"===s||s==i.ERRORS.MDX_PAIRING_NOT_PAIRING||s==i.ERRORS.MDX_REGISTRATION_PAIRING_IN_PROGRESS)t.uilog("MDXUI: Target-"+this._config.friendlyName+".pairingResponseHandler","Pair Error="+s),this.retryPair(this._pairing.types.regpair);else{switch(t.uilog("MDXUI: Target-"+this._config.friendlyName+".pairingResponseHandler","Pair Error="+a),a){case i.ERRORS.MDX_PAIRING_NOT_PAIRING:(this._dial.messageQueue.length>0||this._pairing.messageQueue.length>0)&&this.retryPair(this._pairing.types.regpair),n=1e4;break;case i.ERRORS.MDX_PAIRING_CONTROLLER_CTICKET_CORRUPTED:case i.ERRORS.MDX_PAIRING_CONTROLLER_HMAC_FAILURE:case i.ERRORS.MDX_PAIRING_CONTROLLER_CTICKET_EXPIRED:t.uilog("MDXUI: Target-"+this._config.friendlyName+".pairingResponseHandler","Pair Error Attempt Fix - CTICKET RENEWAL"),o.renewCticket(function(){d.retryPair(d._pairing.types.pair)},function(){d.fireEvent(d.EVENTS.NOT_READY,[d])}),n=1e4;break;case i.ERRORS.MDX_PAIRING_SERVER_NOT_REACHABLE:d.retryPair(this._pairing.types.pair),n=1e4;break;case i.ERRORS.MDX_PAIRING_NETWORK_ERROR:d.retryPair(this._pairing.types.pair),n=1e4;break;default:d.retryPair(this._pairing.types.pair),n=1e4}this._pairing.retry.timeout=window.setTimeout(function(){t.uilog("MDXUI: Target-"+d._config.friendlyName+".pairingResponseHandler","timeout pairing from error","retries attempted="+d._pairing.retry.current),d.fireEvent(d.EVENTS.NOT_READY,[this])},n)}else t.uilog("MDXUI: Target-"+this._config.friendlyName+".pairingResponseHandler","Valid Pairing Context"),this._pairing.context=e.pairingContext,this.pairingSuccessHandler()},d.pairingDeletedHandler=function(e){t.uilog("MDXUI: Target-"+this._config.friendlyName+".pairingDeletedHandler",e)},d.addPairingListeners=function(){t.uilog("MDXUI: Target-"+this._config.friendlyName+".addPairingListeners","listeners already added?: "+this._pairing.listenerAdded),this._pairing.listenerAdded||(this.pairingResponseHandlerDelegate=r(this,this.pairingResponseHandler),this.pairingDeletedHandlerDelegate=r(this,this.pairingDeletedHandler),i.addEventListener(this.MdxManager.EVENTS.regpairresponse,this.pairingResponseHandlerDelegate),i.addEventListener(this.MdxManager.EVENTS.pairingresponse,this.pairingResponseHandlerDelegate),i.addEventListener(this.MdxManager.EVENTS.pairingdeleted,this.pairingDeletedHandlerDelegate),this._pairing.listenerAdded=!0)},d.removePairingListeners=function(){t.uilog("MDXUI: Target-"+this._config.friendlyName+".removePairingListeners",this._config,this._pairing),this._pairing.listenerAdded&&(i.removeEventListener(this.MdxManager.EVENTS.regpairresponse,this.pairingResponseHandlerDelegate),i.removeEventListener(this.MdxManager.EVENTS.pairingresponse,this.pairingResponseHandlerDelegate),i.removeEventListener(this.MdxManager.EVENTS.pairingdeleted,this.pairingDeletedHandlerDelegate),this._pairing.listenerAdded=!1)},d.pair=function(e,n){t.uilog("MDXUI: Target-"+this._config.friendlyName+".pair","type: "+n,"_pairing",this._pairing,"uuid",this._config.uuid),this._config.uuid||(t.uilog("MDXUI: Target-"+this._config.friendlyName+".pair","Invalid uuid"),this._currentState={state:this.EVENTS.NOT_READY},this.fireEvent(this.EVENTS.NOT_READY,[this])),this._pairing.paired?(t.uilog("MDXUI: Target-"+this._config.friendlyName+".pair, starting session"),this.pairingSuccessHandler()):(e?this._pairing.retry.current!==this._pairing.retry.max?this._pairing.retry.current++:(this._currentState={state:this.EVENTS.NOT_READY},this.fireEvent(this.EVENTS.NOT_READY,[this])):(this._pairing.retry.current=0,this._session.retry.current=0),this.addPairingListeners(),n===this._pairing.types.regpair?(t.uilog("MDXUI: Target-"+this._config.friendlyName+".pair","type: "+n,"regPairRequest"),i.regPairRequest(this._config.uuid,"00000")):(t.uilog("MDXUI: Target-"+this._config.friendlyName+".pair","type: "+n,"pairingRequest"),i.pairingRequest(this._config.uuid)))},d.retryPair=function(e){t.uilog("MDXUI: Target-"+this._config.friendlyName+".retryPair","type: "+e,"_pairing",this._pairing,"uuid",this._config.uuid),this.pair(!0,e)},d.startPair=function(e){t.uilog("MDXUI: Target-"+this._config.friendlyName+".startPair","type: "+e,"_pairing",this._pairing,"uuid",this._config.uuid),this._pairing.context?(t.uilog("MDXUI: Target-"+this._config.friendlyName+".init: Target has pairingContext to initiate session."),this.pairingSuccessHandler()):this.pair(!1,e)},d.sessionStartResponseHandler=function(e){e.pairingContext&&e.pairingContext===this._pairing.context?(t.uilog("MDXUI: Target-"+this._config.friendlyName+".sessionStartResponseHandler"+this._config),this._session.id=e.sid,n.sendMessage(e.sid,"HANDSHAKE",{contractVersion:1})):(this._currentState={state:this.EVENTS.NOT_READY},this.fireEvent(this.EVENTS.NOT_READY,[this]))},d.resetSession=function(e){this._pairing.context=null,this._pairing.paired=!1,this._session.id=null,this.removeSessionListeners(),e&&(this._session.retry.current=0),this._session.stateUncertain=!1,this._session.handshakeAccepted=!1},d.sessionEndedHandler=function(e){e.sid&&e.sid===this._session.id&&(t.uilog("MDXUI: Target-"+this._config.friendlyName+".sessionEndedHandler",this._config),this._session.retry.timeout&&(window.clearTimeout(this._session.retry.timeout),this._session.retry.timeout=null),this.resetSession(!0),this.fireEvent(this.EVENTS.NOT_READY,[this]))},d.messageDeliveredHandler=function(e){var i,n,r,s;if(t.uilog("MDXUI: Target-"+this._config.friendlyName+".messageDeliveredHandler",e),e&&e.type===this.MdxManager.EVENTS.messagedelivered&&e.pairingContext===this._pairing.context){n=e.transactionId,t.uilog("MDXUI: Target-"+this._config.friendlyName+".messageDeliveredHandler",n,this._messages[n]),n&&(i=this._messages[n],this.fireEvent(this.EVENTS.MESSAGE_FROM_TARGET,[n]),i&&i.success&&(t.uilog("MDXUI: Target-"+this._config.friendlyName+".messageDeliveredHandler","handler found for transaction id="+n),i.success())),s=(new Date).getTime();for(r in this._messages)this._messages.hasOwnProperty(r)&&s-this._messages[r].attempted>=12e4&&delete this._messages[r]}},d.messageErrorHandler=function(e){function r(){c&&c.failure&&c.failure(),u.fireEvent(u.EVENTS.NOT_READY,[u])}function s(){null===u._session.id&&u._session.retry.current<=u._session.retry.max?(t.uilog("MDXUI: Target-.messageErrorHandler, depairing"),u.startPair(u._pairing.types.pair),u._session.retry.current++):c&&c.retry!==c.max?(u.sendMessage(c.command.type,c.command.object,c.success?c.success:null,c.failure?c.failure:null),c.retry++):r()}if(e&&e.pairingContext===this._pairing.context){var a,d,c,l=!1,u=this;if(e.type===this.MdxManager.EVENTS.messagingerror)switch(a=e.errorCode,d=e.transactionId,c=this._messages[d],t.uilog("MDXUI: Target-.messageErrorHandler","errorcode="+a,this._config),+a){case n.ERRORS.MDX_SESSION_UNKNOWN_VERSION:case n.ERRORS.MDX_SESSION_UNKNOWN_SENDER_USERID:case n.ERRORS.MDX_SESSION_UNKNOWN_RECEIVER_USERID:this.fireEvent(this.EVENTS.NOT_READY,[this]);break;case n.ERRORS.MDX_SESSION_INVALID_SID:t.uilog("MDXUI: Target-.messageErrorHandler","MDX_SESSION_INVALID_SID"),l=!0,this.resetSession(!0),this.pairingSuccessHandler();break;case n.ERRORS.MDX_SESSION_INVALID_HMAC:t.uilog("MDXUI: Target-.messageErrorHandler","MDX_SESSION_INVALID_HMAC"),i.dePair(u._pairing.context),t.uilog("MDXUI: Target-.messageErrorHandler","depairing"),this.resetSession(!1),t.uilog("MDXUI: Target-.messageErrorHandler","start pair"),u.startPair(u._pairing.types.pair),u._session.retry.current++;break;case n.ERRORS.MDX_SESSION_UNKNOWN_SENDER:case n.ERRORS.MDX_SESSION_UNKNOWN_RECEIVER:case n.ERRORS.MDX_SESSION_DECRYPTION_FAILED:t.uilog("MDXUI: Target-.messageErrorHandler","MDX_SESSION_INVALID_HMAC",e),l=!0,i.dePair(u._pairing.context),this.resetSession(!1),o.renewCticket(s,r)}}},d.handshakeAcceptedHandler=function(e){var i,n,r,s;e.pairingContext===this._pairing.context&&(t.uilog("MDXUI: Target-"+this._config.friendlyName+".handshakeAcceptedHandler",this._config.uuid),e.type===this.MdxManager.MESSAGES.HANDSHAKE_ACCEPTED&&e.sid===this._session.id?(i=e.msgObject,i?(n=i.accepted,t.uilog("MDXUI: Target-"+this._config.friendlyName+".handshakeAcceptedHandler","handshake response: accepted: "+n+", contractVersion: "+i.contractVersion+", volumeControl: "+i.volumeControl+", volumeStep: "+i.volumeStep)):(n=!1,t.uilog("MDXUI: Target-"+this._config.friendlyName+".handshakeAcceptedHandler","bad event: no msgObject")),this._session.handshakeAccepted=n,n?(t.uilog("MDXUI: Target-"+this._config.friendlyName+".handshakeAcceptedHandler","target-uuid:"+this._config.uuid,"successful handshake"),r="true"===i.volumeControl||i.volumeControl===!0,this._capabilities.volumeControl=r,this._capabilities.volumeStep=r?i.volumeStep:null,this.getPlayerCapabilities("targetItself"),this._currentState={state:this.EVENTS.MDX_READY},this.fireEvent(this.EVENTS.MDX_READY,[this]),this._dial.messageQueue.length>0?(s=this._dial.messageQueue[0],this.sendMessage(s.type,s.object,s.caller,s.successCallback,s.failureCallback),this._dial.messageQueue.pop()):this._pairing.messageQueue.length>0&&(s=this._pairing.messageQueue[0],this.sendMessage(s.type,s.object,s.caller,s.successCallback,s.failureCallback),this._pairing.messageQueue.pop())):(t.uilog("MDXUI: Target-"+this._config.friendlyName+".handshakeAcceptedHandler","target-uuid:"+this._config.uuid,"association_failed",{errorCode:"handshake_not_accepted"}),this._currentState={state:this.EVENTS.NOT_READY},this.fireEvent(this.EVENTS.NOT_READY,[this]))):t.uilog("MDXUI: Target-"+this._config.friendlyName+".handshakeAcceptedHandler","bad event type: "+e.type+", or bad sid: "+e.sid))},d.playerCurrentStateHandler=function(e){if(t.uilog("MDXUI: Target-"+this._config.friendlyName+".playerCurrentStateHandler",e),e.type===this.MdxManager.MESSAGES.PLAYER_CURRENT_STATE&&e.pairingContext===this._pairing.context&&e.sid===this._session.id){var i=e.msgObject;i&&(this._currentState=i,this.fireEvent(this.EVENTS.UPDATED_PLAYER_STATE))}},d.playerStateChangeHandler=function(e){if(e.type===this.MdxManager.MESSAGES.PLAYER_STATE_CHANGED&&e.pairingContext===this._pairing.context&&e.sid===this._session.id){var t=e.msgObject;t&&(this._currentState=t,this.fireEvent(this.EVENTS.UPDATED_PLAYER_STATE))}},d.dialogDismissHandler=function(e){},d.dialogApproveHandler=function(e){},d.dialogAdditionalButtonsHandler=function(e){},d.dialogShowHandler=function(e){var i,n,r,s,a,o;if(e.pairingContext===this._pairing.context&&e.sid===this._session.id)if(s=e.msgObject,t.uilog("MDXUI: Target-"+this._config.friendlyName+".dialogShowHandler: show dialog "+s.uid),void 0!==s.uid&&s.options&&s.options.length>0){for(r={uid:s.uid,title:s.title,message:s.message,dismissScope:this,approveScope:this,buttonsScope:this,dismissHandler:this.dialogDismissHandler,approveHandler:this.dialogApproveHandler,additionalButtonsHandler:this.dialogAdditionalButtonsHandler},a=["dismiss","approve","button3","button4","button5"],o=["dismissArgs","approveArgs","button3Args","button4Args","button5Args"],n=s.options.length,i=0;n>i;i++)s.options[i].uid=s.uid,r[a[i]]=s.options[i].name,r[o[i]]=[s.options[i]];this.fireEvent(this.EVENTS.DIALOG_SHOW,[r])}else t.uilog("MDXUI: Target-"+this._config.friendlyName+".dialogShowHandler: incorrect msgObject ",s)},d.dialogCancelHandler=function(e){var i;t.uilog("MDXUI: Target-"+this._config.friendlyName+".dialogCancelHandler",e),e.pairingContext===this._pairing.context&&e.sid===this._session.id&&(i=e.msgObject,t.uilog("MDXUI: Target-"+this._config.friendlyName+".dialogCancelHandler","cancel dialog"+i.uid),this.fireEvent(this.EVENTS.DIALOG_CANCEL,[{uid:i.uid}]))},d.audioSubtitlesSettingsHandler=function(e){t.uilog("MDXUI: Target-"+this._config.friendlyName+".audioSubtitlesSettingsHandler",this._config.uuid),e.pairingContext===this._pairing.context&&e.sid===this._session.id&&e.type===this.MdxManager.MESSAGES.AUDIO_SUBTITLES_SETTINGS&&(t.uilog("MDXUI: Target-"+this._config.friendlyName+".audioSubtitlesSettingsHandler",e),this.fireEvent(this.EVENTS.AUDIO_SUBTITLES_SETTINGS,[e]))},d.heartbeatRequestedHandler=function(){t.uilog("MDXUI: Target-"+this._config.friendlyName+".heartbeatRequestedHandler"),this._session.handshakeAccepted&&this.updatePlayerState(0)},d.playerCapabilitesHandler=function(e){t.uilog("MDXUI: Target-"+this._config.friendlyName+".playerCapabilitesHandler",this._config.uuid),e.pairingContext===this._pairing.context&&e.sid===this._session.id&&e.type===this.MdxManager.MESSAGES.PLAYER_CAPABILITIES&&(t.uilog("MDXUI: Target-"+this._config.friendlyName+".playerCapabilitesHandler",e),this._capabilities.volumeControl=e.msgObject&&e.msgObject.volumeControl?e.msgObject.volumeControl||"true"===e.msgObject.volumeControl:this._capabilities.volumeControl,this.fireEvent(this.EVENTS.UPDATED_PLAYER_CAPABILITIES,[e]))},d.addSessionListeners=function(){t.uilog("MDXUI: Target-"+this._config.friendlyName+".addSessionListeners",this._config),this._session.listenerAdded||(this.sessionStartResponseHandlerDelegate=r(this,this.sessionStartResponseHandler),this.sessionEndedHandlerDelegate=r(this,this.sessionEndedHandler),this.messageDeliveredHandlerDelegate=r(this,this.messageDeliveredHandler),this.messageErrorHandlerDelegate=r(this,this.messageErrorHandler),this.handshakeAcceptedHandlerDelegate=r(this,this.handshakeAcceptedHandler),this.playerCurrentStateHandlerDelegate=r(this,this.playerCurrentStateHandler),this.playerStateChangeHandlerDelegate=r(this,this.playerStateChangeHandler),this.heartbeatRequestedHandlerDelegate=r(this,this.heartbeatRequestedHandler),this.playerCapabilitesHandlerDelegate=r(this,this.playerCapabilitesHandler),this.dialogShowHandlerDelegate=r(this,this.dialogShowHandler),this.dialogCancelHandlerDelegate=r(this,this.dialogCancelHandler),this.audioSubtitlesSettingsHandlerDelegate=r(this,this.audioSubtitlesSettingsHandler),this.devicelostHandlerDelegate=r(this,this.devicelostHandler),n.addEventListener(this.MdxManager.EVENTS.sessionstartresponse,this.sessionStartResponseHandlerDelegate),n.addEventListener(this.MdxManager.EVENTS.sessionended,this.sessionEndedHandlerDelegate),n.addEventListener(this.MdxManager.EVENTS.messagedelivered,this.messageDeliveredHandlerDelegate),n.addEventListener(this.MdxManager.EVENTS.messagingerror,this.messageErrorHandlerDelegate),n.addMessageListener(this.MdxManager.MESSAGES.HANDSHAKE_ACCEPTED,this.handshakeAcceptedHandlerDelegate),n.addMessageListener(this.MdxManager.MESSAGES.PLAYER_CURRENT_STATE,this.playerCurrentStateHandlerDelegate),n.addMessageListener(this.MdxManager.MESSAGES.PLAYER_STATE_CHANGED,this.playerStateChangeHandlerDelegate),n.addMessageListener(this.MdxManager.MESSAGES.PLAYER_CAPABILITIES,this.playerCapabilitesHandlerDelegate),n.addMessageListener(this.MdxManager.MESSAGES.DIALOG_SHOW,this.dialogShowHandlerDelegate),n.addMessageListener(this.MdxManager.MESSAGES.DIALOG_CANCEL,this.dialogCancelHandlerDelegate),n.addMessageListener(this.MdxManager.MESSAGES.AUDIO_SUBTITLES_SETTINGS,this.audioSubtitlesSettingsHandlerDelegate),this.MdxManager.addEventListener(this.MdxManager.EVENTS.heartbeat,this.heartbeatRequestedHandlerDelegate),this.MdxManager.addEventListener(this.MdxManager.EVENTS.devicelost,this.devicelostHandlerDelegate),this._session.listenerAdded=!0)},d.removeSessionListeners=function(){t.uilog("MDXUI: Target-"+this._config.friendlyName+".removeSessionListeners",this._config),this._session.listenerAdded&&(n.removeEventListener(this.MdxManager.EVENTS.sessionstartresponse,this.sessionStartResponseHandlerDelegate),n.removeEventListener(this.MdxManager.EVENTS.sessionended,this.sessionEndedHandlerDelegate),n.removeEventListener(this.MdxManager.EVENTS.messagedelivered,this.messageDeliveredHandlerDelegate),n.removeEventListener(this.MdxManager.EVENTS.messagingerror,this.messageErrorHandlerDelegate),n.removeMesageListener(this.MdxManager.MESSAGES.HANDSHAKE_ACCEPTED,this.handshakeAcceptedHandlerDelegate),n.removeMesageListener(this.MdxManager.MESSAGES.PLAYER_CURRENT_STATE,this.playerCurrentStateHandlerDelegate),n.removeMesageListener(this.MdxManager.MESSAGES.PLAYER_STATE_CHANGED,this.playerStateChangeHandlerDelegate),n.removeMesageListener(this.MdxManager.MESSAGES.PLAYER_CAPABILITIES,this.playerCapabilitesHandlerDelegate),n.removeMesageListener(this.MdxManager.MESSAGES.DIALOG_SHOW,this.dialogShowHandlerDelegate),n.removeMesageListener(this.MdxManager.MESSAGES.DIALOG_CANCEL,this.dialogCancelHandlerDelegate),n.removeMesageListener(this.MdxManager.MESSAGES.AUDIO_SUBTITLES_SETTINGS,this.audioSubtitlesSettingsHandlerDelegate),this.MdxManager.removeEventListener(this.MdxManager.EVENTS.heartbeat,this.heartbeatRequestedHandlerDelegate),this.MdxManager.removeEventListener(this.MdxManager.EVENTS.devicelost,this.devicelostHandlerDelegate),this._session.listenerAdded=!1)},d.updatePlayerState=function(e){var n=this;window.setTimeout(function(){n._session.handshakeAccepted?n.sendMessage(n.MdxManager.MESSAGES.PLAYER_GET_CURRENT_STATE,{xid:n._currentState.xid||0}):(t.uilog("MDXUI: Target-"+n._config.friendlyName+".updatePlayerState: invalid session",n._config.uuid),i.dePair(n._pairing.context),n.resetSession(!0),n.startPair(n._pairing.types.pair))},e||1)},d.dialRemoteDeviceReadyHandler=function(e){if(t.uilog("MDXUI: Target-"+this._config.friendlyName+".dialRemoteDeviceReadyHandler",e),e&&e.UUID&&e.UUID===this._config.uuid){s.removeEventListener(this.MdxManager.EVENTS.remoteDeviceReady,this.dialRemoteDeviceReadyHandlerDelegate);var i=this;if(this._dial.launchStatus=e.launchStatus,this._dial.launchStatus!==mdx.discovery.LAUNCHED)if(this._dial.messageQueue.length>0&&this._dial.retry.current<this._dial.retry.max)this._dial.retry.current++,this._dial.retry.timeout=window.setTimeout(function(){i.dialLaunch(i._dial.messageQueue[0].launchArgs)},500);else{var n={uid:-1,title:a.get("mdx-error-device-lost-title"),message:a.getWithParams("mdx-error-device-lost-text",["DEVICE_NAME"],[this._config.friendlyName])};this.fireEvent(this.EVENTS.DIALOG_SHOW,[n])}else this.startPair(this._pairing.types.pair)}},d.updateLaunchStatus=function(e){this._dial.launchStatus=e},d.dialLaunch=function(e){this.dialRemoteDeviceReadyHandlerDelegate=r(this,this.dialRemoteDeviceReadyHandler),s.addEventListener(this.MdxManager.EVENTS.remoteDeviceReady,this.dialRemoteDeviceReadyHandlerDelegate),s.launchNetflix(this._config.dialUsn,e)},d.sendMessage=function(e,i,n,r,s){function a(t,a){var o={type:e,object:i,caller:n};a&&(o.launchArgs=a),r&&(o.successCallback=r),s&&(o.failureCallback=s),t.messageQueue.push(o)}if(t.uilog("MDXUI: Target-"+this._config.friendlyName+".sendMessage",e,i,n,r,s),e===this.MdxManager.MESSAGES.PLAYER_PLAY&&this._dial.launchStatus!==mdx.discovery.LAUNCHED){var o="intent=play&titleid="+encodeURIComponent(i.catalogId);a(this._dial,o),this.dialLaunch(o)}else if(this._pairing.paired){var d=mdx.session.sendMessage(this._session.id,e,i),c="function"==typeof r,l="function"==typeof s;this.fireEvent(this.EVENTS.MESSAGE_TO_TARGET,[e,i,n]),this._messages[d]={retry:0,max:1,attempted:(new Date).getTime(),command:{type:e,object:i}},(c||l)&&(c&&(this._messages[d].success=r),l&&(this._messages[d].failure=s),t.uilog("MDXUI: Target-"+this._config.friendlyName+".sendMessage","added to Target._messages",this._messages,this._messages[d]))}else a(this._pairing,!1),this.startPair(this._pairing.types.pair)},d.play=function(e,t,i,n){this._config.controllerEsn=netflix.cadmium.objects.videoSession().mdx.getEsn();var r={catalogId:"https://api.netflix.com/catalog/titles/movies/"+e,trackId:t,esn:this._config.controllerEsn,enablePostplay:!1};n&&(r.isPinVerified=!0),this.sendMessage(this.MdxManager.MESSAGES.PLAYER_PLAY,r,i,null,null)},d.pause=function(e,i,n){t.uilog("MDXUI: Target.pause called",this._currentState),this._currentState.currentState===this.MdxManager.PLAYER_STATE.PLAYING&&this.sendMessage(this.MdxManager.MESSAGES.PLAYER_PAUSE,{xid:this._currentState.xid||0},e,i,n)},d.resume=function(e,i,n){t.uilog("MDXUI: Target.resume called",this._currentState),this._currentState.currentState===this.MdxManager.PLAYER_STATE.PAUSE&&this.sendMessage(this.MdxManager.MESSAGES.PLAYER_RESUME,{xid:this._currentState.xid||0},e,i,n)},d.stop=function(e,i,n){t.uilog("MDXUI: Target.stop called",this._currentState),this._currentState.currentState!==this.MdxManager.PLAYER_STATE.STOP&&this.sendMessage(this.MdxManager.MESSAGES.PLAYER_STOP,{xid:this._currentState.xid||0,disablePostplay:!0},e,i,n)},d.seek=function(e,i,n,r){t.uilog("MDXUI: Target.seek called",e,this._currentState),this._currentState.currentState!==this.MdxManager.PLAYER_STATE.AUTO_ADVANCE&&this.sendMessage(this.MdxManager.MESSAGES.PLAYER_SKIP,{xid:this._currentState.xid||0,seconds:e},i,n,r)},d.getAudioSubtitles=function(){t.uilog("MDXUI: Target.getAudioSubtitles called",this._currentState),this._currentState.currentState!==this.MdxManager.PLAYER_STATE.END_PLAYBACK&&this.sendMessage(this.MdxManager.MESSAGES.GET_AUDIO_SUBTITLES_SETTINGS,{xid:this._currentState.xid||0})},d.setAudioSubtitles=function(e,i,n,r,s){t.uilog("MDXUI: Target.setAudioSubtitles called",e,i,n,this._currentState);var a={xid:this._currentState.xid||0};this._currentState.currentState!==this.MdxManager.PLAYER_STATE.END_PLAYBACK&&(e&&(a.audio_track_id=e),i&&(a.timed_text_track_id=i),this.sendMessage(this.MdxManager.MESSAGES.SET_AUDIO_SUBTITLES_SETTINGS,a,n,r,s))},d.setVolume=function(e,t,i,n){var r={xid:this._currentState.xid||0};this._currentState.currentState!==this.MdxManager.PLAYER_STATE.END_PLAYBACK&&(r.volume=e.newVolume,e.oldVolume&&(r.previous=e.oldVolume),this.sendMessage(this.MdxManager.MESSAGES.PLAYER_SET_VOLUME,r,t,i,n))},d.getPlayerCapabilities=function(e,i,n){t.uilog("MDXUI: Target.resume called",this._currentState),this._currentState.currentState!==this.MdxManager.PLAYER_STATE.END_PLAYBACK&&this.sendMessage(this.MdxManager.MESSAGES.PLAYER_GET_CAPABILITIES,{contractVersion:1,xid:this._currentState.xid||0},e,i,n)}}(netflix.mdx.Eventable,netflix.cadmium.logging,mdx.pair,mdx.session),netflix.mdx.playerutils=function(){function e(e){console.error("FELL THROUGH: playerutils."+e)}function t(t,i){e("renewCticket"),t()}function i(){return e("getVideoId"),1}function n(){return"/WiHome"}function r(){return netflix.cadmium.objects.videoPlayer().close(),!0}function s(){return netflix.cadmium.objects.videoSession().mdx.getEsn()}function a(){netflix.mdx.ui.master.stopMdx(),netflix.cadmium.ui.master.toggleMdxMode(!1)}return{renewCticket:t,getVideoId:i,getBackToBrowsingUrl:n,stopPlayer:r,getEsn:s,resumeLocalPlayback:a}}(),netflix.mdx.ui.data=function(e){function t(e){return e.video.type===p.show.value}function i(e){if(l=null,c=null,u=[],t(m)){var i,n=m.video.seasons;n.forEach(function(t,n){i=t.episodes,i.forEach(function(t,i){u.push(t.id),t.id===e&&(m.video.seasons[n].episodes[i].active=!0,l=m.video.seasons[n].episodes[i],c=m.video.seasons[n])})})}else m.video.active=!0,l=m.video,u.push(l.id)}function n(e,t,n){function s(){i(d),g=d,"function"==typeof t&&t(m)}function a(e){m=e,s()}function o(e,t,i){"function"==typeof n&&n()}var d=+e;if(g!==d)if(r(d))s();else{var c=netflix.cadmium.objects.initParams().metadataBaseServer||"",l=c+"/WiPlayerMetadata?id="+d+"&type=mdx";netflix.cadmium.xhr.get(l,{withCredentials:!0}).doAction(a).subscribe(netflix.cadmium.util.NOOP,o)}else t(m)}function r(e){if(u)for(var t=0;t<u.length;t++)if(u[t]==e)return!0;return!1}function s(){return m}function a(){return l}function o(){
return t(m)?c:null}function d(e){var t,i=0,n=null;return e&&e.length>0&&e.forEach(function(e,r){t=e.h*e.w,t>i&&(i=t,n=r)}),null!==n?e[n].url:null}var c,l,u,m=null,g=null,p=Object.freeze({show:{value:"show"},movie:{value:"movie"}});return{retrieveData:n,getMetadata:s,getActiveVideo:a,getActiveSeason:o,getLargestImage:d,isShowData:t,videoTypes:p,videoIsKnown:r}}(netflix.constants.global),netflix.mdx.element=function(){function e(){return null!==o?o:(o=document.createElement("img"),o.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",o)}function t(e){for(var t=e.offsetLeft,i=e.offsetTop,n=e.offsetWidth,r=e.offsetHeight;e=e.offsetParent;)t+=e.offsetLeft,i+=e.offsetTop;return{x:t,y:i,w:n,h:r}}function i(e){e&&e.parentNode&&e.parentNode.removeChild(e)}function n(e,t){return[t.x-e.x,t.y-e.y]}function r(e,t,i,r){return a(i,r,n(t,e))}function s(e,t,i,r){return a(n(t,r),n(t,i),n(t,e))}function a(e,t,i){function n(e,t){return e[0]*t[0]+e[1]*t[1]}var r=n(e,e),s=n(e,t),a=n(e,i),o=n(t,t),d=n(t,i),c=1/(r*o-s*s),l=(o*a-s*d)*c,u=(r*d-s*a)*c;return l>=0&&u>=0&&1>l+u}var o=null;return{getTransparentImage:e,getDimensions:t,remove:i,vector:n,isPointInCachedTriangle:r,isPointInTriangle:s}}(),netflix.mdx.ui.time=function(){function e(e,t,n,r){var s=i(e),a=function(e){return t&&10>e?"0"+e:e},o=function(e){return netflix.I18n.getWithParams(e,["H","M","S"],[s.h,a(s.m),a(s.s)])};return o(s.h>0?s.m>0?s.s>0&&!n?r+"-hours-minutes-seconds":r+"-hours-minutes":s.s&&!n>0?r+"-hours-seconds":r+"-hours":s.m>0?s.s>0&&!n?r+"-minutes-seconds":r+"-minutes":r+"-seconds")}function t(e){var t="",n=i(e);return n.h>0&&(t=n.h+":",n.m<10&&(t+="0")),t+=n.m+":",t+(n.s>=10?n.s:"0"+n.s)}function i(e){var t=parseInt(e),i=0,n=0;return t>3600&&(i=parseInt(t/3600),t%=3600),t>60&&(n=parseInt(t/60),t%=60),{h:i,m:n,s:t}}function n(e,t){return t=t||10,Math.max(0,(e/t>>0)*t)}return{convert:t,convertUsingKey:e,getFloored:n}}(),function(){netflix.mdx.UiEvents=new netflix.mdx.Eventable,netflix.mdx.UiEvents.knownEvents=Object.freeze({SHOW_MENU:"showmenu",HIDE_MENU:"hidemenu",DRAG_START_SCRUBBER:"dragstart-scrubber",DRAG_END_SCRUBBER:"dragend-scrubber",SILVERLIGHT_CRASH:"silverlight-crash",VIDEO_TO_TARGET:"video-to-target",VIDEO_TO_CONTROLLER:"video-to-controller"})}(),netflix.mdx.ui.dialog=function(){function e(e,t){return"<h1>"+o.get("mdx-error-dialog-header")+"</h1><h2>"+(""!==e?e:o.get("mdx-error-dialog-title"))+"</h2><p>"+t+"</p>"}function t(){return null===g&&(g=document.createElement("section"),g.className="mdx-dialog"),g}function i(t){var i=function(){g.innerHTML=e(t.title,t.message),u=t.uid,window.setTimeout(function(){g.classList.add("active")},1)};g&&(m?(g.classList.remove("active"),window.setTimeout(i,1)):i())}function n(e){e===u&&g.classList.remove("active")}function r(){c&&(c=!1,l.removeEventListener(l.EVENTS.DIALOG_SHOW,i),l.removeEventListener(l.EVENTS.DIALOG_CANCEL,n),d.remove(g),g=null)}function s(e,u){c?(r(),s(e,u)):(c=!0,l=e,a=u,o=netflix.I18n,d=netflix.mdx.element,a.appendChild(t()),l.addEventListener(l.EVENTS.DIALOG_SHOW,i),l.addEventListener(l.EVENTS.DIALOG_CANCEL,n))}var a,o,d,c=!1,l=null,u=null,m=!1,g=null;return{init:s,deinit:r}}(),netflix.mdx.ui.loading=function(){function e(){null!==g&&(g=null),g=document.createElement("div"),g.className="player-loading active";var e=document.createElement("div");return e.className="player-progress-loading",g.appendChild(e),g}function t(){var e=l._currentState,t=e.currentState;t===u.PLAYER_STATE.PLAYING&&g.classList.remove("active")}function i(){s.focus(),a.description.init(l,s),a.playback.init(l,s),a.dialog.init(l,s),l.addEventListener(l.EVENTS.UPDATED_PLAYER_STATE,t),m.uilog("MDXUI: View.Loading.targetActivated","target ready",l._config.ip,"playing"),l.play(a.data.getActiveVideo().id,netflix.constants.page.mdx?netflix.constants.page.mdx.trackTo:0,null,!p.isExpired(p.SESSION_TYPES.PIN))}function n(){c&&(c=!1,a.description.deinit(),a.playback.deinit(),l.removeEventListener(l.EVENTS.ACTIVATED,i),l.removeEventListener(l.EVENTS.DIALOG_SHOW,n),l.removeEventListener(l.EVENTS.UPDATED_PLAYER_STATE,t),d.remove(g),g=null)}function r(t,u){c?(n(),r(t,u)):(c=!0,l=t,s=u,a=netflix.mdx.ui,d=netflix.mdx.element,o=netflix.mdx.UiEvents,s.appendChild(e()),l.addEventListener(l.EVENTS.MDX_READY,i),l.addEventListener(l.EVENTS.DIALOG_SHOW,n),l.addEventListener(l.EVENTS.DIALOG_CANCEL,function(){l.removeEventListener(l.EVENTS.DIALOG_CANCEL,arguments.callee),r(t,u)}),l.startPair())}var s,a,o,d,c=!1,l=null,u=netflix.mdx.Manager.INSTANCE,m=netflix.cadmium.logging,g=null,p=netflix.cadmium.session;return{init:r,deinit:n}}(),netflix.mdx.ui.playback=function(){function e(){return"<section class='player-slider' role='slider'></section><section class='player-control-bar no-select' role='control-bar'></section>"}function t(){return null===v&&(v=document.createElement("div"),v.id="mdx-controls-wrapper",v.classList.add("no-select")),v.innerHTML=e(),v}function i(){var e,t,i,r=o._currentState,s=r.currentState;switch(s){case m.PLAYER_STATE.PLAYING:v.classList.add("active"),c=!0;break;case m.PLAYER_STATE.END_PLAYBACK:e=void 0!==r.episodeId&&""!==r.episodeId?r.episodeId:r.catalogId,t=e.split("/"),i=parseInt(t[t.length-1]),c&&d.id===i&&n()}}function n(){a&&(a=!1,p.forEach(function(e){e.deinit()}),o.removeEventListener(o.EVENTS.UPDATED_PLAYER_STATE,i),g.remove(v),v=null)}function r(e,m){if(a)n(),r(e,m);else{a=!0,o=e,s=m,d=u.getActiveVideo(),g=netflix.mdx.element,c=!1,s.appendChild(t()),o.addEventListener(o.EVENTS.UPDATED_PLAYER_STATE,i);var x=v.querySelector(".player-control-bar"),f=v.querySelector(".player-slider");p=[l.pauser,l.volume,l.stopper,l.status,l.episodeSelector,l.audio,l.targetManager],p.forEach(function(e){e.init(o,x)}),p.push(l.scrubber),l.scrubber.init(o,f)}}var s,a=!1,o=null,d=null,c=!1,l=netflix.mdx.ui,u=l.data,m=netflix.mdx.Manager.INSTANCE,g=netflix.mdx.element,p=[],v=null;return{init:r,deinit:n}}(),netflix.mdx.ui.description=function(){function e(e){var t="mdx-description-",i=!0,n=p.PLAYER_STATE;switch(e){case n.PROGRESS:case n.STALLED:t+="loading";break;case n.PLAYING:t+="playing";break;case n.PAUSE:case n.STOP:t+="paused";break;case n.AUTO_ADVANCE:t+="seeking";break;default:i=!1}return i?(_=e,v.getWithParams(t,["DEVICE_NAME"],[E._config.friendlyName])):null}function t(t){if(t!==_){var i=e(t);null!==i&&(g=document.createElement("span"),g.className="future",g.appendChild(document.createTextNode(i)),u.appendChild(g),window.setTimeout(function(){m.addEventListener("webkitTransitionEnd",function(){m.removeEventListener("webkitTransitionEnd",arguments.callee),x.remove(m),m=g,m.className="current"}),m.className="past";for(var e,t=l.querySelectorAll(".description .current"),i=0;i<t.length;++i)e=t[i],e.parentNode.removeChild(e);g.className="current active"},1))}}function i(e,i){e===p.MESSAGES.PLAYER_PAUSE?t(p.PLAYER_STATE.PAUSE):e===p.MESSAGES.PLAYER_RESUME?t(p.PLAYER_STATE.PLAYING):e===p.MESSAGES.PLAYER_SKIP&&t(p.PLAYER_STATE.AUTO_ADVANCE)}function n(){h.classList.add("scrubbing")}function r(){h.classList.remove("scrubbing")}function s(){var e="undefined"!=typeof E._currentState?E._currentState:null;e&&t(e.currentState)}function a(){var t,i=T.getActiveVideo(),n=T.getLargestImage(R.video.boxart);if(t=null===T.getLargestImage(R.video.artwork)&&null!==n?"<img src='"+n+"'><div>":"<div>",t+="<h1><span class='default'>"+e(p.PLAYER_STATE.PROGRESS)+"</span></h1><h2>"+R.video.title+"</h2>",T.isShowData(R)){var r=T.getActiveSeason();t+="<h3>"+r.title+" : "+netflix.I18n.get("ce-episode-abbreviation")+" "+i.seq+" - "+i.title+"</h3><p>"+i.synopsis+"</p>"}else t+="<h3><span>"+i.year+"</span><span>"+i.rating+"</span><span>"+S.time.convertUsingKey(i.runtime,!1,!0,"mdx-description-time")+"</span></h3><p>"+i.synopsis+"</p>";return t+="</div>"}function o(){return null===h&&(h=document.createElement("div"),h.className="description no-select"),h.innerHTML=a(),h}function d(){f&&(f=!1,E.removeEventListener(E.EVENTS.MESSAGE_TO_TARGET,i),E.removeEventListener(E.EVENTS.UPDATED_PLAYER_STATE,s),I.removeEventListener(I.knownEvents.DRAG_START_SCRUBBER,n),I.removeEventListener(I.knownEvents.DRAG_END_SCRUBBER,r),x.remove(h),h=null)}function c(e,t){f?(d(),c(e,t)):(f=!0,E=e,l=t,R=T.getMetadata(),v=netflix.I18n,p=netflix.mdx.Manager.INSTANCE,x=netflix.mdx.element,l.appendChild(o()),u=h.querySelector("h1"),m=u.querySelector(".default"),E.addEventListener(E.EVENTS.MESSAGE_TO_TARGET,i),E.addEventListener(E.EVENTS.UPDATED_PLAYER_STATE,s),I.addEventListener(I.knownEvents.DRAG_START_SCRUBBER,n),I.addEventListener(I.knownEvents.DRAG_END_SCRUBBER,r))}var l,u,m,g,p,v,x,f=!1,E=null,h=null,_=null,S=netflix.mdx.ui,I=netflix.mdx.UiEvents,T=S.data,R=null;return{init:c,deinit:d}}(),netflix.mdx.ui.pauser=function(){function e(){return null===v&&(v=document.createElement("button"),v.className="player-play-pause pause "+_),v}function t(){if(!netflix.mdx.ui.scrubber.getIsDragging()){var e=p._currentState,t=e.currentState;n(t!==l.PLAYER_STATE.PLAYING&&t!==l.PLAYER_STATE.PLAY?l.PLAYER_STATE.PLAYING:l.PLAYER_STATE.PAUSE)}}function i(e,t){e===l.MESSAGES.PLAYER_PAUSE?n(l.PLAYER_STATE.PLAYING):(e===l.MESSAGES.PLAYER_RESUME||e===l.MESSAGES.PLAYER_SKIP)&&n(l.PLAYER_STATE.PAUSE)}function n(e){var t=e===l.PLAYER_STATE.PLAYING||e===l.PLAYER_STATE.PAUSE;t&&f!==e&&(f=e,e===l.PLAYER_STATE.PLAYING?(v.classList.remove("pause"),v.classList.remove(_),v.classList.add("play"),v.classList.add(h)):e===l.PLAYER_STATE.PAUSE&&(v.classList.remove("play"),v.classList.remove(h),v.classList.add("pause"),v.classList.add(_)))}function r(){x=!0}function s(){if(x){var e=function(){window.setTimeout(r,3e3)};if(x=!1,"undefined"!=typeof p._currentState.currentState){var t=p._currentState.currentState;t===l.PLAYER_STATE.PLAYING?(n(l.PLAYER_STATE.PLAYING),p.pause(E,r)):t===l.PLAYER_STATE.PAUSE?(n(l.PLAYER_STATE.PAUSE),p.resume(E,r)):e()}else e()}}function a(e){e.target===v&&s()}function o(e){32===e.keyCode&&s()}function d(){g&&(g=!1,p.removeEventListener(p.EVENTS.MESSAGE_TO_TARGET,i),p.removeEventListener(p.EVENTS.MESSAGE_FROM_TARGET,r),p.removeEventListener(p.EVENTS.UPDATED_PLAYER_STATE,t),v.removeEventListener("click",a),document.removeEventListener("keypress",o),u.remove(v),v=null)}function c(n,s){g?(d(),c(n,s)):(g=!0,p=n,m=s,l=netflix.mdx.Manager.INSTANCE,u=netflix.mdx.element,m.appendChild(e()),p.addEventListener(p.EVENTS.MESSAGE_TO_TARGET,i),p.addEventListener(p.EVENTS.MESSAGE_FROM_TARGET,r),p.addEventListener(p.EVENTS.UPDATED_PLAYER_STATE,t),v.addEventListener("click",a),document.addEventListener("keypress",o))}var l,u,m,g=!1,p=null,v=null,x=!0,f=null,E="pauser",h="icon-player-play",_="icon-player-pause";return{init:c,deinit:d}}(),netflix.mdx.ui.scrubber=function(){function e(e){A.innerHTML=E.convert(e.duration-e.time)}function t(e){b.value=e.time,b.max!==e.duration&&(b.max=e.duration)}function i(e){N.style.left=e.time/e.duration*100+"%"}function n(n,r,s){n==O.MESSAGES.PLAYER_PAUSE?o():s!==P&&n===O.MESSAGES.PLAYER_SKIP&&r.seconds&&(o(),U.time=parseFloat(U.time)+r.seconds,e(U),t(U),i(U))}function r(){if(G)return void o();var n=R._currentState,r=n.currentState;r===O.PLAYER_STATE.PLAYING||r===O.PLAYER_STATE.PAUSE?(w=(new Date).getTime(),e(n),t(n),i(n),U=Object.create(n),r===O.PLAYER_STATE.PLAYING?a():o()):o()}function s(){var n=(new Date).getTime(),r=Math.floor((n-w)/1e3),a=R._currentState;U.time=parseInt(a.time)+r,e(U),t(U),i(U),window.clearTimeout(H),H=window.setTimeout(s,1e3)}function a(){k||(H=window.setTimeout(s,1e3),k=!0)}function o(){k&&(window.clearTimeout(H),k=!1)}function d(){return G}function c(e,t){var i,n,r,s;return t?n=X.position.scrubber.left:(i=e.target,n=i!==y?i.offsetLeft+e.offsetX:e.offsetX),r=D.offsetLeft+n,s=n/y.offsetWidth,{relativePosition:n,absolutePosition:r,percentagePosition:s,current:b}}function l(e){e.dataTransfer.setDragImage(I,0,0),G=!0,h.fireEvent(h.knownEvents.DRAG_START_SCRUBBER),R.pause(P),X.progress={value:b.value,max:b.max},X.position={mouse:{x:e.x,y:e.y},scrubber:{left:parseFloat(N.style.left)/100*y.offsetWidth}},L.style.left=b.value/b.max*y.offsetWidth+"px",L.classList.add("active")}function u(t){var i=!1;t.x<D.offsetLeft||t.x>y.offsetWidth+D.offsetLeft||(Math.abs(t.y-X.position.mouse.y)>M.offsetHeight*V?(i=!0,Y=c(t,!1),N.style.left=Y.relativePosition+"px",b.value=X.progress.value,S.move(Y,i)):(Y=c(t,!1),N.style.left=Y.relativePosition+"px",b.value=Math.min(1,Math.max(Y.percentagePosition,0))*b.max,S.move(Y,i)),U.time=E.getFloored(b.value),e(U))}function m(e){e.preventDefault(),h.fireEvent(h.knownEvents.DRAG_END_SCRUBBER),R.seek(E.getFloored(b.value)-X.progress.value,P),L.classList.remove("active"),S.hide(!0),G=!1}function g(e){D.classList.add("hidden")}function p(e){D.classList.remove("hidden")}function v(){A=document.createElement("label"),y=document.createElement("div"),b=document.createElement("progress"),N=document.createElement("button"),N.setAttribute("draggable","true"),L=document.createElement("div"),L.className="trickplay-position snapback",y.appendChild(b),y.appendChild(N),y.appendChild(L),D.appendChild(A),D.appendChild(y),I=_.getTransparentImage(),M=document.getElementById(C)}function x(){if(T){T=!1,o(),S.deinit(),R.removeEventListener(R.EVENTS.MESSAGE_TO_TARGET,n),R.removeEventListener(R.EVENTS.UPDATED_PLAYER_STATE,r),N.removeEventListener("dragstart",l),N.removeEventListener("drag",u),N.removeEventListener("dragend",m);var e=function(e){e.forEach(function(e){_.remove(e)})};e([A,b,N,L,y]),A=null,b=null,N=null,L=null,y=null,M=null}}function f(e,t){T?(x(),f(e,t)):(T=!0,R=e,D=t,E=netflix.mdx.ui.time,h=netflix.mdx.UiEvents,_=netflix.mdx.element,v(),S=netflix.mdx.ui.trickplayPreview,S.init(R,D.parentNode),N.addEventListener("dragstart",l),N.addEventListener("drag",u),N.addEventListener("dragend",m),h.addEventListener(h.knownEvents.SHOW_MENU,g),h.addEventListener(h.knownEvents.HIDE_MENU,p),R.addEventListener(R.EVENTS.MESSAGE_TO_TARGET,n),R.addEventListener(R.EVENTS.UPDATED_PLAYER_STATE,r))}var E,h,_,S,I,T=!1,R=null,D=null,A=null,y=null,b=null,N=null,L=null,M=null,C="mdx-control-font-wrapper",O=netflix.mdx.Manager.INSTANCE,P="scrubber",w=null,U=null,k=!1,H=null,G=!1,V=.3,X={},Y={};return{init:f,deinit:x,determinePositions:c,getIsDragging:d}}(),netflix.mdx.ui.status=function(){function e(){return null===a&&(a=document.createElement("div"),a.className="status"),a}function t(){r&&(r=!1,netflix.mdx.element.remove(a),a=null)}function i(a,o){r?(t(),i(a,o)):(r=!0,s=a,n=o,n.appendChild(e()))}var n,r=!1,s=null,a=null;return{init:i,deinit:t}}(),netflix.mdx.ui.stopper=function(){function e(){return null===o&&(o=document.createElement("button"),o.className="player-stop icon-player-stop"),o}function t(e){d&&(d=!1,a.stop(c,function(){netflix.mdx.ui.master.goBackToBrowsing()}))}function i(){s&&(s=!1,o.removeEventListener("click",t),netflix.mdx.element.remove(o),o=null)}function n(c,l){s?(i(),n(c,l)):(s=!0,a=c,r=l,r.appendChild(e()),d=!0,o.addEventListener("click",t))}var r,s=!1,a=null,o=null,d=!1,c="stopper";return{init:n,deinit:i}}(),netflix.mdx.ui.audio=function(){function e(){return null===R&&(R=document.createElement("button"),R.className="player-audio-subtitles icon-player-subtitle-selector",D=document.createElement("div"),D.className="menu",D.innerHTML=t(!1,!1),R.appendChild(D)),R}function t(e,t){var i="";if(null!==L&&(i+="<ol class='audio'><lh>"+f.get("mdx-controls-audio")+"</lh>",e||L.forEach(function(e){i+="<li "+("true"===e.selected?"class='selected' ":"")+"data-id='"+e.id+"'>"+e.label+"</li>"}),i+="</ol>",O=!0,null!==M)){var n=t&&null!==w?" style='height: "+w.h+"px; width: "+w.w+"px'":"";i+="<ol class='subtitles'"+n+"><lh>"+f.get("mdx-controls-timed-text")+"</lh>",t?i+="<li class='loading'>Loading</li>":M.forEach(function(e){i+="<li "+("true"===e.selected?"class='selected' ":"")+"data-id='"+e.id+"'>"+e.label+"</li>"}),i+="</ol>",P=!0}return i}function i(){var e=I._currentState,t=e.currentState;C||null!==L&&null!==M||t!==x.PLAYER_STATE.PLAYING||(I.getAudioSubtitles(),C=!0)}function n(e,t){e===x.MESSAGES.AUDIO_SUBTITLES_SETTINGS||e===x.MESSAGES.AUDIO_SUBTITLES_CHANGED}function r(e){var i,n,r=e.msgObject;r&&(L=r.audio_tracks,M=r.timed_text_track,D.innerHTML=t(!1,!1),i=D.querySelector(".subtitles"),n=document.defaultView.getComputedStyle(i),w={h:parseInt(n.height),w:parseInt(n.width)})}function s(e){var i,n,r,s=e.target;"LI"===s.tagName&&(i=D.querySelector(".audio"),n=D.querySelector(".subtitles"),i&&i.contains(s)&&!s.classList.contains("selected")?(r=s.getAttribute("data-id"),L.forEach(function(e){"true"===e.selected?e.selected="false":e.id===r&&(e.selected="true")}),I.setAudioSubtitles(r,null,T),D.innerHTML=t(!1,!0)):n&&n.contains(s)&&!s.classList.contains("selected")&&(r=s.getAttribute("data-id"),M.forEach(function(e){"true"===e.selected?e.selected="false":e.id===r&&(e.selected="true")}),I.setAudioSubtitles(null,r,T),D.innerHTML=t(!1,!1)))}function a(e){b&&null!==y&&(E.isPointInTriangle({x:e.x,y:e.y},y.a,y.b,y.c)||c())}function o(e){document.addEventListener("mousemove",a),b=!1,null!==N&&(window.clearTimeout(N),N=null),D.classList.add("visible"),R.classList.add("active"),window.setTimeout(function(){h.fireEvent(h.knownEvents.SHOW_MENU,[T]),A=E.getDimensions(D);var e=E.getDimensions(R);y={a:{x:e.x+e.w/2,y:e.y+e.h},b:{x:A.x,y:A.y+A.h-5},c:{x:A.x+A.w,y:A.y+A.h-5}},D.classList.add("active"),D.addEventListener("mouseout",l),D.addEventListener("mouseover",u),D.addEventListener("click",s)},1)}function d(e){if(void 0!==e){if(e===T)return;c()}}function c(){document.removeEventListener("mousemove",a),h.fireEvent(h.knownEvents.HIDE_MENU,[T]);var e=function(t){t.target===D&&(D.classList.contains("active")||D.classList.remove("visible"),D.removeEventListener("webkitTransitionEnd",e))};D.removeEventListener("mouseout",l),D.removeEventListener("mouseover",u),D.removeEventListener("click",s),D.addEventListener("webkitTransitionEnd",e),D.classList.remove("active"),R.classList.remove("active")}function l(e){R.contains(e.target)||(N=window.setTimeout(c,300))}function u(e){b=!1,null!==N&&(window.clearTimeout(N),N=null)}function m(e){o(e)}function g(e){b=!0}function p(){if(S){S=!1,L=null,M=null,C=!1,b=!1,c(),I.removeEventListener(I.EVENTS.MESSAGE_TO_TARGET,n),I.removeEventListener(I.EVENTS.UPDATED_PLAYER_STATE,i),I.removeEventListener(I.EVENTS.AUDIO_SUBTITLES_SETTINGS,r),h.removeEventListener(h.knownEvents.SHOW_MENU,d),R.removeEventListener("mouseover",m),R.removeEventListener("mouseout",g);var e=function(e){e.forEach(function(e){E.remove(e)})};e([R,D]),R=null,D=null}}function v(t,s){var a=netflix.cadmium.objects.videoPlayer();(a.getAudioTrackList().length>1||a.getTimedTextTrackList().length>1)&&(S?(p(),v(t,s)):(S=!0,I=t,_=s,x=netflix.mdx.Manager.INSTANCE,f=netflix.I18n,E=netflix.mdx.element,h=netflix.mdx.UiEvents,_.appendChild(e()),I.addEventListener(I.EVENTS.MESSAGE_TO_TARGET,n),I.addEventListener(I.EVENTS.UPDATED_PLAYER_STATE,i),I.addEventListener(I.EVENTS.AUDIO_SUBTITLES_SETTINGS,r),h.addEventListener(h.knownEvents.SHOW_MENU,d),R.addEventListener("mouseover",m),R.addEventListener("mouseout",g)))}var x,f,E,h,_,S=!1,I=null,T="audio.subtitles",R=null,D=null,A=null,y=null,b=!1,N=null,L=null,M=null,C=!1,O=!0,P=!0,w=null;return{init:v,deinit:p}}(),netflix.mdx.ui.targetManager=function(){function e(){return null===D&&(D=b({"class":"player-target-manage icon-player-mdx-playing"},S=y({"class":"menu"},y({"class":"target-menu-header"},N({"class":"icon-player-mdx-playing"}),N({"class":"target-name"},R._config.friendlyName)),_=y({"class":"target-menu-disconnect"},v.get("mdx-disconnect")||"Disconnect")))),D}function t(e){D.contains(e.target)||(C=window.setTimeout(o,300))}function i(e){M=!1,null!==C&&(window.clearTimeout(C),C=null)}function n(e){R.stop(O,g.master.playVideoLocally,g.master.playVideoLocally)}function r(e){M&&null!==I&&(f.isPointInTriangle({x:e.x,y:e.y},I.a,I.b,I.c)||o())}function s(e){document.addEventListener("mousemove",r),M=!1,null!==C&&(window.clearTimeout(C),C=null),S.classList.add("visible"),D.classList.add("active"),window.setTimeout(function(){x.fireEvent(x.knownEvents.SHOW_MENU,[O]),L=f.getDimensions(S);var e=f.getDimensions(D);I={a:{x:e.x+e.w/2,y:e.y+e.h},b:{x:L.x,y:L.y+L.h-5},c:{x:L.x+L.w,y:L.y+L.h-5}},S.classList.add("active"),S.addEventListener("mouseout",t),S.addEventListener("mouseover",i),_.addEventListener("click",n)},1)}function a(e){if(void 0!==e){if(e===O)return;o()}}function o(){document.removeEventListener("mousemove",r),x.fireEvent(x.knownEvents.HIDE_MENU,[O]);var e=function(t){t.target===S&&(S.classList.contains("active")||S.classList.remove("visible"),S.removeEventListener("webkitTransitionEnd",e))};S.removeEventListener("mouseout",t),S.removeEventListener("mouseover",i),_.removeEventListener("click",n),S.addEventListener("webkitTransitionEnd",e),S.classList.remove("active"),D.classList.remove("active")}function d(e){s(e)}function c(e){M=!0}function l(){T&&(T=!1,o(),M=!1,D.removeEventListener("mouseover",d),D.removeEventListener("mouseout",c),x.removeEventListener(x.knownEvents.SHOW_MENU,a),_.removeEventListener("click",n),f.remove(D),D=null)}function u(t,i){T?(l(),u(t,i)):(T=!0,R=t,m=i,p=netflix.mdx.Manager.INSTANCE,v=netflix.I18n,f=netflix.mdx.element,x=netflix.mdx.UiEvents,g=netflix.mdx.ui,E=g.data,h=netflix.mdx.playerutils,m.appendChild(e()),D.addEventListener("mouseover",d),D.addEventListener("mouseout",c),x.addEventListener(x.knownEvents.SHOW_MENU,a))}var m,g,p,v,x,f,E,h,_,S,I,T=!1,R=null,D=null,A=netflix.cadmium.dom,y=A.get("div"),b=A.get("button"),N=A.get("span"),L=null,M=!1,C=null,O="target.manager";return{init:u,deinit:l}}(),netflix.mdx.ui.trickplayPreview=function(){function e(e){var t=D.getFloored(e),i=function(){p.firstChild?p.firstChild.nodeValue=D.convert(t):p.appendChild(document.createTextNode(D.convert(t)))},n=function(){if(null!==A){var e=t/10;v.src=A+y.substring((e+"").length)+(e+"")+".jpg"}};i(),n()}function t(t){var i=function(){e(N.percentagePosition*I),g.style.left=N.absolutePosition-g.offsetWidth/2+"px",S.style.left=N.relativePosition-1+"px"};t?(g.classList.add("animate"),S.classList.add("animate"),window.setTimeout(i,1)):(g.classList.remove("animate"),S.classList.remove("animate"),window.setTimeout(i,1))}function i(e,i){N=e,t(i)}function n(e){e?(window.clearTimeout(L),L=window.setTimeout(c,M)):c()}function r(e){N=f.determinePositions(e,!1),t()}function s(e){window.clearTimeout(L),e.toElement!==h&&e.toElement!==_&&(L=window.setTimeout(c,M))}function a(e){e.fromElement!==h&&(N=f.determinePositions(e,!1),L=window.setTimeout(d,M))}function o(e){S.classList.contains("active")&&(N=f.determinePositions(e,!1),c(),R.seek(D.getFloored(N.percentagePosition*N.current.max)-N.current.value,b))}function d(){window.clearTimeout(L),t(),S.classList.add("active"),g.classList.add("active")}function c(){S.classList.remove("active"),g.classList.remove("active")}function l(){return v=document.createElement("img"),v.classList.add("trickplay-image"),p=document.createElement("time"),g=document.createElement("section"),g.classList.add("trickplay-preview"),null!==A&&g.appendChild(v),g.appendChild(p),g}function u(){T&&(T=!1,_.removeEventListener("mouseover",a),_.removeEventListener("mousemove",r),_.removeEventListener("mouseout",s),_.removeEventListener("click",o),E.remove(S),S=null,E.remove(g),g=null)}function m(e,t){if(T)u(),m(e,t);else{T=!0,R=e,x=t,f=netflix.mdx.ui.scrubber,E=netflix.mdx.element;var i=netflix.mdx.ui.data.getActiveVideo();I=i.runtime,A="undefined"!=typeof i.progressImageRoot?i.progressImageRoot:null,x.appendChild(l()),_=document.querySelector("#mdx-controls-wrapper > .player-slider > div"),h=_.querySelector("button"),S=document.createElement("div"),S.className="trickplay-position",_.appendChild(S),_.addEventListener("mouseover",a),_.addEventListener("mousemove",r),_.addEventListener("mouseout",s),_.addEventListener("click",o)}}var g,p,v,x,f,E,h,_,S,I,T=!1,R=null,D=netflix.mdx.ui.time,A=null,y="00000",b="trickplay.preview",N={relativePosition:null,absolutePosition:null,percentagePosition:null},L=null,M=300;return{init:m,deinit:u,move:i,hide:n}}(),netflix.mdx.ui.volume=function(e){"use strict";function t(){return null===k&&(k=document.createElement("button"),k.classList.add("player-volume"),k.classList.add(te+"3"),H=document.createElement("div"),H.className="menu",q=document.createElement("div"),q.classList.add("progress"),B=document.createElement("div"),q.appendChild(B),H.appendChild(q),F=document.createElement("button"),F.setAttribute("draggable","true"),F.classList.add("scrubber"),H.appendChild(F),k.appendChild(H),L=R.getTransparentImage()),k}function i(){j=R.getDimensions(B),K=R.getDimensions(H),Q=R.getDimensions(F)}function n(e){var t=parseInt(e),i=Math.min(Math.ceil(t/33),3);null===W&&(W=R.getDimensions(q)),B.style.height=t+"%",j=R.getDimensions(B),K=K||R.getDimensions(H),Q=Q||R.getDimensions(F),F.style.top=W.y-K.y+(j.y-W.y)-Q.h/2+"px";for(var n=0;4>n;n++)k.classList.remove(te+n);k.classList.add(te+i)}function r(t){var i=parseInt(t);e.uilog("MDXUI: Subview.volume.modifyTargetVolume",t),O.setVolume({newVolume:i,oldVolume:U},P),U=i}function s(e){var t=parseInt(e);return t!==U}function a(){if(J||Z||$)return void($=!1);var e=O._currentState,t=e.volume;t&&s(t)&&n(t)}function o(e){X&&null!==V&&(R.isPointInTriangle({x:e.x,y:e.y},V.a,V.b,V.c)||l())}function d(e){document.addEventListener("mousemove",o),X=!1,null!==Y&&(window.clearTimeout(Y),Y=null),H.classList.add("visible"),k.classList.add("active"),window.setTimeout(function(){n(U),A.fireEvent(A.knownEvents.SHOW_MENU,[P]),G=R.getDimensions(H);var e=R.getDimensions(k);V={a:{x:e.x+e.w/2,y:e.y+e.h},b:{x:G.x,y:G.y+G.h-5},c:{x:G.x+G.w,y:G.y+G.h-5}},H.classList.add("active"),H.addEventListener("mouseout",u),H.addEventListener("mouseover",m)},1)}function c(e){if(void 0!==e){if(e===P)return;l()}}function l(){document.removeEventListener("mousemove",o),A.fireEvent(A.knownEvents.HIDE_MENU,[P]);var e=function(t){t.target===H&&(H.classList.contains("active")||H.classList.remove("visible"),H.removeEventListener("webkitTransitionEnd",e))};H.removeEventListener("mouseout",u),H.removeEventListener("mouseover",m),H.addEventListener("webkitTransitionEnd",e),H.classList.remove("active"),k.classList.remove("active")}function u(e){k.contains(e.target)||(Y=window.setTimeout(l,300))}function m(e){X=!1,null!==Y&&(window.clearTimeout(Y),Y=null)}function g(e){window.clearTimeout(M),d(e)}function p(e){X=!0}function v(t){t.dataTransfer.setDragImage(L,0,0),e.uilog("MDXUI: Subview.volume.dragstartScrubberHandler",t),z&&(window.clearTimeout(z),z=null),J=!0,Z=!0,W=R.getDimensions(q),A.fireEvent(A.knownEvents.DRAG_START_SCRUBBER)}function x(t){var i,r;J&&t.x&&(e.uilog("MDXUI: Subview.volume.draggingSrubberHandler",t),i=t.y<W.y?1:t.y>W.y+W.h?0:1-(t.y-W.y)/W.h,r=Math.floor(100*i),s(r)&&(n(r),b(r)))}function f(t){t.preventDefault(),e.uilog("MDXUI: Subview.volume.dragendScrubberHandler",t),A.fireEvent(A.knownEvents.DRAG_END_SCRUBBER),J=!1,z=window.setTimeout(function(){Z=!1},4e3)}function E(){var e;U>0?(e=0,ee=U):(e=ee||50,ee=null),s(e)&&(n(e),$=!0,r(e))}function h(e){function t(e){0>e&&(e=0),e>100&&(e=100),s(e)&&(n(e),r(e))}var i=e.keyCode;if(i===ie||i===ne||i===re)switch(e.preventDefault(),H&&H.classList&&!H.classList.contains("visible")&&d(),window.clearTimeout(M),M=window.setTimeout(function(){C&&l()},se),i){case ie:t(U+ae);break;case ne:t(U-ae);break;case re:E()}}function _(){O._capabilities.volumeControl!==w&&I(O,y)}function S(){if(C&&(C=!1,w)){X=!1,l(),O.removeEventListener(O.EVENTS.UPDATED_PLAYER_STATE,a),O.removeEventListener(O.EVENTS.UPDATED_PLAYER_CAPABILITIES,_),F.removeEventListener("dragstart",v),F.removeEventListener("drag",N),F.removeEventListener("dragend",f),k.removeEventListener("click",E),A.removeEventListener(A.knownEvents.SHOW_MENU,c),D.removeEventListener(D.knownEvents.WINDOW_RESIZE,i),k.removeEventListener("mouseover",g),k.removeEventListener("mouseout",p),document.removeEventListener("keyup",h),window.clearTimeout(M);var e=function(e){e.forEach(function(e){R.remove(e)})};e([q,B,F,k,H]),q=null,B=null,F=null,k=null,H=null,J=!1}}function I(e,n){C?(S(),I(e,n)):(C=!0,O=e,y=n,w=O._capabilities.volumeControl,T=netflix.mdx.Manager.INSTANCE,R=netflix.mdx.element,A=netflix.mdx.UiEvents,D=netflix.cadmium.UiEvents,w?(y.appendChild(t()),O.addEventListener(O.EVENTS.UPDATED_PLAYER_STATE,a),b=r.debounce(50,!1),N=x.debounce(15,!1),F.addEventListener("dragstart",v),F.addEventListener("drag",N),F.addEventListener("dragend",f),k.addEventListener("click",E),A.addEventListener(A.knownEvents.SHOW_MENU,c),k.addEventListener("mouseover",g),k.addEventListener("mouseout",p),h=h.debounce(100,!1),document.addEventListener("keyup",h),D.addEventListener(D.knownEvents.WINDOW_RESIZE,i)):O.addEventListener(O.EVENTS.UPDATED_PLAYER_CAPABILITIES,_))}var T,R,D,A,y,b,N,L,M,C=!1,O=null,P="volume",w=!1,U=100,k=null,H=null,G=null,V=null,X=!1,Y=null,q=null,B=null,F=null,W=null,j=null,K=null,Q=null,z=null,J=!1,Z=!0,$=!1,ee=null,te="icon-player-volume-",ie=38,ne=40,re=77,se=2e3,ae=5;return{init:I,deinit:S}}(netflix.cadmium.logging),netflix.mdx.ui.episodeSelector=function(){"use strict";function e(){return null===E&&(E=l.create("div",{"class":["player-control-button","player-episode-selector","icon-player-episode-selector",v].join(" ")})),E}function t(e){var t=e.videoId;p.addEpisodeIDHash(t),c.setMetadata(t,c.getMetadata());var i=function(){netflix.mdx.ui.master.showState(x,"loading",t)};x.stop(_,i,i)}function i(){u.fireEvent(u.knownEvents.SHOW_MENU,[_])}function n(e){_!=e&&h.hide.apply(h)}function r(){var e=m.videoId(),r=c.videoIsKnown(e),s=r&&c.getTotalEpisodeCount(e)>1;s&&!g.getClipValues(e)?(E.classList.remove(v),h=h||new d.ui.EpisodeSelectorMenuComponent(E,E,{id:"player-menu-episode-selector"}),h.addEventListener(h.CHANGE_VIDEO_EVENT,t),E.addEventListener("mouseover",i),u.addEventListener(u.knownEvents.SHOW_MENU,n)):E.classList.add(v)}function s(){f&&(f=!1,null!==h&&(E.removeEventListener("mouseover",i),u.removeEventListener(u.knownEvents.SHOW_MENU,n),h.removeEventListener(h.CHANGE_VIDEO_EVENT,t),h.destroy()),h=null,l.remove(E),E=null)}function a(t,i){d=netflix.cadmium,m=d.objects,f&&s(),f=!0,o=i,c=d.metadata,l=d.element,u=netflix.mdx.UiEvents,g=d.clips,v=l.classNames.hidden,p=d.url,x=t,o.appendChild(e()),r()}var o,d,c,l,u,m,g,p,v,x,f=!1,E=null,h=null,_="episode.selector";return{init:a,deinit:s}}(),netflix.mdx.ui.master=function(){function e(){window.location=R}function t(){N=!1}function i(){N=!0}function n(e){if(null===S){var t;S=document.createElement("div"),S.id="mdx-control-font-wrapper",_=document.createElement("div"),_.id="mdx-control-view",S.appendChild(_),T=document.createElement("a"),T.href=R,T.className="player-back-to-browsing no-select icon-player-back-to-browse",T.innerHTML="<p>"+netflix.I18n.get("mdx-back-to-browse")+"</p>",_.appendChild(T),t=document.getElementById("page-content")||document.body,t.appendChild(S)}var i=e?"url("+e+")":"-webkit-gradient(linear, 0 0, 0 100%, from(#ccc), to(#ccc))";return _.style.cssText="display:block; background-image: -webkit-gradient(linear, 0 0, 0 100%, from(rgba(0,0,0,0)), color-stop(0.36, rgba(0,0,0,0.1)), color-stop(.71, #000), to(#000)), "+i,S}function r(e,t){var i=null;D.retrieveData(e,function(){x=D.getMetadata(),i=D.getLargestImage(x.video.artwork),null===i&&(i=D.getLargestImage(D.getActiveVideo().stills)),n(i),netflix.cadmium.sizing.setMdxControlWrapperEl(_),h=!0,t&&"function"==typeof t&&t()},function(){console.error("Error getting data for MDXUI.")})}function s(){S&&(S.parentNode.removeChild(S),S=null,netflix.cadmium.sizing.clearMdxControlWrapperEl()),null!==b&&(b.removeEventListener(b.EVENTS.NOT_READY,c),b.removeEventListener(b.EVENTS.UPDATED_PLAYER_STATE,o),b.removeEventListener(b.EVENTS.MESSAGE_TO_TARGET,d)),T.removeEventListener("click",l),b=null}function a(e){h||E||(E=!0,I=document.body,y=!1,v=netflix.mdx.Manager.INSTANCE,p=netflix.mdx.playerutils,f=netflix.mdx.ui,g=netflix.mdx.UiEvents,e||(e=p.getVideoId()),e&&(R=p.getBackToBrowsingUrl(),g.addEventListener(g.knownEvents.VIDEO_TO_CONTROLLER,t),g.addEventListener(g.knownEvents.VIDEO_TO_TARGET,i),r(e,null)));
}function o(){var t,i,n=b._currentState,r=n.currentState;y||r!==v.PLAYER_STATE.END_PLAYBACK||(t=n.episodeId||n.catalogId,t=t.split("/"),i=+t[t.length-1],i===D.getActiveVideo().id&&e())}function d(e,t){e===v.MESSAGES.PLAYER_STOP&&(y=!0)}function c(){N&&u()}function l(){var e,t,i,n=netflix.mdx.Manager.INSTANCE.getTargetList(),r=netflix.mdx.playerutils.getEsn();if(f.loading.deinit(),n)for(e in n)n.hasOwnProperty(e)&&(e=n[e],t=e._currentState,i=t.esn||r,t&&"undefined"!=typeof t.currentState&&i===r&&(e.stop(),mdx.discovery.stopNetflix(e._config.dialUsn)));s()}function u(){I.classList.remove("mdx-active"),window.setTimeout(function(){g.fireEvent(g.knownEvents.VIDEO_TO_CONTROLLER),I.classList.remove("mdx-enabled"),f.loading.deinit(),p.resumeLocalPlayback()},500)}function m(e,t,i){function n(){if(e!==b){var i=document.querySelector("#mdx-control-view .player-back-to-browsing");null!==b&&(b.removeEventListener(b.EVENTS.NOT_READY,c),b.removeEventListener(b.EVENTS.UPDATED_PLAYER_STATE,o),b.removeEventListener(b.EVENTS.MESSAGE_TO_TARGET,d),i.removeEventListener("click",l)),e.addEventListener(e.EVENTS.NOT_READY,c),e.addEventListener(e.EVENTS.UPDATED_PLAYER_STATE,o),e.addEventListener(e.EVENTS.MESSAGE_TO_TARGET,d),i.addEventListener("click",l)}f[t].init(e,_),g.fireEvent(g.knownEvents.VIDEO_TO_TARGET),p.stopPlayer(),b=e}A.uilog("MDXUI: View.master.showState",h,e._config.ip,t),i?r(i,n):h&&n(),netflix.cadmium.addBeforeUnloadHandler(l,!0)}var g,p,v,x,f,E=!1,h=!1,_=null,S=null,I=null,T=null,R=null,D=netflix.mdx.ui.data,A=netflix.cadmium.logging,y=!1,b=null,N=!1;return{init:a,hide:s,showState:m,goBackToBrowsing:e,stopMdx:l,playVideoLocally:u}}();